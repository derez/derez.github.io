<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bits on 0x42697473 - code examples1</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feed/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Full Atom Feed"/>
    <link href="https://derez.github.io/feed/index.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Atom Feed"/>
    <link href="https://derez.github.io/category/code/feed/index.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?3b9cbf50">




    <meta name="tags" contents="code examples"/>
    <meta name="tags" contents="hightlighting"/>
    <meta name="tags" contents="python"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny "derez" Walker</span></a>
              <a href="#!email"><span class="email">derez@packetforge.net</span></a>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-cog fa-lg"></i>Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-user-circle fa-lg"></i>About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-4 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bits on 0x42697473</a></li>
            <ul class="right hide-on-med-and-down">
              <li><a class="waves-effect waves-orange btn-flat vertical-align-middle" href="https://derez.github.io/projects.html">
                Projects</a>
              </li>
              <li><a class="dropdown-button waves-effect waves-orange btn-flat vertical-align-middle" data-beloworigin="true" data-constrainwidth="false" href="#" data-activates="blog-dropdown">Blog</a></li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-4 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/2017/shellcode-encoder.html" class="breadcrumb">code examples1</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/2017/shellcode-encoder.html" rel="bookmark" class="article-name card-title" 
      title="Permalink code examples1">code&nbsp;examples1</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2017-01-03T11:22:00-05:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Published: 
        <time datetime="2017-01-03" itemprop="dateCreated"> 03 Jan 2017</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <div class="highlight"><pre><span></span><span id="row-20"><span class="lineno"> 20 </span><span class="c1"># This file is part of PeachPy package and is licensed under the Simplified BSD license.</span>
</span><span id="row-21"><span class="lineno"> 21 </span><span class="c1">#    See license.rst for the full text of the license.</span>
</span><span id="row-22"><span class="lineno"> 22 </span>
</span><span id="row-23"><span class="lineno"> 23 </span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</span><span id="row-24"><span class="lineno"> 24 </span><span class="kn">from</span> <span class="nn">opcodes.x86_64</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="row-25"><span class="lineno"> 25 </span><span class="kn">from</span> <span class="nn">codegen.code</span> <span class="kn">import</span> <span class="n">CodeWriter</span><span class="p">,</span> <span class="n">CodeBlock</span>
</span><span id="row-26"><span class="lineno"> 26 </span><span class="kn">import</span> <span class="nn">os</span>
</span><span id="row-27"><span class="lineno"> 27 </span><span class="kn">import</span> <span class="nn">json</span>
</span><span id="row-28"><span class="lineno"> 28 </span><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span id="row-29"><span class="lineno"> 29 </span><span class="kn">import</span> <span class="nn">tempfile</span>
</span><span id="row-30"><span class="lineno"> 30 </span>
</span><span id="row-31"><span class="lineno"> 31 </span>
</span><span id="row-32"><span class="lineno"> 32 </span><span class="n">instruction_set</span> <span class="o">=</span> <span class="n">read_instruction_set</span><span class="p">()</span>
</span><span id="row-33"><span class="lineno"> 33 </span>
</span><span id="row-34"><span class="lineno"> 34 </span><span class="n">instruction_groups</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;x86_64.json&quot;</span><span class="p">)))</span>
</span><span id="row-35"><span class="lineno"> 35 </span>
</span><span id="row-36"><span class="lineno"> 36 </span>
</span><span id="row-37"><span class="lineno"> 37 </span><span class="k">def</span> <span class="nf">filter_instruction_forms</span><span class="p">(</span><span class="n">instruction_forms</span><span class="p">):</span>
</span><span id="row-38"><span class="lineno"> 38 </span>    <span class="sd">&quot;&quot;&quot;Removes the instruction forms that are currently not supported&quot;&quot;&quot;</span>
</span><span id="row-39"><span class="lineno"> 39 </span>
</span><span id="row-40"><span class="lineno"> 40 </span>    <span class="n">new_instruction_forms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="row-41"><span class="lineno"> 41 </span>    <span class="k">for</span> <span class="n">instruction_form</span> <span class="ow">in</span> <span class="n">instruction_forms</span><span class="p">:</span>
</span><span id="row-42"><span class="lineno"> 42 </span>        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">operand</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;r8l&quot;</span><span class="p">,</span> <span class="s2">&quot;r16l&quot;</span><span class="p">,</span> <span class="s2">&quot;r32l&quot;</span><span class="p">,</span> <span class="s2">&quot;moffs32&quot;</span><span class="p">,</span> <span class="s2">&quot;moffs64&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instruction_form</span><span class="o">.</span><span class="n">operands</span><span class="p">]):</span>
</span><span id="row-43"><span class="lineno"> 43 </span>            <span class="n">new_instruction_forms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instruction_form</span><span class="p">)</span>
</span><span id="row-44"><span class="lineno"> 44 </span>    <span class="k">return</span> <span class="n">new_instruction_forms</span>
</span><span id="row-45"><span class="lineno"> 45 </span>
</span><span id="row-46"><span class="lineno"> 46 </span>
</span><span id="row-47"><span class="lineno"> 47 </span><span class="k">def</span> <span class="nf">is_avx512_instruction_form</span><span class="p">(</span><span class="n">instruction_form</span><span class="p">):</span>
</span><span id="row-48"><span class="lineno"> 48 </span>    <span class="k">return</span> <span class="n">instruction_form</span><span class="o">.</span><span class="n">isa_extensions</span> <span class="ow">and</span> <span class="n">instruction_form</span><span class="o">.</span><span class="n">isa_extensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AVX512&quot;</span><span class="p">)</span>
</span><span id="row-49"><span class="lineno"> 49 </span>
</span><span id="row-50"><span class="lineno"> 50 </span>
</span><span id="row-51"><span class="lineno"> 51 </span><span class="k">def</span> <span class="nf">objcopy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="row-52"><span class="lineno"> 52 </span>    <span class="n">objdump_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJCOPY_FOR_X86&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJCOPY&quot;</span><span class="p">))</span>
</span><span id="row-53"><span class="lineno"> 53 </span>    <span class="k">assert</span> <span class="n">objdump_path</span><span class="p">,</span> <span class="s2">&quot;objcopy not found, please set the environment variable OBJCOPY_FOR_X86&quot;</span>
</span><span id="row-54"><span class="lineno"> 54 </span>    <span class="n">objdump_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">objdump_path</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
</span><span id="row-55"><span class="lineno"> 55 </span>                                       <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span id="row-56"><span class="lineno"> 56 </span>                                       <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="row-57"><span class="lineno"> 57 </span>    <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="n">objdump_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="row-58"><span class="lineno"> 58 </span>    <span class="k">if</span> <span class="n">objdump_process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="row-59"><span class="lineno"> 59 </span>        <span class="k">print</span><span class="p">(</span><span class="n">stdoutdata</span><span class="p">)</span>
</span><span id="row-60"><span class="lineno"> 60 </span>        <span class="k">print</span><span class="p">(</span><span class="n">stderrdata</span><span class="p">)</span>
</span><span id="row-61"><span class="lineno"> 61 </span>
</span><span id="row-62"><span class="lineno"> 62 </span>
</span><span id="row-63"><span class="lineno"> 63 </span><span class="k">def</span> <span class="nf">gas</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="row-64"><span class="lineno"> 64 </span>    <span class="n">gas_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AS_FOR_X86&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GAS&quot;</span><span class="p">))</span>
</span><span id="row-65"><span class="lineno"> 65 </span>    <span class="k">assert</span> <span class="n">gas_path</span><span class="p">,</span> <span class="s2">&quot;GNU assembler not found, please set the environment variable AS_FOR_X86&quot;</span>
</span><span id="row-66"><span class="lineno"> 66 </span>    <span class="n">gas_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">gas_path</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
</span><span id="row-67"><span class="lineno"> 67 </span>                                   <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span id="row-68"><span class="lineno"> 68 </span>                                   <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="row-69"><span class="lineno"> 69 </span>    <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="n">gas_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="row-70"><span class="lineno"> 70 </span>    <span class="k">if</span> <span class="n">gas_process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="row-71"><span class="lineno"> 71 </span>        <span class="k">print</span><span class="p">(</span><span class="n">stdoutdata</span><span class="p">)</span>
</span><span id="row-72"><span class="lineno"> 72 </span>        <span class="k">print</span><span class="p">(</span><span class="n">stderrdata</span><span class="p">)</span>
</span><span id="row-73"><span class="lineno"> 73 </span>    <span class="k">return</span> <span class="n">stdoutdata</span><span class="o">.</span><span class="n">decode</span> <span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</span><span id="row-74"><span class="lineno"> 74 </span>
</span><span id="row-75"><span class="lineno"> 75 </span>
</span><span id="row-76"><span class="lineno"> 76 </span><span class="k">def</span> <span class="nf">binutils_encode</span><span class="p">(</span><span class="n">assembly</span><span class="p">):</span>
</span><span id="row-77"><span class="lineno"> 77 </span>    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">asm_file</span><span class="p">:</span>
</span><span id="row-78"><span class="lineno"> 78 </span>        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;.text&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">asm_file</span><span class="p">)</span>
</span><span id="row-79"><span class="lineno"> 79 </span>        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;.intel_syntax noprefix&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">asm_file</span><span class="p">)</span>
</span><span id="row-80"><span class="lineno"> 80 </span>        <span class="k">print</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">asm_file</span><span class="p">)</span>
</span><span id="row-81"><span class="lineno"> 81 </span>    <span class="n">obj_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span id="row-82"><span class="lineno"> 82 </span>    <span class="n">obj_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="row-83"><span class="lineno"> 83 </span>    <span class="n">bin_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span id="row-84"><span class="lineno"> 84 </span>    <span class="n">bin_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="row-85"><span class="lineno"> 85 </span>    <span class="k">try</span><span class="p">:</span>
</span><span id="row-86"><span class="lineno"> 86 </span>        <span class="n">gas</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">obj_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">asm_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-87"><span class="lineno"> 87 </span>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">asm_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-88"><span class="lineno"> 88 </span>        <span class="n">objcopy</span><span class="p">(</span><span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="s2">&quot;.text&quot;</span><span class="p">,</span> <span class="n">obj_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bin_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-89"><span class="lineno"> 89 </span>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-90"><span class="lineno"> 90 </span>    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="row-91"><span class="lineno"> 91 </span>        <span class="k">print</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>
</span><span id="row-92"><span class="lineno"> 92 </span>        <span class="k">raise</span>
</span><span id="row-93"><span class="lineno"> 93 </span>    <span class="n">bytecode</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">bin_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="row-94"><span class="lineno"> 94 </span>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bin_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-95"><span class="lineno"> 95 </span>    <span class="k">return</span> <span class="s2">&quot;bytearray([</span><span class="si">%s</span><span class="s2">])&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;0x</span><span class="si">%02X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bytecode</span><span class="p">])</span>
</span><span id="row-96"><span class="lineno"> 96 </span>
</span><span id="row-97"><span class="lineno"> 97 </span>
</span><span id="row-98"><span class="lineno"> 98 </span><span class="k">def</span> <span class="nf">generate_operand</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">operand_number</span><span class="p">,</span> <span class="n">peachpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">evex</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-99"><span class="lineno"> 99 </span>    <span class="n">value_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="row-100"><span class="lineno">100 </span>        <span class="s2">&quot;r8&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bl&quot;</span><span class="p">,</span> <span class="s2">&quot;r9b&quot;</span><span class="p">,</span> <span class="s2">&quot;dl&quot;</span><span class="p">,</span> <span class="s2">&quot;r11b&quot;</span><span class="p">],</span>
</span><span id="row-101"><span class="lineno">101 </span>        <span class="s2">&quot;r16&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">,</span> <span class="s2">&quot;r12w&quot;</span><span class="p">,</span> <span class="s2">&quot;di&quot;</span><span class="p">,</span> <span class="s2">&quot;r14w&quot;</span><span class="p">],</span>
</span><span id="row-102"><span class="lineno">102 </span>        <span class="s2">&quot;r32&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ebp&quot;</span><span class="p">,</span> <span class="s2">&quot;r8d&quot;</span><span class="p">,</span> <span class="s2">&quot;eax&quot;</span><span class="p">,</span> <span class="s2">&quot;r10d&quot;</span><span class="p">],</span>
</span><span id="row-103"><span class="lineno">103 </span>        <span class="s2">&quot;r64&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;rcx&quot;</span><span class="p">,</span> <span class="s2">&quot;r15&quot;</span><span class="p">,</span> <span class="s2">&quot;rax&quot;</span><span class="p">,</span> <span class="s2">&quot;r13&quot;</span><span class="p">],</span>
</span><span id="row-104"><span class="lineno">104 </span>        <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mm3&quot;</span><span class="p">,</span> <span class="s2">&quot;mm5&quot;</span><span class="p">],</span>
</span><span id="row-105"><span class="lineno">105 </span>        <span class="s2">&quot;xmm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;xmm1&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm14&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm3&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm9&quot;</span><span class="p">],</span>
</span><span id="row-106"><span class="lineno">106 </span>        <span class="s2">&quot;xmm{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;xmm5{k1}&quot;</span><span class="p">,</span>
</span><span id="row-107"><span class="lineno">107 </span>        <span class="s2">&quot;xmm{k}{z}&quot;</span><span class="p">:</span> <span class="s2">&quot;xmm30{k2}{z}&quot;</span><span class="p">,</span>
</span><span id="row-108"><span class="lineno">108 </span>        <span class="s2">&quot;ymm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ymm2&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm15&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm4&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm10&quot;</span><span class="p">],</span>
</span><span id="row-109"><span class="lineno">109 </span>        <span class="s2">&quot;ymm{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;ymm24{k3}&quot;</span><span class="p">,</span>
</span><span id="row-110"><span class="lineno">110 </span>        <span class="s2">&quot;ymm{k}{z}&quot;</span><span class="p">:</span> <span class="s2">&quot;ymm19{k5}{z}&quot;</span><span class="p">,</span>
</span><span id="row-111"><span class="lineno">111 </span>        <span class="s2">&quot;zmm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;zmm3&quot;</span><span class="p">,</span> <span class="s2">&quot;zmm26&quot;</span><span class="p">,</span> <span class="s2">&quot;zmm9&quot;</span><span class="p">,</span> <span class="s2">&quot;zmm17&quot;</span><span class="p">],</span>
</span><span id="row-112"><span class="lineno">112 </span>        <span class="s2">&quot;zmm{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;zmm26{k7}&quot;</span><span class="p">,</span>
</span><span id="row-113"><span class="lineno">113 </span>        <span class="s2">&quot;zmm{k}{z}&quot;</span><span class="p">:</span> <span class="s2">&quot;zmm9{k6}{z}&quot;</span><span class="p">,</span>
</span><span id="row-114"><span class="lineno">114 </span>        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="s2">&quot;k5&quot;</span><span class="p">,</span>
</span><span id="row-115"><span class="lineno">115 </span>        <span class="s2">&quot;k{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;k4{k6}&quot;</span><span class="p">,</span>
</span><span id="row-116"><span class="lineno">116 </span>        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + rsi*8 - 128]&quot;</span><span class="p">,</span>
</span><span id="row-117"><span class="lineno">117 </span>        <span class="s2">&quot;m8&quot;</span><span class="p">:</span> <span class="s2">&quot;byte[r14 + rdi*4 - 123]&quot;</span><span class="p">,</span>
</span><span id="row-118"><span class="lineno">118 </span>        <span class="s2">&quot;m16&quot;</span><span class="p">:</span> <span class="s2">&quot;word[r13 + rbp*8 - 107]&quot;</span><span class="p">,</span>
</span><span id="row-119"><span class="lineno">119 </span>        <span class="s2">&quot;m32&quot;</span><span class="p">:</span> <span class="s2">&quot;dword[r12 + rcx*8 - 99]&quot;</span><span class="p">,</span>
</span><span id="row-120"><span class="lineno">120 </span>        <span class="s2">&quot;m64&quot;</span><span class="p">:</span> <span class="s2">&quot;qword[r11 + rdx*8 - 88]&quot;</span><span class="p">,</span>
</span><span id="row-121"><span class="lineno">121 </span>        <span class="s2">&quot;m64/m32bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;qword[r11 + rdx*8 - 88]&quot;</span><span class="p">,</span>
</span><span id="row-122"><span class="lineno">122 </span>        <span class="s2">&quot;m128&quot;</span><span class="p">:</span> <span class="s2">&quot;oword[r10 + rax*8 - 77]&quot;</span><span class="p">,</span>
</span><span id="row-123"><span class="lineno">123 </span>        <span class="s2">&quot;m128/m32bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;oword[r10 + rax*8 - 77]&quot;</span><span class="p">,</span>
</span><span id="row-124"><span class="lineno">124 </span>        <span class="s2">&quot;m128/m64bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;oword[r10 + rax*8 - 77]&quot;</span><span class="p">,</span>
</span><span id="row-125"><span class="lineno">125 </span>        <span class="s2">&quot;m256&quot;</span><span class="p">:</span> <span class="s2">&quot;hword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-126"><span class="lineno">126 </span>        <span class="s2">&quot;m256/m32bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;hword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-127"><span class="lineno">127 </span>        <span class="s2">&quot;m256/m64bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;hword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-128"><span class="lineno">128 </span>        <span class="s2">&quot;m512&quot;</span><span class="p">:</span> <span class="s2">&quot;zword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-129"><span class="lineno">129 </span>        <span class="s2">&quot;m512/m32bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;zword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-130"><span class="lineno">130 </span>        <span class="s2">&quot;m512/m64bcst&quot;</span><span class="p">:</span> <span class="s2">&quot;zword[r9 + rbx*8 - 66]&quot;</span><span class="p">,</span>
</span><span id="row-131"><span class="lineno">131 </span>        <span class="s2">&quot;m8{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;byte[r14 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;byte[r14 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;byte[r14 - 128]{k1}{z}&quot;</span><span class="p">],</span>
</span><span id="row-132"><span class="lineno">132 </span>        <span class="s2">&quot;m16{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;word[r13 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;word[r13 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;word[r13 - 128]{k2}{z}&quot;</span><span class="p">],</span>
</span><span id="row-133"><span class="lineno">133 </span>        <span class="s2">&quot;m32{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dword[r12 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 - 128]{k3}{z}&quot;</span><span class="p">],</span>
</span><span id="row-134"><span class="lineno">134 </span>        <span class="s2">&quot;m64{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;qword[r11 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 - 128]{k4}{z}&quot;</span><span class="p">],</span>
</span><span id="row-135"><span class="lineno">135 </span>        <span class="s2">&quot;m128{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;oword[r10 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;oword[r10 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;oword[r10 - 128]{k5}{z}&quot;</span><span class="p">],</span>
</span><span id="row-136"><span class="lineno">136 </span>        <span class="s2">&quot;m256{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hword[r9 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;hword[r9 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;hword[r9 - 128]{k6}{z}&quot;</span><span class="p">],</span>
</span><span id="row-137"><span class="lineno">137 </span>        <span class="s2">&quot;m512{k}{z}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;zword[r8 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;zword[r8 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;zword[r8 - 128]{k7}{z}&quot;</span><span class="p">],</span>
</span><span id="row-138"><span class="lineno">138 </span>        <span class="s2">&quot;m32{k}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dword[r12 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 - 128]{k5}&quot;</span><span class="p">],</span>
</span><span id="row-139"><span class="lineno">139 </span>        <span class="s2">&quot;m64{k}&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;qword[r11 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 - 128]{k6}&quot;</span><span class="p">],</span>
</span><span id="row-140"><span class="lineno">140 </span>        <span class="s2">&quot;vm32x&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm0 * 4 - 128]&quot;</span><span class="p">,</span>
</span><span id="row-141"><span class="lineno">141 </span>        <span class="s2">&quot;vm32y&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm8 * 4 + 48]&quot;</span><span class="p">,</span>
</span><span id="row-142"><span class="lineno">142 </span>        <span class="s2">&quot;vm32z&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm19 * 4 - 16]&quot;</span><span class="p">,</span>
</span><span id="row-143"><span class="lineno">143 </span>        <span class="s2">&quot;vm64x&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm1 * 8 + 40]&quot;</span><span class="p">,</span>
</span><span id="row-144"><span class="lineno">144 </span>        <span class="s2">&quot;vm64y&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm9 * 8 - 56]&quot;</span><span class="p">,</span>
</span><span id="row-145"><span class="lineno">145 </span>        <span class="s2">&quot;vm64z&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm20 * 8 + 72]&quot;</span><span class="p">,</span>
</span><span id="row-146"><span class="lineno">146 </span>        <span class="s2">&quot;vm32x{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm0 * 4 - 128]{k1}&quot;</span><span class="p">,</span>
</span><span id="row-147"><span class="lineno">147 </span>        <span class="s2">&quot;vm32y{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm8 * 4 + 48]{k2}&quot;</span><span class="p">,</span>
</span><span id="row-148"><span class="lineno">148 </span>        <span class="s2">&quot;vm32z{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm19 * 4 - 16]{k3}&quot;</span><span class="p">,</span>
</span><span id="row-149"><span class="lineno">149 </span>        <span class="s2">&quot;vm64x{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm1 * 8 + 40]{k4}&quot;</span><span class="p">,</span>
</span><span id="row-150"><span class="lineno">150 </span>        <span class="s2">&quot;vm64y{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm9 * 8 - 56]{k5}&quot;</span><span class="p">,</span>
</span><span id="row-151"><span class="lineno">151 </span>        <span class="s2">&quot;vm64z{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm20 * 8 + 72]{k6}&quot;</span><span class="p">,</span>
</span><span id="row-152"><span class="lineno">152 </span>        <span class="s2">&quot;imm4&quot;</span><span class="p">:</span> <span class="s2">&quot;0b11&quot;</span><span class="p">,</span>
</span><span id="row-153"><span class="lineno">153 </span>        <span class="s2">&quot;imm8&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
</span><span id="row-154"><span class="lineno">154 </span>        <span class="s2">&quot;imm16&quot;</span><span class="p">:</span> <span class="s2">&quot;32000&quot;</span><span class="p">,</span>
</span><span id="row-155"><span class="lineno">155 </span>        <span class="s2">&quot;imm32&quot;</span><span class="p">:</span> <span class="s2">&quot;0x10000000&quot;</span><span class="p">,</span>
</span><span id="row-156"><span class="lineno">156 </span>        <span class="s2">&quot;imm64&quot;</span><span class="p">:</span> <span class="s2">&quot;0x100000000&quot;</span><span class="p">,</span>
</span><span id="row-157"><span class="lineno">157 </span>        <span class="c1"># &quot;rel32&quot;: &quot;rip+0x11223344&quot;,</span>
</span><span id="row-158"><span class="lineno">158 </span>        <span class="c1"># &quot;rel8&quot;: &quot;rip-100&quot;,</span>
</span><span id="row-159"><span class="lineno">159 </span>        <span class="s2">&quot;al&quot;</span><span class="p">:</span> <span class="s2">&quot;al&quot;</span><span class="p">,</span>
</span><span id="row-160"><span class="lineno">160 </span>        <span class="s2">&quot;cl&quot;</span><span class="p">:</span> <span class="s2">&quot;cl&quot;</span><span class="p">,</span>
</span><span id="row-161"><span class="lineno">161 </span>        <span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="s2">&quot;ax&quot;</span><span class="p">,</span>
</span><span id="row-162"><span class="lineno">162 </span>        <span class="s2">&quot;eax&quot;</span><span class="p">:</span> <span class="s2">&quot;eax&quot;</span><span class="p">,</span>
</span><span id="row-163"><span class="lineno">163 </span>        <span class="s2">&quot;rax&quot;</span><span class="p">:</span> <span class="s2">&quot;rax&quot;</span><span class="p">,</span>
</span><span id="row-164"><span class="lineno">164 </span>        <span class="s2">&quot;xmm0&quot;</span><span class="p">:</span> <span class="s2">&quot;xmm0&quot;</span><span class="p">,</span>
</span><span id="row-165"><span class="lineno">165 </span>        <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="row-166"><span class="lineno">166 </span>        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
</span><span id="row-167"><span class="lineno">167 </span>        <span class="s2">&quot;{sae}&quot;</span><span class="p">:</span> <span class="s2">&quot;{sae}&quot;</span><span class="p">,</span>
</span><span id="row-168"><span class="lineno">168 </span>        <span class="s2">&quot;{er}&quot;</span><span class="p">:</span> <span class="s2">&quot;{rn-sae}&quot;</span><span class="p">,</span>
</span><span id="row-169"><span class="lineno">169 </span>    <span class="p">}</span>
</span><span id="row-170"><span class="lineno">170 </span>    <span class="n">evex_value_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="row-171"><span class="lineno">171 </span>        <span class="s2">&quot;xmm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;xmm16&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm4&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm19&quot;</span><span class="p">,</span> <span class="s2">&quot;xmm31&quot;</span><span class="p">],</span>
</span><span id="row-172"><span class="lineno">172 </span>        <span class="s2">&quot;ymm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ymm17&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm5&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm20&quot;</span><span class="p">,</span> <span class="s2">&quot;ymm30&quot;</span><span class="p">],</span>
</span><span id="row-173"><span class="lineno">173 </span>        <span class="s2">&quot;m8&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;byte[r14 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;byte[r14 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;byte[r14 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-174"><span class="lineno">174 </span>        <span class="s2">&quot;m16&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;word[r13 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;word[r13 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;word[r13 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-175"><span class="lineno">175 </span>        <span class="s2">&quot;m32&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dword[r12 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;dword[r12 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-176"><span class="lineno">176 </span>        <span class="s2">&quot;m64&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;qword[r11 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;qword[r11 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-177"><span class="lineno">177 </span>        <span class="s2">&quot;m128&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;oword[r10 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;oword[r10 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;oword[r10 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-178"><span class="lineno">178 </span>        <span class="s2">&quot;m256&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hword[r9 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;hword[r9 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;hword[r9 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-179"><span class="lineno">179 </span>        <span class="s2">&quot;m512&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;zword[r8 - 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;zword[r8 + 64]&quot;</span><span class="p">,</span> <span class="s2">&quot;zword[r8 - 128]&quot;</span><span class="p">],</span>
</span><span id="row-180"><span class="lineno">180 </span>    <span class="p">}</span>
</span><span id="row-181"><span class="lineno">181 </span>    <span class="n">peachpy_value_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="row-182"><span class="lineno">182 </span>        <span class="s2">&quot;vm32x{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm0(k1) * 4 - 128]&quot;</span><span class="p">,</span>
</span><span id="row-183"><span class="lineno">183 </span>        <span class="s2">&quot;vm32y{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm8(k2) * 4 + 48]&quot;</span><span class="p">,</span>
</span><span id="row-184"><span class="lineno">184 </span>        <span class="s2">&quot;vm32z{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm19(k3) * 4 - 16]&quot;</span><span class="p">,</span>
</span><span id="row-185"><span class="lineno">185 </span>        <span class="s2">&quot;vm64x{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[rsi + xmm1(k4) * 8 + 40]&quot;</span><span class="p">,</span>
</span><span id="row-186"><span class="lineno">186 </span>        <span class="s2">&quot;vm64y{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r11 + ymm9(k5) * 8 - 56]&quot;</span><span class="p">,</span>
</span><span id="row-187"><span class="lineno">187 </span>        <span class="s2">&quot;vm64z{k}&quot;</span><span class="p">:</span> <span class="s2">&quot;[r15 + zmm20(k6) * 8 + 72]&quot;</span><span class="p">,</span>
</span><span id="row-188"><span class="lineno">188 </span>    <span class="p">}</span>
</span><span id="row-189"><span class="lineno">189 </span>    <span class="n">optype</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span>
</span><span id="row-190"><span class="lineno">190 </span>    <span class="n">operand</span> <span class="o">=</span> <span class="n">value_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">optype</span><span class="p">)</span>
</span><span id="row-191"><span class="lineno">191 </span>    <span class="k">if</span> <span class="n">evex</span><span class="p">:</span>
</span><span id="row-192"><span class="lineno">192 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">evex_value_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">optype</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
</span><span id="row-193"><span class="lineno">193 </span>    <span class="k">if</span> <span class="n">peachpy</span><span class="p">:</span>
</span><span id="row-194"><span class="lineno">194 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">peachpy_value_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">optype</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
</span><span id="row-195"><span class="lineno">195 </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="row-196"><span class="lineno">196 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="p">[</span><span class="n">operand_number</span><span class="p">]</span>
</span><span id="row-197"><span class="lineno">197 </span>    <span class="k">if</span> <span class="n">operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">peachpy</span><span class="p">:</span>
</span><span id="row-198"><span class="lineno">198 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span>\
</span><span id="row-199"><span class="lineno">199 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;byte&quot;</span><span class="p">,</span> <span class="s2">&quot;BYTE PTR &quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-200"><span class="lineno">200 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;dword&quot;</span><span class="p">,</span> <span class="s2">&quot;DWORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-201"><span class="lineno">201 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;qword&quot;</span><span class="p">,</span> <span class="s2">&quot;QWORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-202"><span class="lineno">202 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;oword&quot;</span><span class="p">,</span> <span class="s2">&quot;XMMWORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-203"><span class="lineno">203 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;hword&quot;</span><span class="p">,</span> <span class="s2">&quot;YMMWORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-204"><span class="lineno">204 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;zword&quot;</span><span class="p">,</span> <span class="s2">&quot;ZMMWORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-205"><span class="lineno">205 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;WORD PTR&quot;</span><span class="p">)</span><span class="o">.</span>\
</span><span id="row-206"><span class="lineno">206 </span>            <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rip&quot;</span><span class="p">,</span> <span class="s2">&quot;$+2&quot;</span><span class="p">)</span>
</span><span id="row-207"><span class="lineno">207 </span>    <span class="k">if</span> <span class="n">operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">peachpy</span><span class="p">:</span>
</span><span id="row-208"><span class="lineno">208 </span>        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="row-209"><span class="lineno">209 </span>            <span class="n">kreg</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kn</span><span class="p">)</span>
</span><span id="row-210"><span class="lineno">210 </span>            <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">kreg</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">kreg</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
</span><span id="row-211"><span class="lineno">211 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;){z}&quot;</span><span class="p">,</span> <span class="s2">&quot;.z)&quot;</span><span class="p">)</span>
</span><span id="row-212"><span class="lineno">212 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{rn-sae}&quot;</span><span class="p">,</span> <span class="s2">&quot;{rn_sae}&quot;</span><span class="p">)</span>
</span><span id="row-213"><span class="lineno">213 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{rz-sae}&quot;</span><span class="p">,</span> <span class="s2">&quot;{rz_sae}&quot;</span><span class="p">)</span>
</span><span id="row-214"><span class="lineno">214 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{ru-sae}&quot;</span><span class="p">,</span> <span class="s2">&quot;{ru_sae}&quot;</span><span class="p">)</span>
</span><span id="row-215"><span class="lineno">215 </span>        <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{rd-sae}&quot;</span><span class="p">,</span> <span class="s2">&quot;{rd_sae}&quot;</span><span class="p">)</span>
</span><span id="row-216"><span class="lineno">216 </span>    <span class="k">return</span> <span class="n">operand</span>
</span><span id="row-217"><span class="lineno">217 </span>
</span><span id="row-218"><span class="lineno">218 </span>
</span><span id="row-219"><span class="lineno">219 </span><span class="n">tab</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">4</span>
</span><span id="row-220"><span class="lineno">220 </span>
</span><span id="row-221"><span class="lineno">221 </span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">package_root</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
</span><span id="row-222"><span class="lineno">222 </span>    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">instruction_names</span> <span class="ow">in</span> <span class="n">instruction_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="row-223"><span class="lineno">223 </span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="n">package_root</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;x86_64&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;test_</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="n">group</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
</span><span id="row-224"><span class="lineno">224 </span>            <span class="k">with</span> <span class="n">CodeWriter</span><span class="p">()</span> <span class="k">as</span> <span class="n">code</span><span class="p">:</span>
</span><span id="row-225"><span class="lineno">225 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;# This file is auto-generated by /codegen/x86_64_test_encoding.py&quot;</span><span class="p">)</span>
</span><span id="row-226"><span class="lineno">226 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;# Reference opcodes are generated by:&quot;</span><span class="p">)</span>
</span><span id="row-227"><span class="lineno">227 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;#     &quot;</span> <span class="o">+</span> <span class="n">gas</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="row-228"><span class="lineno">228 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
</span><span id="row-229"><span class="lineno">229 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;from peachpy.x86_64 import *&quot;</span><span class="p">)</span>
</span><span id="row-230"><span class="lineno">230 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;import unittest&quot;</span><span class="p">)</span>
</span><span id="row-231"><span class="lineno">231 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
</span><span id="row-232"><span class="lineno">232 </span>                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
</span><span id="row-233"><span class="lineno">233 </span>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">instruction_names</span><span class="p">:</span>
</span><span id="row-234"><span class="lineno">234 </span>                    <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;class Test</span><span class="si">%s</span><span class="s2">(unittest.TestCase):&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</span><span id="row-235"><span class="lineno">235 </span>                    <span class="k">with</span> <span class="n">CodeBlock</span><span class="p">():</span>
</span><span id="row-236"><span class="lineno">236 </span>                        <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;def runTest(self):&quot;</span><span class="p">)</span>
</span><span id="row-237"><span class="lineno">237 </span>                        <span class="k">with</span> <span class="n">CodeBlock</span><span class="p">():</span>
</span><span id="row-238"><span class="lineno">238 </span>                            <span class="c1"># Instructions with `name` name</span>
</span><span id="row-239"><span class="lineno">239 </span>                            <span class="n">name_instructions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">,</span> <span class="n">instruction_set</span><span class="p">))</span>
</span><span id="row-240"><span class="lineno">240 </span>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">name_instructions</span><span class="p">:</span>
</span><span id="row-241"><span class="lineno">241 </span>                                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No forms for instruction: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</span><span id="row-242"><span class="lineno">242 </span>                                <span class="k">continue</span>
</span><span id="row-243"><span class="lineno">243 </span>                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_instructions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="row-244"><span class="lineno">244 </span>                            <span class="n">name_instruction</span> <span class="o">=</span> <span class="n">name_instructions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="row-245"><span class="lineno">245 </span>
</span><span id="row-246"><span class="lineno">246 </span>                            <span class="n">has_assertions</span> <span class="o">=</span> <span class="bp">False</span>
</span><span id="row-247"><span class="lineno">247 </span>                            <span class="k">for</span> <span class="n">instruction_form</span> <span class="ow">in</span> <span class="n">filter_instruction_forms</span><span class="p">(</span><span class="n">name_instruction</span><span class="o">.</span><span class="n">forms</span><span class="p">):</span>
</span><span id="row-248"><span class="lineno">248 </span>                                <span class="n">is_avx512</span> <span class="o">=</span> <span class="n">is_avx512_instruction_form</span><span class="p">(</span><span class="n">instruction_form</span><span class="p">)</span>
</span><span id="row-249"><span class="lineno">249 </span>                                <span class="n">peachpy_operands</span> <span class="o">=</span> <span class="p">[</span><span class="n">generate_operand</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">peachpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">evex</span><span class="o">=</span><span class="n">is_avx512</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="row-250"><span class="lineno">250 </span>                                                    <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instruction_form</span><span class="o">.</span><span class="n">operands</span><span class="p">)]</span>
</span><span id="row-251"><span class="lineno">251 </span>                                <span class="n">gas_operands</span> <span class="o">=</span> <span class="p">[</span><span class="n">generate_operand</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">peachpy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">evex</span><span class="o">=</span><span class="n">is_avx512</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="row-252"><span class="lineno">252 </span>                                                <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instruction_form</span><span class="o">.</span><span class="n">operands</span><span class="p">)]</span>
</span><span id="row-253"><span class="lineno">253 </span>                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">op</span><span class="p">:</span> <span class="n">op</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">gas_operands</span><span class="p">)):</span>
</span><span id="row-254"><span class="lineno">254 </span>                                    <span class="n">gas_assembly</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instruction_form</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gas_operands</span><span class="p">))</span>
</span><span id="row-255"><span class="lineno">255 </span>                                    <span class="n">peachpy_assembly</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instruction_form</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peachpy_operands</span><span class="p">))</span>
</span><span id="row-256"><span class="lineno">256 </span>                                    <span class="n">reference_bytecode</span> <span class="o">=</span> <span class="n">binutils_encode</span><span class="p">(</span><span class="n">gas_assembly</span><span class="p">)</span>
</span><span id="row-257"><span class="lineno">257 </span>                                    <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;self.assertEqual(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">.encode())&quot;</span> <span class="o">%</span>
</span><span id="row-258"><span class="lineno">258 </span>                                              <span class="p">(</span><span class="n">reference_bytecode</span><span class="p">,</span> <span class="n">peachpy_assembly</span><span class="p">))</span>
</span><span id="row-259"><span class="lineno">259 </span>                                    <span class="n">has_assertions</span> <span class="o">=</span> <span class="bp">True</span>
</span><span id="row-260"><span class="lineno">260 </span>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_assertions</span><span class="p">:</span>
</span><span id="row-261"><span class="lineno">261 </span>                                <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;pass&quot;</span><span class="p">)</span>
</span><span id="row-262"><span class="lineno">262 </span>                            <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
</span><span id="row-263"><span class="lineno">263 </span>                            <span class="n">code</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
</span><span id="row-264"><span class="lineno">264 </span>
</span><span id="row-265"><span class="lineno">265 </span>            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
</span><span id="row-266"><span class="lineno">266 </span>
</span><span id="row-267"><span class="lineno">267 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="row-268"><span class="lineno">268 </span>    <span class="n">main</span><span class="p">()</span>
</span></pre></div>

    </div>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/code.html"> code</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/code-examples.html"> code examples</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/hightlighting.html"> hightlighting</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/python.html"> python</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2016-2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>