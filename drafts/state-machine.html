<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bit on Bits - state-machine</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Full Atom Feed"/>
    <link href="https://derez.github.io/feeds/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Atom Feed"/>
    <link href="https://derez.github.io/feeds/category/demo-page/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?da7c28ed">




    <meta name="tags" contents="state-machine"/>
    <meta name="tags" contents="markup"/>
    <meta name="tags" contents="rst"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny 'derez' Walker</span></a>
              <span class="email">derez<i class="fa fa-at"></i>packetforge[dot]net</span>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-cogs fa-lg"></i>&nbsp;&nbsp;Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-user-circle fa-lg"></i>&nbsp;&nbsp;About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-3 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bit on Bits</a></li>
            <ul class="right hide-on-med-and-down vertical-align-middle">
              <li><a class="menu-item waves-effect waves-orange btn-flat" href="https://derez.github.io/projects.html">
                <i class="fa fa-cogs"></i>&nbsp;&nbsp;Projects</a>
              </li>
              <li><a class="menu-item dropdown-button waves-effect waves-orange btn-flat" data-beloworigin="true" alignment="left" data-constrainwidth="false" href="#" data-activates="blog-dropdown">
                <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;Blog&nbsp;&nbsp;<i class="fa fa-caret-down"></i></a>
              </li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-3 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/drafts/state-machine.html" class="breadcrumb">state-machine</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/drafts/state-machine.html" rel="bookmark" class="article-name card-title" 
      title="Permalink state-machine">state-machine</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2019-07-04T00:00:00-04:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Date: 
        <time datetime="2019-07-04" itemprop="dateCreated"> 04 Jul 2019</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <div class="highlight"><pre><span></span><span id="row-1"><span class="lineno">  1 </span># Copyright: This module has been placed in the public domain.
</span><span id="row-2"><span class="lineno">  2 </span>
</span><span id="row-3"><span class="lineno">  3 </span>"""
</span><span id="row-4"><span class="lineno">  4 </span>A finite state machine specialized for regular-expression-based text filters,
</span><span id="row-5"><span class="lineno">  5 </span>this module defines the following classes:
</span><span id="row-6"><span class="lineno">  6 </span>
</span><span id="row-7"><span class="lineno">  7 </span><span class="m">-</span> <span class="nv">`StateMachine`</span>, a state machine
</span><span id="row-8"><span class="lineno">  8 </span><span class="m">-</span> <span class="nv">`State`</span>, a state superclass
</span><span id="row-9"><span class="lineno">  9 </span><span class="m">-</span> <span class="nv">`StateMachineWS`</span>, a whitespace-sensitive version of <span class="nv">`StateMachine`</span>
</span><span id="row-10"><span class="lineno"> 10 </span><span class="m">-</span> <span class="nv">`StateWS`</span>, a state superclass for use with <span class="nv">`StateMachineWS`</span>
</span><span id="row-11"><span class="lineno"> 11 </span><span class="m">-</span> <span class="nv">`SearchStateMachine`</span>, uses <span class="nv">`re.search()`</span> instead of <span class="nv">`re.match()`</span>
</span><span id="row-12"><span class="lineno"> 12 </span><span class="m">-</span> <span class="nv">`SearchStateMachineWS`</span>, uses <span class="nv">`re.search()`</span> instead of <span class="nv">`re.match()`</span>
</span><span id="row-13"><span class="lineno"> 13 </span><span class="m">-</span> <span class="nv">`ViewList`</span>, extends standard Python lists.
</span><span id="row-14"><span class="lineno"> 14 </span><span class="m">-</span> <span class="nv">`StringList`</span>, string-specific ViewList.
</span><span id="row-15"><span class="lineno"> 15 </span>
</span><span id="row-16"><span class="lineno"> 16 </span>Exception classes:
</span><span id="row-17"><span class="lineno"> 17 </span>
</span><span id="row-18"><span class="lineno"> 18 </span><span class="m">-</span> <span class="nv">`StateMachineError`</span>
</span><span id="row-19"><span class="lineno"> 19 </span><span class="m">-</span> <span class="nv">`UnknownStateError`</span>
</span><span id="row-20"><span class="lineno"> 20 </span><span class="m">-</span> <span class="nv">`DuplicateStateError`</span>
</span><span id="row-21"><span class="lineno"> 21 </span><span class="m">-</span> <span class="nv">`UnknownTransitionError`</span>
</span><span id="row-22"><span class="lineno"> 22 </span><span class="m">-</span> <span class="nv">`DuplicateTransitionError`</span>
</span><span id="row-23"><span class="lineno"> 23 </span><span class="m">-</span> <span class="nv">`TransitionPatternNotFound`</span>
</span><span id="row-24"><span class="lineno"> 24 </span><span class="m">-</span> <span class="nv">`TransitionMethodNotFound`</span>
</span><span id="row-25"><span class="lineno"> 25 </span><span class="m">-</span> <span class="nv">`UnexpectedIndentationError`</span>
</span><span id="row-26"><span class="lineno"> 26 </span><span class="m">-</span> <span class="nv">`TransitionCorrection`</span>: Raised to switch to another transition.
</span><span id="row-27"><span class="lineno"> 27 </span><span class="m">-</span> <span class="nv">`StateCorrection`</span>: Raised to switch to another state &amp; transition.
</span><span id="row-28"><span class="lineno"> 28 </span>
</span><span id="row-29"><span class="lineno"> 29 </span>Functions:
</span><span id="row-30"><span class="lineno"> 30 </span>
</span><span id="row-31"><span class="lineno"> 31 </span><span class="m">-</span> <span class="nv">`string2lines()`</span>: split a multi-line string into a list of one-line strings
</span><span id="row-32"><span class="lineno"> 32 </span>
</span><span id="row-33"><span class="lineno"> 33 </span>
</span><span id="row-34"><span class="lineno"> 34 </span><span class="gh">How To Use This Module</span>
</span><span id="row-35"><span class="lineno"> 35 </span><span class="gh">======================</span>
</span><span id="row-36"><span class="lineno"> 36 </span>(See the individual classes, methods, and attributes for details.)
</span><span id="row-37"><span class="lineno"> 37 </span>
</span><span id="row-38"><span class="lineno"> 38 </span><span class="m">1.</span> Import it: <span class="s">``import statemachine``</span> or <span class="s">``from statemachine import ...``</span>.
</span><span id="row-39"><span class="lineno"> 39 </span>   You will also need to <span class="s">``import re``</span>.
</span><span id="row-40"><span class="lineno"> 40 </span>
</span><span id="row-41"><span class="lineno"> 41 </span><span class="m">2.</span> Derive a subclass of <span class="nv">`State`</span> (or <span class="nv">`StateWS`</span>) for each state in your state
</span><span id="row-42"><span class="lineno"> 42 </span>   machine<span class="se">::</span>
</span><span id="row-43"><span class="lineno"> 43 </span>
</span><span id="row-44"><span class="lineno"> 44 </span><span class="s">       class MyState(statemachine.State):</span>
</span><span id="row-45"><span class="lineno"> 45 </span>
</span><span id="row-46"><span class="lineno"> 46 </span>   Within the state's class definition:
</span><span id="row-47"><span class="lineno"> 47 </span>
</span><span id="row-48"><span class="lineno"> 48 </span>   <span class="m">a)</span> Include a pattern for each transition, in <span class="nv">`State.patterns`</span>::
</span><span id="row-49"><span class="lineno"> 49 </span>
</span><span id="row-50"><span class="lineno"> 50 </span>          patterns = {'atransition': r'pattern', ...}
</span><span id="row-51"><span class="lineno"> 51 </span>
</span><span id="row-52"><span class="lineno"> 52 </span>   <span class="m">b)</span> Include a list of initial transitions to be set up automatically, in
</span><span id="row-53"><span class="lineno"> 53 </span>      <span class="nv">`State.initial_transitions`</span>::
</span><span id="row-54"><span class="lineno"> 54 </span>
</span><span id="row-55"><span class="lineno"> 55 </span>          initial_transitions = ['atransition', ...]
</span><span id="row-56"><span class="lineno"> 56 </span>
</span><span id="row-57"><span class="lineno"> 57 </span>   <span class="m">c)</span> Define a method for each transition, with the same name as the
</span><span id="row-58"><span class="lineno"> 58 </span>      transition pattern<span class="se">::</span>
</span><span id="row-59"><span class="lineno"> 59 </span>
</span><span id="row-60"><span class="lineno"> 60 </span><span class="s">          def atransition(self, match, context, next_state):</span>
</span><span id="row-61"><span class="lineno"> 61 </span><span class="s">              # do something</span>
</span><span id="row-62"><span class="lineno"> 62 </span><span class="s">              result = [...]  # a list</span>
</span><span id="row-63"><span class="lineno"> 63 </span><span class="s">              return context, next_state, result</span>
</span><span id="row-64"><span class="lineno"> 64 </span><span class="s">              # context, next_state may be altered</span>
</span><span id="row-65"><span class="lineno"> 65 </span>
</span><span id="row-66"><span class="lineno"> 66 </span>      Transition methods may raise an <span class="nv">`EOFError`</span> to cut processing short.
</span><span id="row-67"><span class="lineno"> 67 </span>
</span><span id="row-68"><span class="lineno"> 68 </span>   <span class="m">d)</span> You may wish to override the <span class="nv">`State.bof()`</span> and/or <span class="nv">`State.eof()`</span> implicit
</span><span id="row-69"><span class="lineno"> 69 </span>      transition methods, which handle the beginning- and end-of-file.
</span><span id="row-70"><span class="lineno"> 70 </span>
</span><span id="row-71"><span class="lineno"> 71 </span>   <span class="m">e)</span> In order to handle nested processing, you may wish to override the
</span><span id="row-72"><span class="lineno"> 72 </span>      attributes <span class="nv">`State.nested_sm`</span> and/or <span class="nv">`State.nested_sm_kwargs`</span>.
</span><span id="row-73"><span class="lineno"> 73 </span>
</span><span id="row-74"><span class="lineno"> 74 </span>      If you are using <span class="nv">`StateWS`</span> as a base class, in order to handle nested
</span><span id="row-75"><span class="lineno"> 75 </span>      indented blocks, you may wish to:
</span><span id="row-76"><span class="lineno"> 76 </span>
</span><span id="row-77"><span class="lineno"> 77 </span>      <span class="m">-</span> override the attributes <span class="nv">`StateWS.indent_sm`</span>,
</span><span id="row-78"><span class="lineno"> 78 </span>        <span class="nv">`StateWS.indent_sm_kwargs`</span>, <span class="nv">`StateWS.known_indent_sm`</span>, and/or
</span><span id="row-79"><span class="lineno"> 79 </span>        <span class="nv">`StateWS.known_indent_sm_kwargs`</span>;
</span><span id="row-80"><span class="lineno"> 80 </span>      <span class="m">-</span> override the <span class="nv">`StateWS.blank()`</span> method; and/or
</span><span id="row-81"><span class="lineno"> 81 </span>      <span class="m">-</span> override or extend the <span class="nv">`StateWS.indent()`</span>, <span class="nv">`StateWS.known_indent()`</span>,
</span><span id="row-82"><span class="lineno"> 82 </span>        and/or <span class="nv">`StateWS.firstknown_indent()`</span> methods.
</span><span id="row-83"><span class="lineno"> 83 </span>
</span><span id="row-84"><span class="lineno"> 84 </span><span class="m">3.</span> Create a state machine object::
</span><span id="row-85"><span class="lineno"> 85 </span>
</span><span id="row-86"><span class="lineno"> 86 </span>       sm = StateMachine(state_classes=[MyState, ...],
</span><span id="row-87"><span class="lineno"> 87 </span>                         initial_state='MyState')
</span><span id="row-88"><span class="lineno"> 88 </span>
</span><span id="row-89"><span class="lineno"> 89 </span><span class="m">4.</span> Obtain the input text, which needs to be converted into a tab-free list of
</span><span id="row-90"><span class="lineno"> 90 </span>   one-line strings. For example, to read text from a file called
</span><span id="row-91"><span class="lineno"> 91 </span>   'inputfile'<span class="se">::</span>
</span><span id="row-92"><span class="lineno"> 92 </span>
</span><span id="row-93"><span class="lineno"> 93 </span><span class="s">       input_string = open('inputfile').read()</span>
</span><span id="row-94"><span class="lineno"> 94 </span><span class="s">       input_lines = statemachine.string2lines(input_string)</span>
</span><span id="row-95"><span class="lineno"> 95 </span>
</span><span id="row-96"><span class="lineno"> 96 </span><span class="m">5.</span> Run the state machine on the input text and collect the results, a list::
</span><span id="row-97"><span class="lineno"> 97 </span>
</span><span id="row-98"><span class="lineno"> 98 </span>       results = sm.run(input_lines)
</span><span id="row-99"><span class="lineno"> 99 </span>
</span><span id="row-100"><span class="lineno">100 </span><span class="m">6.</span> Remove any lingering circular references::
</span><span id="row-101"><span class="lineno">101 </span>
</span><span id="row-102"><span class="lineno">102 </span>       sm.unlink()
</span></pre></div>
<div class="highlight"><pre><span></span><span id="row-1"><span class="lineno">   1 </span><span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">'restructuredtext'</span>
</span><span id="row-2"><span class="lineno">   2 </span>
</span><span id="row-3"><span class="lineno">   3 </span><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="row-4"><span class="lineno">   4 </span><span class="kn">import</span> <span class="nn">re</span>
</span><span id="row-5"><span class="lineno">   5 </span><span class="kn">import</span> <span class="nn">types</span>
</span><span id="row-6"><span class="lineno">   6 </span><span class="kn">import</span> <span class="nn">unicodedata</span>
</span><span id="row-7"><span class="lineno">   7 </span><span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">utils</span>
</span><span id="row-8"><span class="lineno">   8 </span><span class="kn">from</span> <span class="nn">docutils.utils.error_reporting</span> <span class="kn">import</span> <span class="n">ErrorOutput</span>
</span><span id="row-9"><span class="lineno">   9 </span>
</span><span id="row-10"><span class="lineno">  10 </span>
</span><span id="row-11"><span class="lineno">  11 </span><span class="k">class</span> <span class="nc">StateMachine</span><span class="p">:</span>
</span><span id="row-12"><span class="lineno">  12 </span>
</span><span id="row-13"><span class="lineno">  13 </span>    <span class="sd">"""</span>
</span><span id="row-14"><span class="lineno">  14 </span><span class="sd">    A finite state machine for text filters using regular expressions.</span>
</span><span id="row-15"><span class="lineno">  15 </span>
</span><span id="row-16"><span class="lineno">  16 </span><span class="sd">    The input is provided in the form of a list of one-line strings (no</span>
</span><span id="row-17"><span class="lineno">  17 </span><span class="sd">    newlines). States are subclasses of the `State` class. Transitions consist</span>
</span><span id="row-18"><span class="lineno">  18 </span><span class="sd">    of regular expression patterns and transition methods, and are defined in</span>
</span><span id="row-19"><span class="lineno">  19 </span><span class="sd">    each state.</span>
</span><span id="row-20"><span class="lineno">  20 </span>
</span><span id="row-21"><span class="lineno">  21 </span><span class="sd">    The state machine is started with the `run()` method, which returns the</span>
</span><span id="row-22"><span class="lineno">  22 </span><span class="sd">    results of processing in a list.</span>
</span><span id="row-23"><span class="lineno">  23 </span><span class="sd">    """</span>
</span><span id="row-24"><span class="lineno">  24 </span>
</span><span id="row-25"><span class="lineno">  25 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_classes</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-26"><span class="lineno">  26 </span>        <span class="sd">"""</span>
</span><span id="row-27"><span class="lineno">  27 </span><span class="sd">        Initialize a `StateMachine` object; add state objects.</span>
</span><span id="row-28"><span class="lineno">  28 </span>
</span><span id="row-29"><span class="lineno">  29 </span><span class="sd">        Parameters:</span>
</span><span id="row-30"><span class="lineno">  30 </span>
</span><span id="row-31"><span class="lineno">  31 </span><span class="sd">        - `state_classes`: a list of `State` (sub)classes.</span>
</span><span id="row-32"><span class="lineno">  32 </span><span class="sd">        - `initial_state`: a string, the class name of the initial state.</span>
</span><span id="row-33"><span class="lineno">  33 </span><span class="sd">        - `debug`: a boolean; produce verbose output if true (nonzero).</span>
</span><span id="row-34"><span class="lineno">  34 </span><span class="sd">        """</span>
</span><span id="row-35"><span class="lineno">  35 </span>
</span><span id="row-36"><span class="lineno">  36 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-37"><span class="lineno">  37 </span>        <span class="sd">"""`StringList` of input lines (without newlines).</span>
</span><span id="row-38"><span class="lineno">  38 </span><span class="sd">        Filled by `self.run()`."""</span>
</span><span id="row-39"><span class="lineno">  39 </span>
</span><span id="row-40"><span class="lineno">  40 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="row-41"><span class="lineno">  41 </span>        <span class="sd">"""Offset of `self.input_lines` from the beginning of the file."""</span>
</span><span id="row-42"><span class="lineno">  42 </span>
</span><span id="row-43"><span class="lineno">  43 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-44"><span class="lineno">  44 </span>        <span class="sd">"""Current input line."""</span>
</span><span id="row-45"><span class="lineno">  45 </span>
</span><span id="row-46"><span class="lineno">  46 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="row-47"><span class="lineno">  47 </span>        <span class="sd">"""Current input line offset from beginning of `self.input_lines`."""</span>
</span><span id="row-48"><span class="lineno">  48 </span>
</span><span id="row-49"><span class="lineno">  49 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="row-50"><span class="lineno">  50 </span>        <span class="sd">"""Debugging mode on/off."""</span>
</span><span id="row-51"><span class="lineno">  51 </span>
</span><span id="row-52"><span class="lineno">  52 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span> <span class="o">=</span> <span class="n">initial_state</span>
</span><span id="row-53"><span class="lineno">  53 </span>        <span class="sd">"""The name of the initial state (key to `self.states`)."""</span>
</span><span id="row-54"><span class="lineno">  54 </span>
</span><span id="row-55"><span class="lineno">  55 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">initial_state</span>
</span><span id="row-56"><span class="lineno">  56 </span>        <span class="sd">"""The name of the current state (key to `self.states`)."""</span>
</span><span id="row-57"><span class="lineno">  57 </span>
</span><span id="row-58"><span class="lineno">  58 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="row-59"><span class="lineno">  59 </span>        <span class="sd">"""Mapping of {state_name: State_object}."""</span>
</span><span id="row-60"><span class="lineno">  60 </span>
</span><span id="row-61"><span class="lineno">  61 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_states</span><span class="p">(</span><span class="n">state_classes</span><span class="p">)</span>
</span><span id="row-62"><span class="lineno">  62 </span>
</span><span id="row-63"><span class="lineno">  63 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-64"><span class="lineno">  64 </span>        <span class="sd">"""List of bound methods or functions to call whenever the current</span>
</span><span id="row-65"><span class="lineno">  65 </span><span class="sd">        line changes.  Observers are called with one argument, ``self``.</span>
</span><span id="row-66"><span class="lineno">  66 </span><span class="sd">        Cleared at the end of `run()`."""</span>
</span><span id="row-67"><span class="lineno">  67 </span>
</span><span id="row-68"><span class="lineno">  68 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="n">ErrorOutput</span><span class="p">()</span>
</span><span id="row-69"><span class="lineno">  69 </span>        <span class="sd">"""Wrapper around sys.stderr catching en-/decoding errors"""</span>
</span><span id="row-70"><span class="lineno">  70 </span>
</span><span id="row-71"><span class="lineno">  71 </span>
</span><span id="row-72"><span class="lineno">  72 </span>    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-73"><span class="lineno">  73 </span>        <span class="sd">"""Remove circular references to objects no longer required."""</span>
</span><span id="row-74"><span class="lineno">  74 </span>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="row-75"><span class="lineno">  75 </span>            <span class="n">state</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="row-76"><span class="lineno">  76 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-77"><span class="lineno">  77 </span>
</span><span id="row-78"><span class="lineno">  78 </span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">input_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span id="row-79"><span class="lineno">  79 </span>            <span class="n">input_source</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-80"><span class="lineno">  80 </span>        <span class="sd">"""</span>
</span><span id="row-81"><span class="lineno">  81 </span><span class="sd">        Run the state machine on `input_lines`. Return results (a list).</span>
</span><span id="row-82"><span class="lineno">  82 </span>
</span><span id="row-83"><span class="lineno">  83 </span><span class="sd">        Reset `self.line_offset` and `self.current_state`. Run the</span>
</span><span id="row-84"><span class="lineno">  84 </span><span class="sd">        beginning-of-file transition. Input one line at a time and check for a</span>
</span><span id="row-85"><span class="lineno">  85 </span><span class="sd">        matching transition. If a match is found, call the transition method</span>
</span><span id="row-86"><span class="lineno">  86 </span><span class="sd">        and possibly change the state. Store the context returned by the</span>
</span><span id="row-87"><span class="lineno">  87 </span><span class="sd">        transition method to be passed on to the next transition matched.</span>
</span><span id="row-88"><span class="lineno">  88 </span><span class="sd">        Accumulate the results returned by the transition methods in a list.</span>
</span><span id="row-89"><span class="lineno">  89 </span><span class="sd">        Run the end-of-file transition. Finally, return the accumulated</span>
</span><span id="row-90"><span class="lineno">  90 </span><span class="sd">        results.</span>
</span><span id="row-91"><span class="lineno">  91 </span>
</span><span id="row-92"><span class="lineno">  92 </span><span class="sd">        Parameters:</span>
</span><span id="row-93"><span class="lineno">  93 </span>
</span><span id="row-94"><span class="lineno">  94 </span><span class="sd">        - `input_lines`: a list of strings without newlines, or `StringList`.</span>
</span><span id="row-95"><span class="lineno">  95 </span><span class="sd">        - `input_offset`: the line offset of `input_lines` from the beginning</span>
</span><span id="row-96"><span class="lineno">  96 </span><span class="sd">          of the file.</span>
</span><span id="row-97"><span class="lineno">  97 </span><span class="sd">        - `context`: application-specific storage.</span>
</span><span id="row-98"><span class="lineno">  98 </span><span class="sd">        - `input_source`: name or path of source of `input_lines`.</span>
</span><span id="row-99"><span class="lineno">  99 </span><span class="sd">        - `initial_state`: name of initial state.</span>
</span><span id="row-100"><span class="lineno"> 100 </span><span class="sd">        """</span>
</span><span id="row-101"><span class="lineno"> 101 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_init</span><span class="p">()</span>
</span><span id="row-102"><span class="lineno"> 102 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_lines</span><span class="p">,</span> <span class="n">StringList</span><span class="p">):</span>
</span><span id="row-103"><span class="lineno"> 103 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span> <span class="o">=</span> <span class="n">input_lines</span>
</span><span id="row-104"><span class="lineno"> 104 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-105"><span class="lineno"> 105 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span> <span class="o">=</span> <span class="n">StringList</span><span class="p">(</span><span class="n">input_lines</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">input_source</span><span class="p">)</span>
</span><span id="row-106"><span class="lineno"> 106 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span> <span class="o">=</span> <span class="n">input_offset</span>
</span><span id="row-107"><span class="lineno"> 107 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="row-108"><span class="lineno"> 108 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">initial_state</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span>
</span><span id="row-109"><span class="lineno"> 109 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-110"><span class="lineno"> 110 </span>            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-111"><span class="lineno"> 111 </span>                <span class="sa">u</span><span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: input_lines (line_offset=</span><span class="si">%s</span><span class="s1">):</span><span class="se">\n</span><span class="s1">| </span><span class="si">%s</span><span class="s1">'</span>
</span><span id="row-112"><span class="lineno"> 112 </span>                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">,</span> <span class="sa">u</span><span class="s1">'</span><span class="se">\n</span><span class="s1">| '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">)))</span>
</span><span id="row-113"><span class="lineno"> 113 </span>        <span class="n">transitions</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-114"><span class="lineno"> 114 </span>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-115"><span class="lineno"> 115 </span>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
</span><span id="row-116"><span class="lineno"> 116 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-117"><span class="lineno"> 117 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-118"><span class="lineno"> 118 </span>                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: bof transition'</span>
</span><span id="row-119"><span class="lineno"> 119 </span>            <span class="n">context</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">bof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="row-120"><span class="lineno"> 120 </span>            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="row-121"><span class="lineno"> 121 </span>            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span id="row-122"><span class="lineno"> 122 </span>                <span class="k">try</span><span class="p">:</span>
</span><span id="row-123"><span class="lineno"> 123 </span>                    <span class="k">try</span><span class="p">:</span>
</span><span id="row-124"><span class="lineno"> 124 </span>                        <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">()</span>
</span><span id="row-125"><span class="lineno"> 125 </span>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-126"><span class="lineno"> 126 </span>                            <span class="n">source</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="row-127"><span class="lineno"> 127 </span>                                <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">)</span>
</span><span id="row-128"><span class="lineno"> 128 </span>                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-129"><span class="lineno"> 129 </span>                                <span class="sa">u</span><span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: line (source=</span><span class="si">%r</span><span class="s1">, '</span>
</span><span id="row-130"><span class="lineno"> 130 </span>                                <span class="sa">u</span><span class="s1">'offset=</span><span class="si">%r</span><span class="s1">):</span><span class="se">\n</span><span class="s1">| </span><span class="si">%s</span><span class="s1">'</span>
</span><span id="row-131"><span class="lineno"> 131 </span>                                <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
</span><span id="row-132"><span class="lineno"> 132 </span>                        <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_line</span><span class="p">(</span>
</span><span id="row-133"><span class="lineno"> 133 </span>                            <span class="n">context</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
</span><span id="row-134"><span class="lineno"> 134 </span>                    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
</span><span id="row-135"><span class="lineno"> 135 </span>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-136"><span class="lineno"> 136 </span>                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-137"><span class="lineno"> 137 </span>                                <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: </span><span class="si">%s</span><span class="s1">.eof transition'</span>
</span><span id="row-138"><span class="lineno"> 138 </span>                                <span class="o">%</span> <span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="row-139"><span class="lineno"> 139 </span>                        <span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">eof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="row-140"><span class="lineno"> 140 </span>                        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="row-141"><span class="lineno"> 141 </span>                        <span class="k">break</span>
</span><span id="row-142"><span class="lineno"> 142 </span>                    <span class="k">else</span><span class="p">:</span>
</span><span id="row-143"><span class="lineno"> 143 </span>                        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="row-144"><span class="lineno"> 144 </span>                <span class="k">except</span> <span class="n">TransitionCorrection</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span>
</span><span id="row-145"><span class="lineno"> 145 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">previous_line</span><span class="p">()</span> <span class="c1"># back up for another try</span>
</span><span id="row-146"><span class="lineno"> 146 </span>                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
</span><span id="row-147"><span class="lineno"> 147 </span>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-148"><span class="lineno"> 148 </span>                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-149"><span class="lineno"> 149 </span>                              <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: TransitionCorrection to '</span>
</span><span id="row-150"><span class="lineno"> 150 </span>                              <span class="s1">'state "</span><span class="si">%s</span><span class="s1">", transition </span><span class="si">%s</span><span class="s1">.'</span>
</span><span id="row-151"><span class="lineno"> 151 </span>                              <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="row-152"><span class="lineno"> 152 </span>                    <span class="k">continue</span>
</span><span id="row-153"><span class="lineno"> 153 </span>                <span class="k">except</span> <span class="n">StateCorrection</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span>
</span><span id="row-154"><span class="lineno"> 154 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">previous_line</span><span class="p">()</span> <span class="c1"># back up for another try</span>
</span><span id="row-155"><span class="lineno"> 155 </span>                    <span class="n">next_state</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="row-156"><span class="lineno"> 156 </span>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="row-157"><span class="lineno"> 157 </span>                        <span class="n">transitions</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-158"><span class="lineno"> 158 </span>                    <span class="k">else</span><span class="p">:</span>
</span><span id="row-159"><span class="lineno"> 159 </span>                        <span class="n">transitions</span> <span class="o">=</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
</span><span id="row-160"><span class="lineno"> 160 </span>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-161"><span class="lineno"> 161 </span>                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-162"><span class="lineno"> 162 </span>                              <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.run: StateCorrection to state '</span>
</span><span id="row-163"><span class="lineno"> 163 </span>                              <span class="s1">'"</span><span class="si">%s</span><span class="s1">", transition </span><span class="si">%s</span><span class="s1">.'</span>
</span><span id="row-164"><span class="lineno"> 164 </span>                              <span class="o">%</span> <span class="p">(</span><span class="n">next_state</span><span class="p">,</span> <span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="row-165"><span class="lineno"> 165 </span>                <span class="k">else</span><span class="p">:</span>
</span><span id="row-166"><span class="lineno"> 166 </span>                    <span class="n">transitions</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-167"><span class="lineno"> 167 </span>                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span><span id="row-168"><span class="lineno"> 168 </span>        <span class="k">except</span><span class="p">:</span>
</span><span id="row-169"><span class="lineno"> 169 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-170"><span class="lineno"> 170 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
</span><span id="row-171"><span class="lineno"> 171 </span>            <span class="k">raise</span>
</span><span id="row-172"><span class="lineno"> 172 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-173"><span class="lineno"> 173 </span>        <span class="k">return</span> <span class="n">results</span>
</span><span id="row-174"><span class="lineno"> 174 </span>
</span><span id="row-175"><span class="lineno"> 175 </span>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-176"><span class="lineno"> 176 </span>        <span class="sd">"""</span>
</span><span id="row-177"><span class="lineno"> 177 </span><span class="sd">        Return current state object; set it first if `next_state` given.</span>
</span><span id="row-178"><span class="lineno"> 178 </span>
</span><span id="row-179"><span class="lineno"> 179 </span><span class="sd">        Parameter `next_state`: a string, the name of the next state.</span>
</span><span id="row-180"><span class="lineno"> 180 </span>
</span><span id="row-181"><span class="lineno"> 181 </span><span class="sd">        Exception: `UnknownStateError` raised if `next_state` unknown.</span>
</span><span id="row-182"><span class="lineno"> 182 </span><span class="sd">        """</span>
</span><span id="row-183"><span class="lineno"> 183 </span>        <span class="k">if</span> <span class="n">next_state</span><span class="p">:</span>
</span><span id="row-184"><span class="lineno"> 184 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">next_state</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">:</span>
</span><span id="row-185"><span class="lineno"> 185 </span>                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-186"><span class="lineno"> 186 </span>                    <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.get_state: Changing state from '</span>
</span><span id="row-187"><span class="lineno"> 187 </span>                    <span class="s1">'"</span><span class="si">%s</span><span class="s1">" to "</span><span class="si">%s</span><span class="s1">" (input line </span><span class="si">%s</span><span class="s1">).'</span>
</span><span id="row-188"><span class="lineno"> 188 </span>                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span>
</span><span id="row-189"><span class="lineno"> 189 </span>                       <span class="bp">self</span><span class="o">.</span><span class="n">abs_line_number</span><span class="p">()))</span>
</span><span id="row-190"><span class="lineno"> 190 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">next_state</span>
</span><span id="row-191"><span class="lineno"> 191 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-192"><span class="lineno"> 192 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">]</span>
</span><span id="row-193"><span class="lineno"> 193 </span>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="row-194"><span class="lineno"> 194 </span>            <span class="k">raise</span> <span class="n">UnknownStateError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">)</span>
</span><span id="row-195"><span class="lineno"> 195 </span>
</span><span id="row-196"><span class="lineno"> 196 </span>    <span class="k">def</span> <span class="nf">next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="row-197"><span class="lineno"> 197 </span>        <span class="sd">"""Load `self.line` with the `n`'th next line and return it."""</span>
</span><span id="row-198"><span class="lineno"> 198 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-199"><span class="lineno"> 199 </span>            <span class="k">try</span><span class="p">:</span>
</span><span id="row-200"><span class="lineno"> 200 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+=</span> <span class="n">n</span>
</span><span id="row-201"><span class="lineno"> 201 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">]</span>
</span><span id="row-202"><span class="lineno"> 202 </span>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-203"><span class="lineno"> 203 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-204"><span class="lineno"> 204 </span>                <span class="k">raise</span> <span class="ne">EOFError</span>
</span><span id="row-205"><span class="lineno"> 205 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span>
</span><span id="row-206"><span class="lineno"> 206 </span>        <span class="k">finally</span><span class="p">:</span>
</span><span id="row-207"><span class="lineno"> 207 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>
</span><span id="row-208"><span class="lineno"> 208 </span>
</span><span id="row-209"><span class="lineno"> 209 </span>    <span class="k">def</span> <span class="nf">is_next_line_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-210"><span class="lineno"> 210 </span>        <span class="sd">"""Return 1 if the next line is blank or non-existant."""</span>
</span><span id="row-211"><span class="lineno"> 211 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-212"><span class="lineno"> 212 </span>            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="row-213"><span class="lineno"> 213 </span>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-214"><span class="lineno"> 214 </span>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="row-215"><span class="lineno"> 215 </span>
</span><span id="row-216"><span class="lineno"> 216 </span>    <span class="k">def</span> <span class="nf">at_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-217"><span class="lineno"> 217 </span>        <span class="sd">"""Return 1 if the input is at or past end-of-file."""</span>
</span><span id="row-218"><span class="lineno"> 218 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="row-219"><span class="lineno"> 219 </span>
</span><span id="row-220"><span class="lineno"> 220 </span>    <span class="k">def</span> <span class="nf">at_bof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-221"><span class="lineno"> 221 </span>        <span class="sd">"""Return 1 if the input is at or before beginning-of-file."""</span>
</span><span id="row-222"><span class="lineno"> 222 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">&lt;=</span> <span class="mi">0</span>
</span><span id="row-223"><span class="lineno"> 223 </span>
</span><span id="row-224"><span class="lineno"> 224 </span>    <span class="k">def</span> <span class="nf">previous_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="row-225"><span class="lineno"> 225 </span>        <span class="sd">"""Load `self.line` with the `n`'th previous line and return it."""</span>
</span><span id="row-226"><span class="lineno"> 226 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">-=</span> <span class="n">n</span>
</span><span id="row-227"><span class="lineno"> 227 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="row-228"><span class="lineno"> 228 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-229"><span class="lineno"> 229 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-230"><span class="lineno"> 230 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">]</span>
</span><span id="row-231"><span class="lineno"> 231 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>
</span><span id="row-232"><span class="lineno"> 232 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span>
</span><span id="row-233"><span class="lineno"> 233 </span>
</span><span id="row-234"><span class="lineno"> 234 </span>    <span class="k">def</span> <span class="nf">goto_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">):</span>
</span><span id="row-235"><span class="lineno"> 235 </span>        <span class="sd">"""Jump to absolute line offset `line_offset`, load and return it."""</span>
</span><span id="row-236"><span class="lineno"> 236 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-237"><span class="lineno"> 237 </span>            <span class="k">try</span><span class="p">:</span>
</span><span id="row-238"><span class="lineno"> 238 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">=</span> <span class="n">line_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span>
</span><span id="row-239"><span class="lineno"> 239 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">]</span>
</span><span id="row-240"><span class="lineno"> 240 </span>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-241"><span class="lineno"> 241 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-242"><span class="lineno"> 242 </span>                <span class="k">raise</span> <span class="ne">EOFError</span>
</span><span id="row-243"><span class="lineno"> 243 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span>
</span><span id="row-244"><span class="lineno"> 244 </span>        <span class="k">finally</span><span class="p">:</span>
</span><span id="row-245"><span class="lineno"> 245 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>
</span><span id="row-246"><span class="lineno"> 246 </span>
</span><span id="row-247"><span class="lineno"> 247 </span>    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">):</span>
</span><span id="row-248"><span class="lineno"> 248 </span>        <span class="sd">"""Return source of line at absolute line offset `line_offset`."""</span>
</span><span id="row-249"><span class="lineno"> 249 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">line_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span><span class="p">)</span>
</span><span id="row-250"><span class="lineno"> 250 </span>
</span><span id="row-251"><span class="lineno"> 251 </span>    <span class="k">def</span> <span class="nf">abs_line_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-252"><span class="lineno"> 252 </span>        <span class="sd">"""Return line offset of current line, from beginning of file."""</span>
</span><span id="row-253"><span class="lineno"> 253 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span>
</span><span id="row-254"><span class="lineno"> 254 </span>
</span><span id="row-255"><span class="lineno"> 255 </span>    <span class="k">def</span> <span class="nf">abs_line_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-256"><span class="lineno"> 256 </span>        <span class="sd">"""Return line number of current line (counting from 1)."""</span>
</span><span id="row-257"><span class="lineno"> 257 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="row-258"><span class="lineno"> 258 </span>
</span><span id="row-259"><span class="lineno"> 259 </span>    <span class="k">def</span> <span class="nf">get_source_and_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-260"><span class="lineno"> 260 </span>        <span class="sd">"""Return (source, line) tuple for current or given line number.</span>
</span><span id="row-261"><span class="lineno"> 261 </span>
</span><span id="row-262"><span class="lineno"> 262 </span><span class="sd">        Looks up the source and line number in the `self.input_lines`</span>
</span><span id="row-263"><span class="lineno"> 263 </span><span class="sd">        StringList instance to count for included source files.</span>
</span><span id="row-264"><span class="lineno"> 264 </span>
</span><span id="row-265"><span class="lineno"> 265 </span><span class="sd">        If the optional argument `lineno` is given, convert it from an</span>
</span><span id="row-266"><span class="lineno"> 266 </span><span class="sd">        absolute line number to the corresponding (source, line) pair.</span>
</span><span id="row-267"><span class="lineno"> 267 </span><span class="sd">        """</span>
</span><span id="row-268"><span class="lineno"> 268 </span>        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-269"><span class="lineno"> 269 </span>            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span>
</span><span id="row-270"><span class="lineno"> 270 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-271"><span class="lineno"> 271 </span>            <span class="n">offset</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="row-272"><span class="lineno"> 272 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-273"><span class="lineno"> 273 </span>            <span class="n">src</span><span class="p">,</span> <span class="n">srcoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
</span><span id="row-274"><span class="lineno"> 274 </span>            <span class="n">srcline</span> <span class="o">=</span> <span class="n">srcoffset</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="row-275"><span class="lineno"> 275 </span>        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
</span><span id="row-276"><span class="lineno"> 276 </span>            <span class="c1"># line is None if index is "Just past the end"</span>
</span><span id="row-277"><span class="lineno"> 277 </span>            <span class="n">src</span><span class="p">,</span> <span class="n">srcline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_and_line</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_offset</span><span class="p">)</span>
</span><span id="row-278"><span class="lineno"> 278 </span>            <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcline</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="row-279"><span class="lineno"> 279 </span>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span> <span class="c1"># `offset` is off the list</span>
</span><span id="row-280"><span class="lineno"> 280 </span>            <span class="n">src</span><span class="p">,</span> <span class="n">srcline</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
</span><span id="row-281"><span class="lineno"> 281 </span>            <span class="c1"># raise AssertionError('cannot find line %d in %s lines' %</span>
</span><span id="row-282"><span class="lineno"> 282 </span>            <span class="c1">#                      (offset, len(self.input_lines)))</span>
</span><span id="row-283"><span class="lineno"> 283 </span>            <span class="c1">#                      # list(self.input_lines.lines())))</span>
</span><span id="row-284"><span class="lineno"> 284 </span>        <span class="c1"># assert offset == srcoffset, str(self.input_lines)</span>
</span><span id="row-285"><span class="lineno"> 285 </span>        <span class="c1"># print "get_source_and_line(%s):" % lineno,</span>
</span><span id="row-286"><span class="lineno"> 286 </span>        <span class="c1"># print offset + 1, '-&gt;', src, srcline</span>
</span><span id="row-287"><span class="lineno"> 287 </span>        <span class="c1"># print self.input_lines</span>
</span><span id="row-288"><span class="lineno"> 288 </span>        <span class="k">return</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">srcline</span><span class="p">)</span>
</span><span id="row-289"><span class="lineno"> 289 </span>
</span><span id="row-290"><span class="lineno"> 290 </span>    <span class="k">def</span> <span class="nf">insert_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
</span><span id="row-291"><span class="lineno"> 291 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span>
</span><span id="row-292"><span class="lineno"> 292 </span>                                <span class="n">source</span><span class="o">=</span><span class="s1">'internal padding after '</span><span class="o">+</span><span class="n">source</span><span class="p">,</span>
</span><span id="row-293"><span class="lineno"> 293 </span>                                <span class="n">offset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">input_lines</span><span class="p">))</span>
</span><span id="row-294"><span class="lineno"> 294 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span>
</span><span id="row-295"><span class="lineno"> 295 </span>                                <span class="n">source</span><span class="o">=</span><span class="s1">'internal padding before '</span><span class="o">+</span><span class="n">source</span><span class="p">,</span>
</span><span id="row-296"><span class="lineno"> 296 </span>                                <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="row-297"><span class="lineno"> 297 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="row-298"><span class="lineno"> 298 </span>                                <span class="n">StringList</span><span class="p">(</span><span class="n">input_lines</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
</span><span id="row-299"><span class="lineno"> 299 </span>
</span><span id="row-300"><span class="lineno"> 300 </span>    <span class="k">def</span> <span class="nf">get_text_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_left</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-301"><span class="lineno"> 301 </span>        <span class="sd">"""</span>
</span><span id="row-302"><span class="lineno"> 302 </span><span class="sd">        Return a contiguous block of text.</span>
</span><span id="row-303"><span class="lineno"> 303 </span>
</span><span id="row-304"><span class="lineno"> 304 </span><span class="sd">        If `flush_left` is true, raise `UnexpectedIndentationError` if an</span>
</span><span id="row-305"><span class="lineno"> 305 </span><span class="sd">        indented line is encountered before the text block ends (with a blank</span>
</span><span id="row-306"><span class="lineno"> 306 </span><span class="sd">        line).</span>
</span><span id="row-307"><span class="lineno"> 307 </span><span class="sd">        """</span>
</span><span id="row-308"><span class="lineno"> 308 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-309"><span class="lineno"> 309 </span>            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">get_text_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">,</span>
</span><span id="row-310"><span class="lineno"> 310 </span>                                                    <span class="n">flush_left</span><span class="p">)</span>
</span><span id="row-311"><span class="lineno"> 311 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="row-312"><span class="lineno"> 312 </span>            <span class="k">return</span> <span class="n">block</span>
</span><span id="row-313"><span class="lineno"> 313 </span>        <span class="k">except</span> <span class="n">UnexpectedIndentationError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
</span><span id="row-314"><span class="lineno"> 314 </span>            <span class="n">block</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="row-315"><span class="lineno"> 315 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># advance to last line of block</span>
</span><span id="row-316"><span class="lineno"> 316 </span>            <span class="k">raise</span>
</span><span id="row-317"><span class="lineno"> 317 </span>
</span><span id="row-318"><span class="lineno"> 318 </span>    <span class="k">def</span> <span class="nf">check_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-319"><span class="lineno"> 319 </span>        <span class="sd">"""</span>
</span><span id="row-320"><span class="lineno"> 320 </span><span class="sd">        Examine one line of input for a transition match &amp; execute its method.</span>
</span><span id="row-321"><span class="lineno"> 321 </span>
</span><span id="row-322"><span class="lineno"> 322 </span><span class="sd">        Parameters:</span>
</span><span id="row-323"><span class="lineno"> 323 </span>
</span><span id="row-324"><span class="lineno"> 324 </span><span class="sd">        - `context`: application-dependent storage.</span>
</span><span id="row-325"><span class="lineno"> 325 </span><span class="sd">        - `state`: a `State` object, the current state.</span>
</span><span id="row-326"><span class="lineno"> 326 </span><span class="sd">        - `transitions`: an optional ordered list of transition names to try,</span>
</span><span id="row-327"><span class="lineno"> 327 </span><span class="sd">          instead of ``state.transition_order``.</span>
</span><span id="row-328"><span class="lineno"> 328 </span>
</span><span id="row-329"><span class="lineno"> 329 </span><span class="sd">        Return the values returned by the transition method:</span>
</span><span id="row-330"><span class="lineno"> 330 </span>
</span><span id="row-331"><span class="lineno"> 331 </span><span class="sd">        - context: possibly modified from the parameter `context`;</span>
</span><span id="row-332"><span class="lineno"> 332 </span><span class="sd">        - next state name (`State` subclass name);</span>
</span><span id="row-333"><span class="lineno"> 333 </span><span class="sd">        - the result output of the transition, a list.</span>
</span><span id="row-334"><span class="lineno"> 334 </span>
</span><span id="row-335"><span class="lineno"> 335 </span><span class="sd">        When there is no match, ``state.no_match()`` is called and its return</span>
</span><span id="row-336"><span class="lineno"> 336 </span><span class="sd">        value is returned.</span>
</span><span id="row-337"><span class="lineno"> 337 </span><span class="sd">        """</span>
</span><span id="row-338"><span class="lineno"> 338 </span>        <span class="k">if</span> <span class="n">transitions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-339"><span class="lineno"> 339 </span>            <span class="n">transitions</span> <span class="o">=</span>  <span class="n">state</span><span class="o">.</span><span class="n">transition_order</span>
</span><span id="row-340"><span class="lineno"> 340 </span>        <span class="n">state_correction</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-341"><span class="lineno"> 341 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-342"><span class="lineno"> 342 </span>            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-343"><span class="lineno"> 343 </span>                  <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.check_line: state="</span><span class="si">%s</span><span class="s1">", transitions=</span><span class="si">%r</span><span class="s1">.'</span>
</span><span id="row-344"><span class="lineno"> 344 </span>                  <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">transitions</span><span class="p">))</span>
</span><span id="row-345"><span class="lineno"> 345 </span>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
</span><span id="row-346"><span class="lineno"> 346 </span>            <span class="n">pattern</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">next_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="row-347"><span class="lineno"> 347 </span>            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
</span><span id="row-348"><span class="lineno"> 348 </span>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="row-349"><span class="lineno"> 349 </span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-350"><span class="lineno"> 350 </span>                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-351"><span class="lineno"> 351 </span>                          <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.check_line: Matched transition '</span>
</span><span id="row-352"><span class="lineno"> 352 </span>                          <span class="s1">'"</span><span class="si">%s</span><span class="s1">" in state "</span><span class="si">%s</span><span class="s1">".'</span>
</span><span id="row-353"><span class="lineno"> 353 </span>                          <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
</span><span id="row-354"><span class="lineno"> 354 </span>                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>
</span><span id="row-355"><span class="lineno"> 355 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-356"><span class="lineno"> 356 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="row-357"><span class="lineno"> 357 </span>                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span>
</span><span id="row-358"><span class="lineno"> 358 </span>                      <span class="s1">'</span><span class="se">\n</span><span class="s1">StateMachine.check_line: No match in state "</span><span class="si">%s</span><span class="s1">".'</span>
</span><span id="row-359"><span class="lineno"> 359 </span>                      <span class="o">%</span> <span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="row-360"><span class="lineno"> 360 </span>            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">no_match</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
</span><span id="row-361"><span class="lineno"> 361 </span>
</span><span id="row-362"><span class="lineno"> 362 </span>    <span class="k">def</span> <span class="nf">add_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_class</span><span class="p">):</span>
</span><span id="row-363"><span class="lineno"> 363 </span>        <span class="sd">"""</span>
</span><span id="row-364"><span class="lineno"> 364 </span><span class="sd">        Initialize &amp; add a `state_class` (`State` subclass) object.</span>
</span><span id="row-365"><span class="lineno"> 365 </span>
</span><span id="row-366"><span class="lineno"> 366 </span><span class="sd">        Exception: `DuplicateStateError` raised if `state_class` was already</span>
</span><span id="row-367"><span class="lineno"> 367 </span><span class="sd">        added.</span>
</span><span id="row-368"><span class="lineno"> 368 </span><span class="sd">        """</span>
</span><span id="row-369"><span class="lineno"> 369 </span>        <span class="n">statename</span> <span class="o">=</span> <span class="n">state_class</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="row-370"><span class="lineno"> 370 </span>        <span class="k">if</span> <span class="n">statename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
</span><span id="row-371"><span class="lineno"> 371 </span>            <span class="k">raise</span> <span class="n">DuplicateStateError</span><span class="p">(</span><span class="n">statename</span><span class="p">)</span>
</span><span id="row-372"><span class="lineno"> 372 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">statename</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
</span><span id="row-373"><span class="lineno"> 373 </span>
</span><span id="row-374"><span class="lineno"> 374 </span>    <span class="k">def</span> <span class="nf">add_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_classes</span><span class="p">):</span>
</span><span id="row-375"><span class="lineno"> 375 </span>        <span class="sd">"""</span>
</span><span id="row-376"><span class="lineno"> 376 </span><span class="sd">        Add `state_classes` (a list of `State` subclasses).</span>
</span><span id="row-377"><span class="lineno"> 377 </span><span class="sd">        """</span>
</span><span id="row-378"><span class="lineno"> 378 </span>        <span class="k">for</span> <span class="n">state_class</span> <span class="ow">in</span> <span class="n">state_classes</span><span class="p">:</span>
</span><span id="row-379"><span class="lineno"> 379 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">state_class</span><span class="p">)</span>
</span><span id="row-380"><span class="lineno"> 380 </span>
</span><span id="row-381"><span class="lineno"> 381 </span>    <span class="k">def</span> <span class="nf">runtime_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-382"><span class="lineno"> 382 </span>        <span class="sd">"""</span>
</span><span id="row-383"><span class="lineno"> 383 </span><span class="sd">        Initialize `self.states`.</span>
</span><span id="row-384"><span class="lineno"> 384 </span><span class="sd">        """</span>
</span><span id="row-385"><span class="lineno"> 385 </span>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="row-386"><span class="lineno"> 386 </span>            <span class="n">state</span><span class="o">.</span><span class="n">runtime_init</span><span class="p">()</span>
</span><span id="row-387"><span class="lineno"> 387 </span>
</span><span id="row-388"><span class="lineno"> 388 </span>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-389"><span class="lineno"> 389 </span>        <span class="sd">"""Report error details."""</span>
</span><span id="row-390"><span class="lineno"> 390 </span>        <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">_exception_data</span><span class="p">()</span>
</span><span id="row-391"><span class="lineno"> 391 </span>        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="sa">u</span><span class="s1">'</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="row-392"><span class="lineno"> 392 </span>        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="s1">'input line </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_line_number</span><span class="p">())</span>
</span><span id="row-393"><span class="lineno"> 393 </span>        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">,</span> <span class="p">(</span><span class="sa">u</span><span class="s1">'module </span><span class="si">%s</span><span class="s1">, line </span><span class="si">%s</span><span class="s1">, function </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span>
</span><span id="row-394"><span class="lineno"> 394 </span>                               <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">function</span><span class="p">))</span>
</span><span id="row-395"><span class="lineno"> 395 </span>
</span><span id="row-396"><span class="lineno"> 396 </span>    <span class="k">def</span> <span class="nf">attach_observer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="p">):</span>
</span><span id="row-397"><span class="lineno"> 397 </span>        <span class="sd">"""</span>
</span><span id="row-398"><span class="lineno"> 398 </span><span class="sd">        The `observer` parameter is a function or bound method which takes two</span>
</span><span id="row-399"><span class="lineno"> 399 </span><span class="sd">        arguments, the source and offset of the current line.</span>
</span><span id="row-400"><span class="lineno"> 400 </span><span class="sd">        """</span>
</span><span id="row-401"><span class="lineno"> 401 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span id="row-402"><span class="lineno"> 402 </span>
</span><span id="row-403"><span class="lineno"> 403 </span>    <span class="k">def</span> <span class="nf">detach_observer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="p">):</span>
</span><span id="row-404"><span class="lineno"> 404 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span id="row-405"><span class="lineno"> 405 </span>
</span><span id="row-406"><span class="lineno"> 406 </span>    <span class="k">def</span> <span class="nf">notify_observers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-407"><span class="lineno"> 407 </span>        <span class="k">for</span> <span class="n">observer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observers</span><span class="p">:</span>
</span><span id="row-408"><span class="lineno"> 408 </span>            <span class="k">try</span><span class="p">:</span>
</span><span id="row-409"><span class="lineno"> 409 </span>                <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">)</span>
</span><span id="row-410"><span class="lineno"> 410 </span>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-411"><span class="lineno"> 411 </span>                <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span id="row-412"><span class="lineno"> 412 </span>            <span class="n">observer</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
</span><span id="row-413"><span class="lineno"> 413 </span>
</span><span id="row-414"><span class="lineno"> 414 </span>
</span><span id="row-415"><span class="lineno"> 415 </span><span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
</span><span id="row-416"><span class="lineno"> 416 </span>
</span><span id="row-417"><span class="lineno"> 417 </span>    <span class="sd">"""</span>
</span><span id="row-418"><span class="lineno"> 418 </span><span class="sd">    State superclass. Contains a list of transitions, and transition methods.</span>
</span><span id="row-419"><span class="lineno"> 419 </span>
</span><span id="row-420"><span class="lineno"> 420 </span><span class="sd">    Transition methods all have the same signature. They take 3 parameters:</span>
</span><span id="row-421"><span class="lineno"> 421 </span>
</span><span id="row-422"><span class="lineno"> 422 </span><span class="sd">    - An `re` match object. ``match.string`` contains the matched input line,</span>
</span><span id="row-423"><span class="lineno"> 423 </span><span class="sd">      ``match.start()`` gives the start index of the match, and</span>
</span><span id="row-424"><span class="lineno"> 424 </span><span class="sd">      ``match.end()`` gives the end index.</span>
</span><span id="row-425"><span class="lineno"> 425 </span><span class="sd">    - A context object, whose meaning is application-defined (initial value</span>
</span><span id="row-426"><span class="lineno"> 426 </span><span class="sd">      ``None``). It can be used to store any information required by the state</span>
</span><span id="row-427"><span class="lineno"> 427 </span><span class="sd">      machine, and the retured context is passed on to the next transition</span>
</span><span id="row-428"><span class="lineno"> 428 </span><span class="sd">      method unchanged.</span>
</span><span id="row-429"><span class="lineno"> 429 </span><span class="sd">    - The name of the next state, a string, taken from the transitions list;</span>
</span><span id="row-430"><span class="lineno"> 430 </span><span class="sd">      normally it is returned unchanged, but it may be altered by the</span>
</span><span id="row-431"><span class="lineno"> 431 </span><span class="sd">      transition method if necessary.</span>
</span><span id="row-432"><span class="lineno"> 432 </span>
</span><span id="row-433"><span class="lineno"> 433 </span><span class="sd">    Transition methods all return a 3-tuple:</span>
</span><span id="row-434"><span class="lineno"> 434 </span>
</span><span id="row-435"><span class="lineno"> 435 </span><span class="sd">    - A context object, as (potentially) modified by the transition method.</span>
</span><span id="row-436"><span class="lineno"> 436 </span><span class="sd">    - The next state name (a return value of ``None`` means no state change).</span>
</span><span id="row-437"><span class="lineno"> 437 </span><span class="sd">    - The processing result, a list, which is accumulated by the state</span>
</span><span id="row-438"><span class="lineno"> 438 </span><span class="sd">      machine.</span>
</span><span id="row-439"><span class="lineno"> 439 </span>
</span><span id="row-440"><span class="lineno"> 440 </span><span class="sd">    Transition methods may raise an `EOFError` to cut processing short.</span>
</span><span id="row-441"><span class="lineno"> 441 </span>
</span><span id="row-442"><span class="lineno"> 442 </span><span class="sd">    There are two implicit transitions, and corresponding transition methods</span>
</span><span id="row-443"><span class="lineno"> 443 </span><span class="sd">    are defined: `bof()` handles the beginning-of-file, and `eof()` handles</span>
</span><span id="row-444"><span class="lineno"> 444 </span><span class="sd">    the end-of-file. These methods have non-standard signatures and return</span>
</span><span id="row-445"><span class="lineno"> 445 </span><span class="sd">    values. `bof()` returns the initial context and results, and may be used</span>
</span><span id="row-446"><span class="lineno"> 446 </span><span class="sd">    to return a header string, or do any other processing needed. `eof()`</span>
</span><span id="row-447"><span class="lineno"> 447 </span><span class="sd">    should handle any remaining context and wrap things up; it returns the</span>
</span><span id="row-448"><span class="lineno"> 448 </span><span class="sd">    final processing result.</span>
</span><span id="row-449"><span class="lineno"> 449 </span>
</span><span id="row-450"><span class="lineno"> 450 </span><span class="sd">    Typical applications need only subclass `State` (or a subclass), set the</span>
</span><span id="row-451"><span class="lineno"> 451 </span><span class="sd">    `patterns` and `initial_transitions` class attributes, and provide</span>
</span><span id="row-452"><span class="lineno"> 452 </span><span class="sd">    corresponding transition methods. The default object initialization will</span>
</span><span id="row-453"><span class="lineno"> 453 </span><span class="sd">    take care of constructing the list of transitions.</span>
</span><span id="row-454"><span class="lineno"> 454 </span><span class="sd">    """</span>
</span><span id="row-455"><span class="lineno"> 455 </span>
</span><span id="row-456"><span class="lineno"> 456 </span>    <span class="n">patterns</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-457"><span class="lineno"> 457 </span>    <span class="sd">"""</span>
</span><span id="row-458"><span class="lineno"> 458 </span><span class="sd">    {Name: pattern} mapping, used by `make_transition()`. Each pattern may</span>
</span><span id="row-459"><span class="lineno"> 459 </span><span class="sd">    be a string or a compiled `re` pattern. Override in subclasses.</span>
</span><span id="row-460"><span class="lineno"> 460 </span><span class="sd">    """</span>
</span><span id="row-461"><span class="lineno"> 461 </span>
</span><span id="row-462"><span class="lineno"> 462 </span>    <span class="n">initial_transitions</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-463"><span class="lineno"> 463 </span>    <span class="sd">"""</span>
</span><span id="row-464"><span class="lineno"> 464 </span><span class="sd">    A list of transitions to initialize when a `State` is instantiated.</span>
</span><span id="row-465"><span class="lineno"> 465 </span><span class="sd">    Each entry is either a transition name string, or a (transition name, next</span>
</span><span id="row-466"><span class="lineno"> 466 </span><span class="sd">    state name) pair. See `make_transitions()`. Override in subclasses.</span>
</span><span id="row-467"><span class="lineno"> 467 </span><span class="sd">    """</span>
</span><span id="row-468"><span class="lineno"> 468 </span>
</span><span id="row-469"><span class="lineno"> 469 </span>    <span class="n">nested_sm</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-470"><span class="lineno"> 470 </span>    <span class="sd">"""</span>
</span><span id="row-471"><span class="lineno"> 471 </span><span class="sd">    The `StateMachine` class for handling nested processing.</span>
</span><span id="row-472"><span class="lineno"> 472 </span>
</span><span id="row-473"><span class="lineno"> 473 </span><span class="sd">    If left as ``None``, `nested_sm` defaults to the class of the state's</span>
</span><span id="row-474"><span class="lineno"> 474 </span><span class="sd">    controlling state machine. Override it in subclasses to avoid the default.</span>
</span><span id="row-475"><span class="lineno"> 475 </span><span class="sd">    """</span>
</span><span id="row-476"><span class="lineno"> 476 </span>
</span><span id="row-477"><span class="lineno"> 477 </span>    <span class="n">nested_sm_kwargs</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-478"><span class="lineno"> 478 </span>    <span class="sd">"""</span>
</span><span id="row-479"><span class="lineno"> 479 </span><span class="sd">    Keyword arguments dictionary, passed to the `nested_sm` constructor.</span>
</span><span id="row-480"><span class="lineno"> 480 </span>
</span><span id="row-481"><span class="lineno"> 481 </span><span class="sd">    Two keys must have entries in the dictionary:</span>
</span><span id="row-482"><span class="lineno"> 482 </span>
</span><span id="row-483"><span class="lineno"> 483 </span><span class="sd">    - Key 'state_classes' must be set to a list of `State` classes.</span>
</span><span id="row-484"><span class="lineno"> 484 </span><span class="sd">    - Key 'initial_state' must be set to the name of the initial state class.</span>
</span><span id="row-485"><span class="lineno"> 485 </span>
</span><span id="row-486"><span class="lineno"> 486 </span><span class="sd">    If `nested_sm_kwargs` is left as ``None``, 'state_classes' defaults to the</span>
</span><span id="row-487"><span class="lineno"> 487 </span><span class="sd">    class of the current state, and 'initial_state' defaults to the name of</span>
</span><span id="row-488"><span class="lineno"> 488 </span><span class="sd">    the class of the current state. Override in subclasses to avoid the</span>
</span><span id="row-489"><span class="lineno"> 489 </span><span class="sd">    defaults.</span>
</span><span id="row-490"><span class="lineno"> 490 </span><span class="sd">    """</span>
</span><span id="row-491"><span class="lineno"> 491 </span>
</span><span id="row-492"><span class="lineno"> 492 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-493"><span class="lineno"> 493 </span>        <span class="sd">"""</span>
</span><span id="row-494"><span class="lineno"> 494 </span><span class="sd">        Initialize a `State` object; make &amp; add initial transitions.</span>
</span><span id="row-495"><span class="lineno"> 495 </span>
</span><span id="row-496"><span class="lineno"> 496 </span><span class="sd">        Parameters:</span>
</span><span id="row-497"><span class="lineno"> 497 </span>
</span><span id="row-498"><span class="lineno"> 498 </span><span class="sd">        - `statemachine`: the controlling `StateMachine` object.</span>
</span><span id="row-499"><span class="lineno"> 499 </span><span class="sd">        - `debug`: a boolean; produce verbose output if true.</span>
</span><span id="row-500"><span class="lineno"> 500 </span><span class="sd">        """</span>
</span><span id="row-501"><span class="lineno"> 501 </span>
</span><span id="row-502"><span class="lineno"> 502 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transition_order</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-503"><span class="lineno"> 503 </span>        <span class="sd">"""A list of transition names in search order."""</span>
</span><span id="row-504"><span class="lineno"> 504 </span>
</span><span id="row-505"><span class="lineno"> 505 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="row-506"><span class="lineno"> 506 </span>        <span class="sd">"""</span>
</span><span id="row-507"><span class="lineno"> 507 </span><span class="sd">        A mapping of transition names to 3-tuples containing</span>
</span><span id="row-508"><span class="lineno"> 508 </span><span class="sd">        (compiled_pattern, transition_method, next_state_name). Initialized as</span>
</span><span id="row-509"><span class="lineno"> 509 </span><span class="sd">        an instance attribute dynamically (instead of as a class attribute)</span>
</span><span id="row-510"><span class="lineno"> 510 </span><span class="sd">        because it may make forward references to patterns and methods in this</span>
</span><span id="row-511"><span class="lineno"> 511 </span><span class="sd">        or other classes.</span>
</span><span id="row-512"><span class="lineno"> 512 </span><span class="sd">        """</span>
</span><span id="row-513"><span class="lineno"> 513 </span>
</span><span id="row-514"><span class="lineno"> 514 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_initial_transitions</span><span class="p">()</span>
</span><span id="row-515"><span class="lineno"> 515 </span>
</span><span id="row-516"><span class="lineno"> 516 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="n">state_machine</span>
</span><span id="row-517"><span class="lineno"> 517 </span>        <span class="sd">"""A reference to the controlling `StateMachine` object."""</span>
</span><span id="row-518"><span class="lineno"> 518 </span>
</span><span id="row-519"><span class="lineno"> 519 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="row-520"><span class="lineno"> 520 </span>        <span class="sd">"""Debugging mode on/off."""</span>
</span><span id="row-521"><span class="lineno"> 521 </span>
</span><span id="row-522"><span class="lineno"> 522 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-523"><span class="lineno"> 523 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="vm">__class__</span>
</span><span id="row-524"><span class="lineno"> 524 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-525"><span class="lineno"> 525 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_classes'</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">],</span>
</span><span id="row-526"><span class="lineno"> 526 </span>                                     <span class="s1">'initial_state'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
</span><span id="row-527"><span class="lineno"> 527 </span>
</span><span id="row-528"><span class="lineno"> 528 </span>    <span class="k">def</span> <span class="nf">runtime_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-529"><span class="lineno"> 529 </span>        <span class="sd">"""</span>
</span><span id="row-530"><span class="lineno"> 530 </span><span class="sd">        Initialize this `State` before running the state machine; called from</span>
</span><span id="row-531"><span class="lineno"> 531 </span><span class="sd">        `self.state_machine.run()`.</span>
</span><span id="row-532"><span class="lineno"> 532 </span><span class="sd">        """</span>
</span><span id="row-533"><span class="lineno"> 533 </span>        <span class="k">pass</span>
</span><span id="row-534"><span class="lineno"> 534 </span>
</span><span id="row-535"><span class="lineno"> 535 </span>    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-536"><span class="lineno"> 536 </span>        <span class="sd">"""Remove circular references to objects no longer required."""</span>
</span><span id="row-537"><span class="lineno"> 537 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-538"><span class="lineno"> 538 </span>
</span><span id="row-539"><span class="lineno"> 539 </span>    <span class="k">def</span> <span class="nf">add_initial_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-540"><span class="lineno"> 540 </span>        <span class="sd">"""Make and add transitions listed in `self.initial_transitions`."""</span>
</span><span id="row-541"><span class="lineno"> 541 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_transitions</span><span class="p">:</span>
</span><span id="row-542"><span class="lineno"> 542 </span>            <span class="n">names</span><span class="p">,</span> <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_transitions</span><span class="p">(</span>
</span><span id="row-543"><span class="lineno"> 543 </span>                  <span class="bp">self</span><span class="o">.</span><span class="n">initial_transitions</span><span class="p">)</span>
</span><span id="row-544"><span class="lineno"> 544 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">add_transitions</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
</span><span id="row-545"><span class="lineno"> 545 </span>
</span><span id="row-546"><span class="lineno"> 546 </span>    <span class="k">def</span> <span class="nf">add_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
</span><span id="row-547"><span class="lineno"> 547 </span>        <span class="sd">"""</span>
</span><span id="row-548"><span class="lineno"> 548 </span><span class="sd">        Add a list of transitions to the start of the transition list.</span>
</span><span id="row-549"><span class="lineno"> 549 </span>
</span><span id="row-550"><span class="lineno"> 550 </span><span class="sd">        Parameters:</span>
</span><span id="row-551"><span class="lineno"> 551 </span>
</span><span id="row-552"><span class="lineno"> 552 </span><span class="sd">        - `names`: a list of transition names.</span>
</span><span id="row-553"><span class="lineno"> 553 </span><span class="sd">        - `transitions`: a mapping of names to transition tuples.</span>
</span><span id="row-554"><span class="lineno"> 554 </span>
</span><span id="row-555"><span class="lineno"> 555 </span><span class="sd">        Exceptions: `DuplicateTransitionError`, `UnknownTransitionError`.</span>
</span><span id="row-556"><span class="lineno"> 556 </span><span class="sd">        """</span>
</span><span id="row-557"><span class="lineno"> 557 </span>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
</span><span id="row-558"><span class="lineno"> 558 </span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
</span><span id="row-559"><span class="lineno"> 559 </span>                <span class="k">raise</span> <span class="n">DuplicateTransitionError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-560"><span class="lineno"> 560 </span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
</span><span id="row-561"><span class="lineno"> 561 </span>                <span class="k">raise</span> <span class="n">UnknownTransitionError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-562"><span class="lineno"> 562 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transition_order</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
</span><span id="row-563"><span class="lineno"> 563 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
</span><span id="row-564"><span class="lineno"> 564 </span>
</span><span id="row-565"><span class="lineno"> 565 </span>    <span class="k">def</span> <span class="nf">add_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transition</span><span class="p">):</span>
</span><span id="row-566"><span class="lineno"> 566 </span>        <span class="sd">"""</span>
</span><span id="row-567"><span class="lineno"> 567 </span><span class="sd">        Add a transition to the start of the transition list.</span>
</span><span id="row-568"><span class="lineno"> 568 </span>
</span><span id="row-569"><span class="lineno"> 569 </span><span class="sd">        Parameter `transition`: a ready-made transition 3-tuple.</span>
</span><span id="row-570"><span class="lineno"> 570 </span>
</span><span id="row-571"><span class="lineno"> 571 </span><span class="sd">        Exception: `DuplicateTransitionError`.</span>
</span><span id="row-572"><span class="lineno"> 572 </span><span class="sd">        """</span>
</span><span id="row-573"><span class="lineno"> 573 </span>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
</span><span id="row-574"><span class="lineno"> 574 </span>            <span class="k">raise</span> <span class="n">DuplicateTransitionError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-575"><span class="lineno"> 575 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transition_order</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="row-576"><span class="lineno"> 576 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span>
</span><span id="row-577"><span class="lineno"> 577 </span>
</span><span id="row-578"><span class="lineno"> 578 </span>    <span class="k">def</span> <span class="nf">remove_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="row-579"><span class="lineno"> 579 </span>        <span class="sd">"""</span>
</span><span id="row-580"><span class="lineno"> 580 </span><span class="sd">        Remove a transition by `name`.</span>
</span><span id="row-581"><span class="lineno"> 581 </span>
</span><span id="row-582"><span class="lineno"> 582 </span><span class="sd">        Exception: `UnknownTransitionError`.</span>
</span><span id="row-583"><span class="lineno"> 583 </span><span class="sd">        """</span>
</span><span id="row-584"><span class="lineno"> 584 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-585"><span class="lineno"> 585 </span>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="row-586"><span class="lineno"> 586 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">transition_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-587"><span class="lineno"> 587 </span>        <span class="k">except</span><span class="p">:</span>
</span><span id="row-588"><span class="lineno"> 588 </span>            <span class="k">raise</span> <span class="n">UnknownTransitionError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="row-589"><span class="lineno"> 589 </span>
</span><span id="row-590"><span class="lineno"> 590 </span>    <span class="k">def</span> <span class="nf">make_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-591"><span class="lineno"> 591 </span>        <span class="sd">"""</span>
</span><span id="row-592"><span class="lineno"> 592 </span><span class="sd">        Make &amp; return a transition tuple based on `name`.</span>
</span><span id="row-593"><span class="lineno"> 593 </span>
</span><span id="row-594"><span class="lineno"> 594 </span><span class="sd">        This is a convenience function to simplify transition creation.</span>
</span><span id="row-595"><span class="lineno"> 595 </span>
</span><span id="row-596"><span class="lineno"> 596 </span><span class="sd">        Parameters:</span>
</span><span id="row-597"><span class="lineno"> 597 </span>
</span><span id="row-598"><span class="lineno"> 598 </span><span class="sd">        - `name`: a string, the name of the transition pattern &amp; method. This</span>
</span><span id="row-599"><span class="lineno"> 599 </span><span class="sd">          `State` object must have a method called '`name`', and a dictionary</span>
</span><span id="row-600"><span class="lineno"> 600 </span><span class="sd">          `self.patterns` containing a key '`name`'.</span>
</span><span id="row-601"><span class="lineno"> 601 </span><span class="sd">        - `next_state`: a string, the name of the next `State` object for this</span>
</span><span id="row-602"><span class="lineno"> 602 </span><span class="sd">          transition. A value of ``None`` (or absent) implies no state change</span>
</span><span id="row-603"><span class="lineno"> 603 </span><span class="sd">          (i.e., continue with the same state).</span>
</span><span id="row-604"><span class="lineno"> 604 </span>
</span><span id="row-605"><span class="lineno"> 605 </span><span class="sd">        Exceptions: `TransitionPatternNotFound`, `TransitionMethodNotFound`.</span>
</span><span id="row-606"><span class="lineno"> 606 </span><span class="sd">        """</span>
</span><span id="row-607"><span class="lineno"> 607 </span>        <span class="k">if</span> <span class="n">next_state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-608"><span class="lineno"> 608 </span>            <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="row-609"><span class="lineno"> 609 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-610"><span class="lineno"> 610 </span>            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="row-611"><span class="lineno"> 611 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s1">'match'</span><span class="p">):</span>
</span><span id="row-612"><span class="lineno"> 612 </span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span><span id="row-613"><span class="lineno"> 613 </span>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="row-614"><span class="lineno"> 614 </span>            <span class="k">raise</span> <span class="n">TransitionPatternNotFound</span><span class="p">(</span>
</span><span id="row-615"><span class="lineno"> 615 </span>                  <span class="s1">'</span><span class="si">%s</span><span class="s1">.patterns[</span><span class="si">%r</span><span class="s1">]'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="row-616"><span class="lineno"> 616 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-617"><span class="lineno"> 617 </span>            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="row-618"><span class="lineno"> 618 </span>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="row-619"><span class="lineno"> 619 </span>            <span class="k">raise</span> <span class="n">TransitionMethodNotFound</span><span class="p">(</span>
</span><span id="row-620"><span class="lineno"> 620 </span>                  <span class="s1">'</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="row-621"><span class="lineno"> 621 </span>        <span class="k">return</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>
</span><span id="row-622"><span class="lineno"> 622 </span>
</span><span id="row-623"><span class="lineno"> 623 </span>    <span class="k">def</span> <span class="nf">make_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
</span><span id="row-624"><span class="lineno"> 624 </span>        <span class="sd">"""</span>
</span><span id="row-625"><span class="lineno"> 625 </span><span class="sd">        Return a list of transition names and a transition mapping.</span>
</span><span id="row-626"><span class="lineno"> 626 </span>
</span><span id="row-627"><span class="lineno"> 627 </span><span class="sd">        Parameter `name_list`: a list, where each entry is either a transition</span>
</span><span id="row-628"><span class="lineno"> 628 </span><span class="sd">        name string, or a 1- or 2-tuple (transition name, optional next state</span>
</span><span id="row-629"><span class="lineno"> 629 </span><span class="sd">        name).</span>
</span><span id="row-630"><span class="lineno"> 630 </span><span class="sd">        """</span>
</span><span id="row-631"><span class="lineno"> 631 </span>        <span class="n">stringtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
</span><span id="row-632"><span class="lineno"> 632 </span>        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-633"><span class="lineno"> 633 </span>        <span class="n">transitions</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="row-634"><span class="lineno"> 634 </span>        <span class="k">for</span> <span class="n">namestate</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
</span><span id="row-635"><span class="lineno"> 635 </span>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">namestate</span><span class="p">)</span> <span class="ow">is</span> <span class="n">stringtype</span><span class="p">:</span>
</span><span id="row-636"><span class="lineno"> 636 </span>                <span class="n">transitions</span><span class="p">[</span><span class="n">namestate</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_transition</span><span class="p">(</span><span class="n">namestate</span><span class="p">)</span>
</span><span id="row-637"><span class="lineno"> 637 </span>                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namestate</span><span class="p">)</span>
</span><span id="row-638"><span class="lineno"> 638 </span>            <span class="k">else</span><span class="p">:</span>
</span><span id="row-639"><span class="lineno"> 639 </span>                <span class="n">transitions</span><span class="p">[</span><span class="n">namestate</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_transition</span><span class="p">(</span><span class="o">*</span><span class="n">namestate</span><span class="p">)</span>
</span><span id="row-640"><span class="lineno"> 640 </span>                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namestate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="row-641"><span class="lineno"> 641 </span>        <span class="k">return</span> <span class="n">names</span><span class="p">,</span> <span class="n">transitions</span>
</span><span id="row-642"><span class="lineno"> 642 </span>
</span><span id="row-643"><span class="lineno"> 643 </span>    <span class="k">def</span> <span class="nf">no_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
</span><span id="row-644"><span class="lineno"> 644 </span>        <span class="sd">"""</span>
</span><span id="row-645"><span class="lineno"> 645 </span><span class="sd">        Called when there is no match from `StateMachine.check_line()`.</span>
</span><span id="row-646"><span class="lineno"> 646 </span>
</span><span id="row-647"><span class="lineno"> 647 </span><span class="sd">        Return the same values returned by transition methods:</span>
</span><span id="row-648"><span class="lineno"> 648 </span>
</span><span id="row-649"><span class="lineno"> 649 </span><span class="sd">        - context: unchanged;</span>
</span><span id="row-650"><span class="lineno"> 650 </span><span class="sd">        - next state name: ``None``;</span>
</span><span id="row-651"><span class="lineno"> 651 </span><span class="sd">        - empty result list.</span>
</span><span id="row-652"><span class="lineno"> 652 </span>
</span><span id="row-653"><span class="lineno"> 653 </span><span class="sd">        Override in subclasses to catch this event.</span>
</span><span id="row-654"><span class="lineno"> 654 </span><span class="sd">        """</span>
</span><span id="row-655"><span class="lineno"> 655 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[]</span>
</span><span id="row-656"><span class="lineno"> 656 </span>
</span><span id="row-657"><span class="lineno"> 657 </span>    <span class="k">def</span> <span class="nf">bof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span id="row-658"><span class="lineno"> 658 </span>        <span class="sd">"""</span>
</span><span id="row-659"><span class="lineno"> 659 </span><span class="sd">        Handle beginning-of-file. Return unchanged `context`, empty result.</span>
</span><span id="row-660"><span class="lineno"> 660 </span>
</span><span id="row-661"><span class="lineno"> 661 </span><span class="sd">        Override in subclasses.</span>
</span><span id="row-662"><span class="lineno"> 662 </span>
</span><span id="row-663"><span class="lineno"> 663 </span><span class="sd">        Parameter `context`: application-defined storage.</span>
</span><span id="row-664"><span class="lineno"> 664 </span><span class="sd">        """</span>
</span><span id="row-665"><span class="lineno"> 665 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="p">[]</span>
</span><span id="row-666"><span class="lineno"> 666 </span>
</span><span id="row-667"><span class="lineno"> 667 </span>    <span class="k">def</span> <span class="nf">eof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span id="row-668"><span class="lineno"> 668 </span>        <span class="sd">"""</span>
</span><span id="row-669"><span class="lineno"> 669 </span><span class="sd">        Handle end-of-file. Return empty result.</span>
</span><span id="row-670"><span class="lineno"> 670 </span>
</span><span id="row-671"><span class="lineno"> 671 </span><span class="sd">        Override in subclasses.</span>
</span><span id="row-672"><span class="lineno"> 672 </span>
</span><span id="row-673"><span class="lineno"> 673 </span><span class="sd">        Parameter `context`: application-defined storage.</span>
</span><span id="row-674"><span class="lineno"> 674 </span><span class="sd">        """</span>
</span><span id="row-675"><span class="lineno"> 675 </span>        <span class="k">return</span> <span class="p">[]</span>
</span><span id="row-676"><span class="lineno"> 676 </span>
</span><span id="row-677"><span class="lineno"> 677 </span>    <span class="k">def</span> <span class="nf">nop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
</span><span id="row-678"><span class="lineno"> 678 </span>        <span class="sd">"""</span>
</span><span id="row-679"><span class="lineno"> 679 </span><span class="sd">        A "do nothing" transition method.</span>
</span><span id="row-680"><span class="lineno"> 680 </span>
</span><span id="row-681"><span class="lineno"> 681 </span><span class="sd">        Return unchanged `context` &amp; `next_state`, empty result. Useful for</span>
</span><span id="row-682"><span class="lineno"> 682 </span><span class="sd">        simple state changes (actionless transitions).</span>
</span><span id="row-683"><span class="lineno"> 683 </span><span class="sd">        """</span>
</span><span id="row-684"><span class="lineno"> 684 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="p">[]</span>
</span><span id="row-685"><span class="lineno"> 685 </span>
</span><span id="row-686"><span class="lineno"> 686 </span>
</span><span id="row-687"><span class="lineno"> 687 </span><span class="k">class</span> <span class="nc">StateMachineWS</span><span class="p">(</span><span class="n">StateMachine</span><span class="p">):</span>
</span><span id="row-688"><span class="lineno"> 688 </span>
</span><span id="row-689"><span class="lineno"> 689 </span>    <span class="sd">"""</span>
</span><span id="row-690"><span class="lineno"> 690 </span><span class="sd">    `StateMachine` subclass specialized for whitespace recognition.</span>
</span><span id="row-691"><span class="lineno"> 691 </span>
</span><span id="row-692"><span class="lineno"> 692 </span><span class="sd">    There are three methods provided for extracting indented text blocks:</span>
</span><span id="row-693"><span class="lineno"> 693 </span>
</span><span id="row-694"><span class="lineno"> 694 </span><span class="sd">    - `get_indented()`: use when the indent is unknown.</span>
</span><span id="row-695"><span class="lineno"> 695 </span><span class="sd">    - `get_known_indented()`: use when the indent is known for all lines.</span>
</span><span id="row-696"><span class="lineno"> 696 </span><span class="sd">    - `get_first_known_indented()`: use when only the first line's indent is</span>
</span><span id="row-697"><span class="lineno"> 697 </span><span class="sd">      known.</span>
</span><span id="row-698"><span class="lineno"> 698 </span><span class="sd">    """</span>
</span><span id="row-699"><span class="lineno"> 699 </span>
</span><span id="row-700"><span class="lineno"> 700 </span>    <span class="k">def</span> <span class="nf">get_indented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">until_blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">strip_indent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span id="row-701"><span class="lineno"> 701 </span>        <span class="sd">"""</span>
</span><span id="row-702"><span class="lineno"> 702 </span><span class="sd">        Return a block of indented lines of text, and info.</span>
</span><span id="row-703"><span class="lineno"> 703 </span>
</span><span id="row-704"><span class="lineno"> 704 </span><span class="sd">        Extract an indented block where the indent is unknown for all lines.</span>
</span><span id="row-705"><span class="lineno"> 705 </span>
</span><span id="row-706"><span class="lineno"> 706 </span><span class="sd">        :Parameters:</span>
</span><span id="row-707"><span class="lineno"> 707 </span><span class="sd">            - `until_blank`: Stop collecting at the first blank line if true.</span>
</span><span id="row-708"><span class="lineno"> 708 </span><span class="sd">            - `strip_indent`: Strip common leading indent if true (default).</span>
</span><span id="row-709"><span class="lineno"> 709 </span>
</span><span id="row-710"><span class="lineno"> 710 </span><span class="sd">        :Return:</span>
</span><span id="row-711"><span class="lineno"> 711 </span><span class="sd">            - the indented block (a list of lines of text),</span>
</span><span id="row-712"><span class="lineno"> 712 </span><span class="sd">            - its indent,</span>
</span><span id="row-713"><span class="lineno"> 713 </span><span class="sd">            - its first line offset from BOF, and</span>
</span><span id="row-714"><span class="lineno"> 714 </span><span class="sd">            - whether or not it finished with a blank line.</span>
</span><span id="row-715"><span class="lineno"> 715 </span><span class="sd">        """</span>
</span><span id="row-716"><span class="lineno"> 716 </span>        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_line_offset</span><span class="p">()</span>
</span><span id="row-717"><span class="lineno"> 717 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">get_indented</span><span class="p">(</span>
</span><span id="row-718"><span class="lineno"> 718 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">,</span> <span class="n">until_blank</span><span class="p">,</span> <span class="n">strip_indent</span><span class="p">)</span>
</span><span id="row-719"><span class="lineno"> 719 </span>        <span class="k">if</span> <span class="n">indented</span><span class="p">:</span>
</span><span id="row-720"><span class="lineno"> 720 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indented</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># advance to last indented line</span>
</span><span id="row-721"><span class="lineno"> 721 </span>        <span class="k">while</span> <span class="n">indented</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">indented</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="row-722"><span class="lineno"> 722 </span>            <span class="n">indented</span><span class="o">.</span><span class="n">trim_start</span><span class="p">()</span>
</span><span id="row-723"><span class="lineno"> 723 </span>            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-724"><span class="lineno"> 724 </span>        <span class="k">return</span> <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blank_finish</span>
</span><span id="row-725"><span class="lineno"> 725 </span>
</span><span id="row-726"><span class="lineno"> 726 </span>    <span class="k">def</span> <span class="nf">get_known_indented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">until_blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">strip_indent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span id="row-727"><span class="lineno"> 727 </span>        <span class="sd">"""</span>
</span><span id="row-728"><span class="lineno"> 728 </span><span class="sd">        Return an indented block and info.</span>
</span><span id="row-729"><span class="lineno"> 729 </span>
</span><span id="row-730"><span class="lineno"> 730 </span><span class="sd">        Extract an indented block where the indent is known for all lines.</span>
</span><span id="row-731"><span class="lineno"> 731 </span><span class="sd">        Starting with the current line, extract the entire text block with at</span>
</span><span id="row-732"><span class="lineno"> 732 </span><span class="sd">        least `indent` indentation (which must be whitespace, except for the</span>
</span><span id="row-733"><span class="lineno"> 733 </span><span class="sd">        first line).</span>
</span><span id="row-734"><span class="lineno"> 734 </span>
</span><span id="row-735"><span class="lineno"> 735 </span><span class="sd">        :Parameters:</span>
</span><span id="row-736"><span class="lineno"> 736 </span><span class="sd">            - `indent`: The number of indent columns/characters.</span>
</span><span id="row-737"><span class="lineno"> 737 </span><span class="sd">            - `until_blank`: Stop collecting at the first blank line if true.</span>
</span><span id="row-738"><span class="lineno"> 738 </span><span class="sd">            - `strip_indent`: Strip `indent` characters of indentation if true</span>
</span><span id="row-739"><span class="lineno"> 739 </span><span class="sd">              (default).</span>
</span><span id="row-740"><span class="lineno"> 740 </span>
</span><span id="row-741"><span class="lineno"> 741 </span><span class="sd">        :Return:</span>
</span><span id="row-742"><span class="lineno"> 742 </span><span class="sd">            - the indented block,</span>
</span><span id="row-743"><span class="lineno"> 743 </span><span class="sd">            - its first line offset from BOF, and</span>
</span><span id="row-744"><span class="lineno"> 744 </span><span class="sd">            - whether or not it finished with a blank line.</span>
</span><span id="row-745"><span class="lineno"> 745 </span><span class="sd">        """</span>
</span><span id="row-746"><span class="lineno"> 746 </span>        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_line_offset</span><span class="p">()</span>
</span><span id="row-747"><span class="lineno"> 747 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">get_indented</span><span class="p">(</span>
</span><span id="row-748"><span class="lineno"> 748 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">,</span> <span class="n">until_blank</span><span class="p">,</span> <span class="n">strip_indent</span><span class="p">,</span>
</span><span id="row-749"><span class="lineno"> 749 </span>              <span class="n">block_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
</span><span id="row-750"><span class="lineno"> 750 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indented</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># advance to last indented line</span>
</span><span id="row-751"><span class="lineno"> 751 </span>        <span class="k">while</span> <span class="n">indented</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">indented</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="row-752"><span class="lineno"> 752 </span>            <span class="n">indented</span><span class="o">.</span><span class="n">trim_start</span><span class="p">()</span>
</span><span id="row-753"><span class="lineno"> 753 </span>            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-754"><span class="lineno"> 754 </span>        <span class="k">return</span> <span class="n">indented</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blank_finish</span>
</span><span id="row-755"><span class="lineno"> 755 </span>
</span><span id="row-756"><span class="lineno"> 756 </span>    <span class="k">def</span> <span class="nf">get_first_known_indented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">until_blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span id="row-757"><span class="lineno"> 757 </span>                                 <span class="n">strip_indent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">strip_top</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span id="row-758"><span class="lineno"> 758 </span>        <span class="sd">"""</span>
</span><span id="row-759"><span class="lineno"> 759 </span><span class="sd">        Return an indented block and info.</span>
</span><span id="row-760"><span class="lineno"> 760 </span>
</span><span id="row-761"><span class="lineno"> 761 </span><span class="sd">        Extract an indented block where the indent is known for the first line</span>
</span><span id="row-762"><span class="lineno"> 762 </span><span class="sd">        and unknown for all other lines.</span>
</span><span id="row-763"><span class="lineno"> 763 </span>
</span><span id="row-764"><span class="lineno"> 764 </span><span class="sd">        :Parameters:</span>
</span><span id="row-765"><span class="lineno"> 765 </span><span class="sd">            - `indent`: The first line's indent (# of columns/characters).</span>
</span><span id="row-766"><span class="lineno"> 766 </span><span class="sd">            - `until_blank`: Stop collecting at the first blank line if true</span>
</span><span id="row-767"><span class="lineno"> 767 </span><span class="sd">              (1).</span>
</span><span id="row-768"><span class="lineno"> 768 </span><span class="sd">            - `strip_indent`: Strip `indent` characters of indentation if true</span>
</span><span id="row-769"><span class="lineno"> 769 </span><span class="sd">              (1, default).</span>
</span><span id="row-770"><span class="lineno"> 770 </span><span class="sd">            - `strip_top`: Strip blank lines from the beginning of the block.</span>
</span><span id="row-771"><span class="lineno"> 771 </span>
</span><span id="row-772"><span class="lineno"> 772 </span><span class="sd">        :Return:</span>
</span><span id="row-773"><span class="lineno"> 773 </span><span class="sd">            - the indented block,</span>
</span><span id="row-774"><span class="lineno"> 774 </span><span class="sd">            - its indent,</span>
</span><span id="row-775"><span class="lineno"> 775 </span><span class="sd">            - its first line offset from BOF, and</span>
</span><span id="row-776"><span class="lineno"> 776 </span><span class="sd">            - whether or not it finished with a blank line.</span>
</span><span id="row-777"><span class="lineno"> 777 </span><span class="sd">        """</span>
</span><span id="row-778"><span class="lineno"> 778 </span>        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_line_offset</span><span class="p">()</span>
</span><span id="row-779"><span class="lineno"> 779 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">get_indented</span><span class="p">(</span>
</span><span id="row-780"><span class="lineno"> 780 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">line_offset</span><span class="p">,</span> <span class="n">until_blank</span><span class="p">,</span> <span class="n">strip_indent</span><span class="p">,</span>
</span><span id="row-781"><span class="lineno"> 781 </span>              <span class="n">first_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
</span><span id="row-782"><span class="lineno"> 782 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">next_line</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indented</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># advance to last indented line</span>
</span><span id="row-783"><span class="lineno"> 783 </span>        <span class="k">if</span> <span class="n">strip_top</span><span class="p">:</span>
</span><span id="row-784"><span class="lineno"> 784 </span>            <span class="k">while</span> <span class="n">indented</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">indented</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="row-785"><span class="lineno"> 785 </span>                <span class="n">indented</span><span class="o">.</span><span class="n">trim_start</span><span class="p">()</span>
</span><span id="row-786"><span class="lineno"> 786 </span>                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-787"><span class="lineno"> 787 </span>        <span class="k">return</span> <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blank_finish</span>
</span><span id="row-788"><span class="lineno"> 788 </span>
</span><span id="row-789"><span class="lineno"> 789 </span>
</span><span id="row-790"><span class="lineno"> 790 </span><span class="k">class</span> <span class="nc">StateWS</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
</span><span id="row-791"><span class="lineno"> 791 </span>
</span><span id="row-792"><span class="lineno"> 792 </span>    <span class="sd">"""</span>
</span><span id="row-793"><span class="lineno"> 793 </span><span class="sd">    State superclass specialized for whitespace (blank lines &amp; indents).</span>
</span><span id="row-794"><span class="lineno"> 794 </span>
</span><span id="row-795"><span class="lineno"> 795 </span><span class="sd">    Use this class with `StateMachineWS`.  The transitions 'blank' (for blank</span>
</span><span id="row-796"><span class="lineno"> 796 </span><span class="sd">    lines) and 'indent' (for indented text blocks) are added automatically,</span>
</span><span id="row-797"><span class="lineno"> 797 </span><span class="sd">    before any other transitions.  The transition method `blank()` handles</span>
</span><span id="row-798"><span class="lineno"> 798 </span><span class="sd">    blank lines and `indent()` handles nested indented blocks.  Indented</span>
</span><span id="row-799"><span class="lineno"> 799 </span><span class="sd">    blocks trigger a new state machine to be created by `indent()` and run.</span>
</span><span id="row-800"><span class="lineno"> 800 </span><span class="sd">    The class of the state machine to be created is in `indent_sm`, and the</span>
</span><span id="row-801"><span class="lineno"> 801 </span><span class="sd">    constructor keyword arguments are in the dictionary `indent_sm_kwargs`.</span>
</span><span id="row-802"><span class="lineno"> 802 </span>
</span><span id="row-803"><span class="lineno"> 803 </span><span class="sd">    The methods `known_indent()` and `firstknown_indent()` are provided for</span>
</span><span id="row-804"><span class="lineno"> 804 </span><span class="sd">    indented blocks where the indent (all lines' and first line's only,</span>
</span><span id="row-805"><span class="lineno"> 805 </span><span class="sd">    respectively) is known to the transition method, along with the attributes</span>
</span><span id="row-806"><span class="lineno"> 806 </span><span class="sd">    `known_indent_sm` and `known_indent_sm_kwargs`.  Neither transition method</span>
</span><span id="row-807"><span class="lineno"> 807 </span><span class="sd">    is triggered automatically.</span>
</span><span id="row-808"><span class="lineno"> 808 </span><span class="sd">    """</span>
</span><span id="row-809"><span class="lineno"> 809 </span>
</span><span id="row-810"><span class="lineno"> 810 </span>    <span class="n">indent_sm</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-811"><span class="lineno"> 811 </span>    <span class="sd">"""</span>
</span><span id="row-812"><span class="lineno"> 812 </span><span class="sd">    The `StateMachine` class handling indented text blocks.</span>
</span><span id="row-813"><span class="lineno"> 813 </span>
</span><span id="row-814"><span class="lineno"> 814 </span><span class="sd">    If left as ``None``, `indent_sm` defaults to the value of</span>
</span><span id="row-815"><span class="lineno"> 815 </span><span class="sd">    `State.nested_sm`.  Override it in subclasses to avoid the default.</span>
</span><span id="row-816"><span class="lineno"> 816 </span><span class="sd">    """</span>
</span><span id="row-817"><span class="lineno"> 817 </span>
</span><span id="row-818"><span class="lineno"> 818 </span>    <span class="n">indent_sm_kwargs</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-819"><span class="lineno"> 819 </span>    <span class="sd">"""</span>
</span><span id="row-820"><span class="lineno"> 820 </span><span class="sd">    Keyword arguments dictionary, passed to the `indent_sm` constructor.</span>
</span><span id="row-821"><span class="lineno"> 821 </span>
</span><span id="row-822"><span class="lineno"> 822 </span><span class="sd">    If left as ``None``, `indent_sm_kwargs` defaults to the value of</span>
</span><span id="row-823"><span class="lineno"> 823 </span><span class="sd">    `State.nested_sm_kwargs`. Override it in subclasses to avoid the default.</span>
</span><span id="row-824"><span class="lineno"> 824 </span><span class="sd">    """</span>
</span><span id="row-825"><span class="lineno"> 825 </span>
</span><span id="row-826"><span class="lineno"> 826 </span>    <span class="n">known_indent_sm</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-827"><span class="lineno"> 827 </span>    <span class="sd">"""</span>
</span><span id="row-828"><span class="lineno"> 828 </span><span class="sd">    The `StateMachine` class handling known-indented text blocks.</span>
</span><span id="row-829"><span class="lineno"> 829 </span>
</span><span id="row-830"><span class="lineno"> 830 </span><span class="sd">    If left as ``None``, `known_indent_sm` defaults to the value of</span>
</span><span id="row-831"><span class="lineno"> 831 </span><span class="sd">    `indent_sm`.  Override it in subclasses to avoid the default.</span>
</span><span id="row-832"><span class="lineno"> 832 </span><span class="sd">    """</span>
</span><span id="row-833"><span class="lineno"> 833 </span>
</span><span id="row-834"><span class="lineno"> 834 </span>    <span class="n">known_indent_sm_kwargs</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-835"><span class="lineno"> 835 </span>    <span class="sd">"""</span>
</span><span id="row-836"><span class="lineno"> 836 </span><span class="sd">    Keyword arguments dictionary, passed to the `known_indent_sm` constructor.</span>
</span><span id="row-837"><span class="lineno"> 837 </span>
</span><span id="row-838"><span class="lineno"> 838 </span><span class="sd">    If left as ``None``, `known_indent_sm_kwargs` defaults to the value of</span>
</span><span id="row-839"><span class="lineno"> 839 </span><span class="sd">    `indent_sm_kwargs`. Override it in subclasses to avoid the default.</span>
</span><span id="row-840"><span class="lineno"> 840 </span><span class="sd">    """</span>
</span><span id="row-841"><span class="lineno"> 841 </span>
</span><span id="row-842"><span class="lineno"> 842 </span>    <span class="n">ws_patterns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'blank'</span><span class="p">:</span> <span class="s1">' *$'</span><span class="p">,</span>
</span><span id="row-843"><span class="lineno"> 843 </span>                   <span class="s1">'indent'</span><span class="p">:</span> <span class="s1">' +'</span><span class="p">}</span>
</span><span id="row-844"><span class="lineno"> 844 </span>    <span class="sd">"""Patterns for default whitespace transitions.  May be overridden in</span>
</span><span id="row-845"><span class="lineno"> 845 </span><span class="sd">    subclasses."""</span>
</span><span id="row-846"><span class="lineno"> 846 </span>
</span><span id="row-847"><span class="lineno"> 847 </span>    <span class="n">ws_initial_transitions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'blank'</span><span class="p">,</span> <span class="s1">'indent'</span><span class="p">)</span>
</span><span id="row-848"><span class="lineno"> 848 </span>    <span class="sd">"""Default initial whitespace transitions, added before those listed in</span>
</span><span id="row-849"><span class="lineno"> 849 </span><span class="sd">    `State.initial_transitions`.  May be overridden in subclasses."""</span>
</span><span id="row-850"><span class="lineno"> 850 </span>
</span><span id="row-851"><span class="lineno"> 851 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-852"><span class="lineno"> 852 </span>        <span class="sd">"""</span>
</span><span id="row-853"><span class="lineno"> 853 </span><span class="sd">        Initialize a `StateSM` object; extends `State.__init__()`.</span>
</span><span id="row-854"><span class="lineno"> 854 </span>
</span><span id="row-855"><span class="lineno"> 855 </span><span class="sd">        Check for indent state machine attributes, set defaults if not set.</span>
</span><span id="row-856"><span class="lineno"> 856 </span><span class="sd">        """</span>
</span><span id="row-857"><span class="lineno"> 857 </span>        <span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</span><span id="row-858"><span class="lineno"> 858 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-859"><span class="lineno"> 859 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm</span>
</span><span id="row-860"><span class="lineno"> 860 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-861"><span class="lineno"> 861 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_sm_kwargs</span>
</span><span id="row-862"><span class="lineno"> 862 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-863"><span class="lineno"> 863 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm</span>
</span><span id="row-864"><span class="lineno"> 864 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-865"><span class="lineno"> 865 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm_kwargs</span>
</span><span id="row-866"><span class="lineno"> 866 </span>
</span><span id="row-867"><span class="lineno"> 867 </span>    <span class="k">def</span> <span class="nf">add_initial_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-868"><span class="lineno"> 868 </span>        <span class="sd">"""</span>
</span><span id="row-869"><span class="lineno"> 869 </span><span class="sd">        Add whitespace-specific transitions before those defined in subclass.</span>
</span><span id="row-870"><span class="lineno"> 870 </span>
</span><span id="row-871"><span class="lineno"> 871 </span><span class="sd">        Extends `State.add_initial_transitions()`.</span>
</span><span id="row-872"><span class="lineno"> 872 </span><span class="sd">        """</span>
</span><span id="row-873"><span class="lineno"> 873 </span>        <span class="n">State</span><span class="o">.</span><span class="n">add_initial_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="row-874"><span class="lineno"> 874 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-875"><span class="lineno"> 875 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="row-876"><span class="lineno"> 876 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_patterns</span><span class="p">)</span>
</span><span id="row-877"><span class="lineno"> 877 </span>        <span class="n">names</span><span class="p">,</span> <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_transitions</span><span class="p">(</span>
</span><span id="row-878"><span class="lineno"> 878 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">ws_initial_transitions</span><span class="p">)</span>
</span><span id="row-879"><span class="lineno"> 879 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_transitions</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
</span><span id="row-880"><span class="lineno"> 880 </span>
</span><span id="row-881"><span class="lineno"> 881 </span>    <span class="k">def</span> <span class="nf">blank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
</span><span id="row-882"><span class="lineno"> 882 </span>        <span class="sd">"""Handle blank lines. Does nothing. Override in subclasses."""</span>
</span><span id="row-883"><span class="lineno"> 883 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nop</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>
</span><span id="row-884"><span class="lineno"> 884 </span>
</span><span id="row-885"><span class="lineno"> 885 </span>    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
</span><span id="row-886"><span class="lineno"> 886 </span>        <span class="sd">"""</span>
</span><span id="row-887"><span class="lineno"> 887 </span><span class="sd">        Handle an indented text block. Extend or override in subclasses.</span>
</span><span id="row-888"><span class="lineno"> 888 </span>
</span><span id="row-889"><span class="lineno"> 889 </span><span class="sd">        Recursively run the registered state machine for indented blocks</span>
</span><span id="row-890"><span class="lineno"> 890 </span><span class="sd">        (`self.indent_sm`).</span>
</span><span id="row-891"><span class="lineno"> 891 </span><span class="sd">        """</span>
</span><span id="row-892"><span class="lineno"> 892 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> \
</span><span id="row-893"><span class="lineno"> 893 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">get_indented</span><span class="p">()</span>
</span><span id="row-894"><span class="lineno"> 894 </span>        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_sm</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_sm_kwargs</span><span class="p">)</span>
</span><span id="row-895"><span class="lineno"> 895 </span>        <span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">indented</span><span class="p">,</span> <span class="n">input_offset</span><span class="o">=</span><span class="n">line_offset</span><span class="p">)</span>
</span><span id="row-896"><span class="lineno"> 896 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">results</span>
</span><span id="row-897"><span class="lineno"> 897 </span>
</span><span id="row-898"><span class="lineno"> 898 </span>    <span class="k">def</span> <span class="nf">known_indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
</span><span id="row-899"><span class="lineno"> 899 </span>        <span class="sd">"""</span>
</span><span id="row-900"><span class="lineno"> 900 </span><span class="sd">        Handle a known-indent text block. Extend or override in subclasses.</span>
</span><span id="row-901"><span class="lineno"> 901 </span>
</span><span id="row-902"><span class="lineno"> 902 </span><span class="sd">        Recursively run the registered state machine for known-indent indented</span>
</span><span id="row-903"><span class="lineno"> 903 </span><span class="sd">        blocks (`self.known_indent_sm`). The indent is the length of the</span>
</span><span id="row-904"><span class="lineno"> 904 </span><span class="sd">        match, ``match.end()``.</span>
</span><span id="row-905"><span class="lineno"> 905 </span><span class="sd">        """</span>
</span><span id="row-906"><span class="lineno"> 906 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> \
</span><span id="row-907"><span class="lineno"> 907 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">get_known_indented</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">())</span>
</span><span id="row-908"><span class="lineno"> 908 </span>        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
</span><span id="row-909"><span class="lineno"> 909 </span>                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm_kwargs</span><span class="p">)</span>
</span><span id="row-910"><span class="lineno"> 910 </span>        <span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">indented</span><span class="p">,</span> <span class="n">input_offset</span><span class="o">=</span><span class="n">line_offset</span><span class="p">)</span>
</span><span id="row-911"><span class="lineno"> 911 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">results</span>
</span><span id="row-912"><span class="lineno"> 912 </span>
</span><span id="row-913"><span class="lineno"> 913 </span>    <span class="k">def</span> <span class="nf">first_known_indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
</span><span id="row-914"><span class="lineno"> 914 </span>        <span class="sd">"""</span>
</span><span id="row-915"><span class="lineno"> 915 </span><span class="sd">        Handle an indented text block (first line's indent known).</span>
</span><span id="row-916"><span class="lineno"> 916 </span>
</span><span id="row-917"><span class="lineno"> 917 </span><span class="sd">        Extend or override in subclasses.</span>
</span><span id="row-918"><span class="lineno"> 918 </span>
</span><span id="row-919"><span class="lineno"> 919 </span><span class="sd">        Recursively run the registered state machine for known-indent indented</span>
</span><span id="row-920"><span class="lineno"> 920 </span><span class="sd">        blocks (`self.known_indent_sm`). The indent is the length of the</span>
</span><span id="row-921"><span class="lineno"> 921 </span><span class="sd">        match, ``match.end()``.</span>
</span><span id="row-922"><span class="lineno"> 922 </span><span class="sd">        """</span>
</span><span id="row-923"><span class="lineno"> 923 </span>        <span class="n">indented</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">,</span> <span class="n">blank_finish</span> <span class="o">=</span> \
</span><span id="row-924"><span class="lineno"> 924 </span>              <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">get_first_known_indented</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">())</span>
</span><span id="row-925"><span class="lineno"> 925 </span>        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
</span><span id="row-926"><span class="lineno"> 926 </span>                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">known_indent_sm_kwargs</span><span class="p">)</span>
</span><span id="row-927"><span class="lineno"> 927 </span>        <span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">indented</span><span class="p">,</span> <span class="n">input_offset</span><span class="o">=</span><span class="n">line_offset</span><span class="p">)</span>
</span><span id="row-928"><span class="lineno"> 928 </span>        <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">results</span>
</span><span id="row-929"><span class="lineno"> 929 </span>
</span><span id="row-930"><span class="lineno"> 930 </span>
</span><span id="row-931"><span class="lineno"> 931 </span><span class="k">class</span> <span class="nc">_SearchOverride</span><span class="p">:</span>
</span><span id="row-932"><span class="lineno"> 932 </span>
</span><span id="row-933"><span class="lineno"> 933 </span>    <span class="sd">"""</span>
</span><span id="row-934"><span class="lineno"> 934 </span><span class="sd">    Mix-in class to override `StateMachine` regular expression behavior.</span>
</span><span id="row-935"><span class="lineno"> 935 </span>
</span><span id="row-936"><span class="lineno"> 936 </span><span class="sd">    Changes regular expression matching, from the default `re.match()`</span>
</span><span id="row-937"><span class="lineno"> 937 </span><span class="sd">    (succeeds only if the pattern matches at the start of `self.line`) to</span>
</span><span id="row-938"><span class="lineno"> 938 </span><span class="sd">    `re.search()` (succeeds if the pattern matches anywhere in `self.line`).</span>
</span><span id="row-939"><span class="lineno"> 939 </span><span class="sd">    When subclassing a `StateMachine`, list this class **first** in the</span>
</span><span id="row-940"><span class="lineno"> 940 </span><span class="sd">    inheritance list of the class definition.</span>
</span><span id="row-941"><span class="lineno"> 941 </span><span class="sd">    """</span>
</span><span id="row-942"><span class="lineno"> 942 </span>
</span><span id="row-943"><span class="lineno"> 943 </span>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
</span><span id="row-944"><span class="lineno"> 944 </span>        <span class="sd">"""</span>
</span><span id="row-945"><span class="lineno"> 945 </span><span class="sd">        Return the result of a regular expression search.</span>
</span><span id="row-946"><span class="lineno"> 946 </span>
</span><span id="row-947"><span class="lineno"> 947 </span><span class="sd">        Overrides `StateMachine.match()`.</span>
</span><span id="row-948"><span class="lineno"> 948 </span>
</span><span id="row-949"><span class="lineno"> 949 </span><span class="sd">        Parameter `pattern`: `re` compiled regular expression.</span>
</span><span id="row-950"><span class="lineno"> 950 </span><span class="sd">        """</span>
</span><span id="row-951"><span class="lineno"> 951 </span>        <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
</span><span id="row-952"><span class="lineno"> 952 </span>
</span><span id="row-953"><span class="lineno"> 953 </span>
</span><span id="row-954"><span class="lineno"> 954 </span><span class="k">class</span> <span class="nc">SearchStateMachine</span><span class="p">(</span><span class="n">_SearchOverride</span><span class="p">,</span> <span class="n">StateMachine</span><span class="p">):</span>
</span><span id="row-955"><span class="lineno"> 955 </span>    <span class="sd">"""`StateMachine` which uses `re.search()` instead of `re.match()`."""</span>
</span><span id="row-956"><span class="lineno"> 956 </span>    <span class="k">pass</span>
</span><span id="row-957"><span class="lineno"> 957 </span>
</span><span id="row-958"><span class="lineno"> 958 </span>
</span><span id="row-959"><span class="lineno"> 959 </span><span class="k">class</span> <span class="nc">SearchStateMachineWS</span><span class="p">(</span><span class="n">_SearchOverride</span><span class="p">,</span> <span class="n">StateMachineWS</span><span class="p">):</span>
</span><span id="row-960"><span class="lineno"> 960 </span>    <span class="sd">"""`StateMachineWS` which uses `re.search()` instead of `re.match()`."""</span>
</span><span id="row-961"><span class="lineno"> 961 </span>    <span class="k">pass</span>
</span><span id="row-962"><span class="lineno"> 962 </span>
</span><span id="row-963"><span class="lineno"> 963 </span>
</span><span id="row-964"><span class="lineno"> 964 </span><span class="k">class</span> <span class="nc">ViewList</span><span class="p">:</span>
</span><span id="row-965"><span class="lineno"> 965 </span>
</span><span id="row-966"><span class="lineno"> 966 </span>    <span class="sd">"""</span>
</span><span id="row-967"><span class="lineno"> 967 </span><span class="sd">    List with extended functionality: slices of ViewList objects are child</span>
</span><span id="row-968"><span class="lineno"> 968 </span><span class="sd">    lists, linked to their parents. Changes made to a child list also affect</span>
</span><span id="row-969"><span class="lineno"> 969 </span><span class="sd">    the parent list.  A child list is effectively a "view" (in the SQL sense)</span>
</span><span id="row-970"><span class="lineno"> 970 </span><span class="sd">    of the parent list.  Changes to parent lists, however, do *not* affect</span>
</span><span id="row-971"><span class="lineno"> 971 </span><span class="sd">    active child lists.  If a parent list is changed, any active child lists</span>
</span><span id="row-972"><span class="lineno"> 972 </span><span class="sd">    should be recreated.</span>
</span><span id="row-973"><span class="lineno"> 973 </span>
</span><span id="row-974"><span class="lineno"> 974 </span><span class="sd">    The start and end of the slice can be trimmed using the `trim_start()` and</span>
</span><span id="row-975"><span class="lineno"> 975 </span><span class="sd">    `trim_end()` methods, without affecting the parent list.  The link between</span>
</span><span id="row-976"><span class="lineno"> 976 </span><span class="sd">    child and parent lists can be broken by calling `disconnect()` on the</span>
</span><span id="row-977"><span class="lineno"> 977 </span><span class="sd">    child list.</span>
</span><span id="row-978"><span class="lineno"> 978 </span>
</span><span id="row-979"><span class="lineno"> 979 </span><span class="sd">    Also, ViewList objects keep track of the source &amp; offset of each item.</span>
</span><span id="row-980"><span class="lineno"> 980 </span><span class="sd">    This information is accessible via the `source()`, `offset()`, and</span>
</span><span id="row-981"><span class="lineno"> 981 </span><span class="sd">    `info()` methods.</span>
</span><span id="row-982"><span class="lineno"> 982 </span><span class="sd">    """</span>
</span><span id="row-983"><span class="lineno"> 983 </span>
</span><span id="row-984"><span class="lineno"> 984 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initlist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span id="row-985"><span class="lineno"> 985 </span>                 <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_offset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-986"><span class="lineno"> 986 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-987"><span class="lineno"> 987 </span>        <span class="sd">"""The actual list of data, flattened from various sources."""</span>
</span><span id="row-988"><span class="lineno"> 988 </span>
</span><span id="row-989"><span class="lineno"> 989 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-990"><span class="lineno"> 990 </span>        <span class="sd">"""A list of (source, offset) pairs, same length as `self.data`: the</span>
</span><span id="row-991"><span class="lineno"> 991 </span><span class="sd">        source of each line and the offset of each line from the beginning of</span>
</span><span id="row-992"><span class="lineno"> 992 </span><span class="sd">        its source."""</span>
</span><span id="row-993"><span class="lineno"> 993 </span>
</span><span id="row-994"><span class="lineno"> 994 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="row-995"><span class="lineno"> 995 </span>        <span class="sd">"""The parent list."""</span>
</span><span id="row-996"><span class="lineno"> 996 </span>
</span><span id="row-997"><span class="lineno"> 997 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span> <span class="o">=</span> <span class="n">parent_offset</span>
</span><span id="row-998"><span class="lineno"> 998 </span>        <span class="sd">"""Offset of this list from the beginning of the parent list."""</span>
</span><span id="row-999"><span class="lineno"> 999 </span>
</span><span id="row-1000"><span class="lineno">1000 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initlist</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1001"><span class="lineno">1001 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">initlist</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
</span><span id="row-1002"><span class="lineno">1002 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">initlist</span><span class="o">.</span><span class="n">items</span><span class="p">[:]</span>
</span><span id="row-1003"><span class="lineno">1003 </span>        <span class="k">elif</span> <span class="n">initlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1004"><span class="lineno">1004 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initlist</span><span class="p">)</span>
</span><span id="row-1005"><span class="lineno">1005 </span>            <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
</span><span id="row-1006"><span class="lineno">1006 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>
</span><span id="row-1007"><span class="lineno">1007 </span>            <span class="k">else</span><span class="p">:</span>
</span><span id="row-1008"><span class="lineno">1008 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">source</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initlist</span><span class="p">))]</span>
</span><span id="row-1009"><span class="lineno">1009 </span>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">),</span> <span class="s1">'data mismatch'</span>
</span><span id="row-1010"><span class="lineno">1010 </span>
</span><span id="row-1011"><span class="lineno">1011 </span>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1012"><span class="lineno">1012 </span>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1013"><span class="lineno">1013 </span>
</span><span id="row-1014"><span class="lineno">1014 </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1015"><span class="lineno">1015 </span>        <span class="k">return</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">, items=</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="row-1016"><span class="lineno">1016 </span>                                     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</span><span id="row-1017"><span class="lineno">1017 </span>
</span><span id="row-1018"><span class="lineno">1018 </span>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1019"><span class="lineno">1019 </span>    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1020"><span class="lineno">1020 </span>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1021"><span class="lineno">1021 </span>    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1022"><span class="lineno">1022 </span>    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1023"><span class="lineno">1023 </span>    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="row-1024"><span class="lineno">1024 </span>    <span class="k">def</span> <span class="fm">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cast</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
</span><span id="row-1025"><span class="lineno">1025 </span>
</span><span id="row-1026"><span class="lineno">1026 </span>    <span class="k">def</span> <span class="nf">__cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="row-1027"><span class="lineno">1027 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1028"><span class="lineno">1028 </span>            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span>
</span><span id="row-1029"><span class="lineno">1029 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1030"><span class="lineno">1030 </span>            <span class="k">return</span> <span class="n">other</span>
</span><span id="row-1031"><span class="lineno">1031 </span>
</span><span id="row-1032"><span class="lineno">1032 </span>    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="row-1033"><span class="lineno">1033 </span>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1034"><span class="lineno">1034 </span>
</span><span id="row-1035"><span class="lineno">1035 </span>    <span class="c1"># The __getitem__()/__setitem__() methods check whether the index</span>
</span><span id="row-1036"><span class="lineno">1036 </span>    <span class="c1"># is a slice first, since indexing a native list with a slice object</span>
</span><span id="row-1037"><span class="lineno">1037 </span>    <span class="c1"># just works.</span>
</span><span id="row-1038"><span class="lineno">1038 </span>
</span><span id="row-1039"><span class="lineno">1039 </span>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="row-1040"><span class="lineno">1040 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">):</span>
</span><span id="row-1041"><span class="lineno">1041 </span>            <span class="k">assert</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="s1">'cannot handle slice with stride'</span>
</span><span id="row-1042"><span class="lineno">1042 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">],</span>
</span><span id="row-1043"><span class="lineno">1043 </span>                                  <span class="n">items</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">],</span>
</span><span id="row-1044"><span class="lineno">1044 </span>                                  <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_offset</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="row-1045"><span class="lineno">1045 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1046"><span class="lineno">1046 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="row-1047"><span class="lineno">1047 </span>
</span><span id="row-1048"><span class="lineno">1048 </span>    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span id="row-1049"><span class="lineno">1049 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">):</span>
</span><span id="row-1050"><span class="lineno">1050 </span>            <span class="k">assert</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">'cannot handle slice with stride'</span>
</span><span id="row-1051"><span class="lineno">1051 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1052"><span class="lineno">1052 </span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'assigning non-ViewList to ViewList slice'</span><span class="p">)</span>
</span><span id="row-1053"><span class="lineno">1053 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span>
</span><span id="row-1054"><span class="lineno">1054 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span>
</span><span id="row-1055"><span class="lineno">1055 </span>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">),</span> <span class="s1">'data mismatch'</span>
</span><span id="row-1056"><span class="lineno">1056 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1057"><span class="lineno">1057 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span>
</span><span id="row-1058"><span class="lineno">1058 </span>                            <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="row-1059"><span class="lineno">1059 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1060"><span class="lineno">1060 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="row-1061"><span class="lineno">1061 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1062"><span class="lineno">1062 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="row-1063"><span class="lineno">1063 </span>
</span><span id="row-1064"><span class="lineno">1064 </span>    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="row-1065"><span class="lineno">1065 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-1066"><span class="lineno">1066 </span>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="row-1067"><span class="lineno">1067 </span>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="row-1068"><span class="lineno">1068 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1069"><span class="lineno">1069 </span>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">]</span>
</span><span id="row-1070"><span class="lineno">1070 </span>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="row-1071"><span class="lineno">1071 </span>            <span class="k">assert</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">'cannot handle slice with stride'</span>
</span><span id="row-1072"><span class="lineno">1072 </span>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
</span><span id="row-1073"><span class="lineno">1073 </span>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
</span><span id="row-1074"><span class="lineno">1074 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1075"><span class="lineno">1075 </span>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span>
</span><span id="row-1076"><span class="lineno">1076 </span>                                <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">]</span>
</span><span id="row-1077"><span class="lineno">1077 </span>
</span><span id="row-1078"><span class="lineno">1078 </span>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="row-1079"><span class="lineno">1079 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1080"><span class="lineno">1080 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="row-1081"><span class="lineno">1081 </span>                                  <span class="n">items</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">))</span>
</span><span id="row-1082"><span class="lineno">1082 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1083"><span class="lineno">1083 </span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'adding non-ViewList to a ViewList'</span><span class="p">)</span>
</span><span id="row-1084"><span class="lineno">1084 </span>
</span><span id="row-1085"><span class="lineno">1085 </span>    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="row-1086"><span class="lineno">1086 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1087"><span class="lineno">1087 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="row-1088"><span class="lineno">1088 </span>                                  <span class="n">items</span><span class="o">=</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">items</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">))</span>
</span><span id="row-1089"><span class="lineno">1089 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1090"><span class="lineno">1090 </span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'adding ViewList to a non-ViewList'</span><span class="p">)</span>
</span><span id="row-1091"><span class="lineno">1091 </span>
</span><span id="row-1092"><span class="lineno">1092 </span>    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="row-1093"><span class="lineno">1093 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1094"><span class="lineno">1094 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span>
</span><span id="row-1095"><span class="lineno">1095 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1096"><span class="lineno">1096 </span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'argument to += must be a ViewList'</span><span class="p">)</span>
</span><span id="row-1097"><span class="lineno">1097 </span>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="row-1098"><span class="lineno">1098 </span>
</span><span id="row-1099"><span class="lineno">1099 </span>    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="row-1100"><span class="lineno">1100 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>
</span><span id="row-1101"><span class="lineno">1101 </span>
</span><span id="row-1102"><span class="lineno">1102 </span>    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="fm">__mul__</span>
</span><span id="row-1103"><span class="lineno">1103 </span>
</span><span id="row-1104"><span class="lineno">1104 </span>    <span class="k">def</span> <span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="row-1105"><span class="lineno">1105 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">n</span>
</span><span id="row-1106"><span class="lineno">1106 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">*=</span> <span class="n">n</span>
</span><span id="row-1107"><span class="lineno">1107 </span>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="row-1108"><span class="lineno">1108 </span>
</span><span id="row-1109"><span class="lineno">1109 </span>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="row-1110"><span class="lineno">1110 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1111"><span class="lineno">1111 </span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'extending a ViewList with a non-ViewList'</span><span class="p">)</span>
</span><span id="row-1112"><span class="lineno">1112 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1113"><span class="lineno">1113 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="row-1114"><span class="lineno">1114 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1115"><span class="lineno">1115 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</span><span id="row-1116"><span class="lineno">1116 </span>
</span><span id="row-1117"><span class="lineno">1117 </span>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="row-1118"><span class="lineno">1118 </span>        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1119"><span class="lineno">1119 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="row-1120"><span class="lineno">1120 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1121"><span class="lineno">1121 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1122"><span class="lineno">1122 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span>
</span><span id="row-1123"><span class="lineno">1123 </span>                                   <span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span><span id="row-1124"><span class="lineno">1124 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="row-1125"><span class="lineno">1125 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
</span><span id="row-1126"><span class="lineno">1126 </span>
</span><span id="row-1127"><span class="lineno">1127 </span>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="row-1128"><span class="lineno">1128 </span>        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1129"><span class="lineno">1129 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1130"><span class="lineno">1130 </span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'inserting non-ViewList with no source given'</span><span class="p">)</span>
</span><span id="row-1131"><span class="lineno">1131 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span>
</span><span id="row-1132"><span class="lineno">1132 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span>
</span><span id="row-1133"><span class="lineno">1133 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1134"><span class="lineno">1134 </span>                <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1135"><span class="lineno">1135 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span id="row-1136"><span class="lineno">1136 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1137"><span class="lineno">1137 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span id="row-1138"><span class="lineno">1138 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
</span><span id="row-1139"><span class="lineno">1139 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1140"><span class="lineno">1140 </span>                <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1141"><span class="lineno">1141 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span>
</span><span id="row-1142"><span class="lineno">1142 </span>                                   <span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span><span id="row-1143"><span class="lineno">1143 </span>
</span><span id="row-1144"><span class="lineno">1144 </span>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="row-1145"><span class="lineno">1145 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1146"><span class="lineno">1146 </span>            <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1147"><span class="lineno">1147 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span><span class="p">)</span>
</span><span id="row-1148"><span class="lineno">1148 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="row-1149"><span class="lineno">1149 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="row-1150"><span class="lineno">1150 </span>
</span><span id="row-1151"><span class="lineno">1151 </span>    <span class="k">def</span> <span class="nf">trim_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="row-1152"><span class="lineno">1152 </span>        <span class="sd">"""</span>
</span><span id="row-1153"><span class="lineno">1153 </span><span class="sd">        Remove items from the start of the list, without touching the parent.</span>
</span><span id="row-1154"><span class="lineno">1154 </span><span class="sd">        """</span>
</span><span id="row-1155"><span class="lineno">1155 </span>        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
</span><span id="row-1156"><span class="lineno">1156 </span>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">"Size of trim too large; can't trim </span><span class="si">%s</span><span class="s2"> items "</span>
</span><span id="row-1157"><span class="lineno">1157 </span>                             <span class="s2">"from a list of size </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
</span><span id="row-1158"><span class="lineno">1158 </span>        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="row-1159"><span class="lineno">1159 </span>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">'Trim size must be &gt;= 0.'</span><span class="p">)</span>
</span><span id="row-1160"><span class="lineno">1160 </span>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
</span><span id="row-1161"><span class="lineno">1161 </span>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
</span><span id="row-1162"><span class="lineno">1162 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
</span><span id="row-1163"><span class="lineno">1163 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">parent_offset</span> <span class="o">+=</span> <span class="n">n</span>
</span><span id="row-1164"><span class="lineno">1164 </span>
</span><span id="row-1165"><span class="lineno">1165 </span>    <span class="k">def</span> <span class="nf">trim_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="row-1166"><span class="lineno">1166 </span>        <span class="sd">"""</span>
</span><span id="row-1167"><span class="lineno">1167 </span><span class="sd">        Remove items from the end of the list, without touching the parent.</span>
</span><span id="row-1168"><span class="lineno">1168 </span><span class="sd">        """</span>
</span><span id="row-1169"><span class="lineno">1169 </span>        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
</span><span id="row-1170"><span class="lineno">1170 </span>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">"Size of trim too large; can't trim </span><span class="si">%s</span><span class="s2"> items "</span>
</span><span id="row-1171"><span class="lineno">1171 </span>                             <span class="s2">"from a list of size </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
</span><span id="row-1172"><span class="lineno">1172 </span>        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="row-1173"><span class="lineno">1173 </span>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">'Trim size must be &gt;= 0.'</span><span class="p">)</span>
</span><span id="row-1174"><span class="lineno">1174 </span>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
</span><span id="row-1175"><span class="lineno">1175 </span>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
</span><span id="row-1176"><span class="lineno">1176 </span>
</span><span id="row-1177"><span class="lineno">1177 </span>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span id="row-1178"><span class="lineno">1178 </span>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="row-1179"><span class="lineno">1179 </span>        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="row-1180"><span class="lineno">1180 </span>
</span><span id="row-1181"><span class="lineno">1181 </span>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="row-1182"><span class="lineno">1182 </span>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="row-1183"><span class="lineno">1183 </span>
</span><span id="row-1184"><span class="lineno">1184 </span>    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1185"><span class="lineno">1185 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="row-1186"><span class="lineno">1186 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="row-1187"><span class="lineno">1187 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-1188"><span class="lineno">1188 </span>
</span><span id="row-1189"><span class="lineno">1189 </span>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="row-1190"><span class="lineno">1190 </span>        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</span><span id="row-1191"><span class="lineno">1191 </span>        <span class="n">tmp</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span id="row-1192"><span class="lineno">1192 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
</span><span id="row-1193"><span class="lineno">1193 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
</span><span id="row-1194"><span class="lineno">1194 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-1195"><span class="lineno">1195 </span>
</span><span id="row-1196"><span class="lineno">1196 </span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="row-1197"><span class="lineno">1197 </span>        <span class="sd">"""Return source &amp; offset for index `i`."""</span>
</span><span id="row-1198"><span class="lineno">1198 </span>        <span class="k">try</span><span class="p">:</span>
</span><span id="row-1199"><span class="lineno">1199 </span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="row-1200"><span class="lineno">1200 </span>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-1201"><span class="lineno">1201 </span>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>     <span class="c1"># Just past the end</span>
</span><span id="row-1202"><span class="lineno">1202 </span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span>
</span><span id="row-1203"><span class="lineno">1203 </span>            <span class="k">else</span><span class="p">:</span>
</span><span id="row-1204"><span class="lineno">1204 </span>                <span class="k">raise</span>
</span><span id="row-1205"><span class="lineno">1205 </span>
</span><span id="row-1206"><span class="lineno">1206 </span>    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="row-1207"><span class="lineno">1207 </span>        <span class="sd">"""Return source for index `i`."""</span>
</span><span id="row-1208"><span class="lineno">1208 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="row-1209"><span class="lineno">1209 </span>
</span><span id="row-1210"><span class="lineno">1210 </span>    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="row-1211"><span class="lineno">1211 </span>        <span class="sd">"""Return offset for index `i`."""</span>
</span><span id="row-1212"><span class="lineno">1212 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="row-1213"><span class="lineno">1213 </span>
</span><span id="row-1214"><span class="lineno">1214 </span>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1215"><span class="lineno">1215 </span>        <span class="sd">"""Break link between this list and parent list."""</span>
</span><span id="row-1216"><span class="lineno">1216 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
</span><span id="row-1217"><span class="lineno">1217 </span>
</span><span id="row-1218"><span class="lineno">1218 </span>    <span class="k">def</span> <span class="nf">xitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1219"><span class="lineno">1219 </span>        <span class="sd">"""Return iterator yielding (source, offset, value) tuples."""</span>
</span><span id="row-1220"><span class="lineno">1220 </span>        <span class="k">for</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
</span><span id="row-1221"><span class="lineno">1221 </span>            <span class="k">yield</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="row-1222"><span class="lineno">1222 </span>
</span><span id="row-1223"><span class="lineno">1223 </span>    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="row-1224"><span class="lineno">1224 </span>        <span class="sd">"""Print the list in `grep` format (`source:offset:value` lines)"""</span>
</span><span id="row-1225"><span class="lineno">1225 </span>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xitems</span><span class="p">():</span>
</span><span id="row-1226"><span class="lineno">1226 </span>            <span class="k">print</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">line</span>
</span><span id="row-1227"><span class="lineno">1227 </span>
</span><span id="row-1228"><span class="lineno">1228 </span>
</span><span id="row-1229"><span class="lineno">1229 </span><span class="k">class</span> <span class="nc">StringList</span><span class="p">(</span><span class="n">ViewList</span><span class="p">):</span>
</span><span id="row-1230"><span class="lineno">1230 </span>
</span><span id="row-1231"><span class="lineno">1231 </span>    <span class="sd">"""A `ViewList` with string-specific methods."""</span>
</span><span id="row-1232"><span class="lineno">1232 </span>
</span><span id="row-1233"><span class="lineno">1233 </span>    <span class="k">def</span> <span class="nf">trim_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">):</span>
</span><span id="row-1234"><span class="lineno">1234 </span>        <span class="sd">"""</span>
</span><span id="row-1235"><span class="lineno">1235 </span><span class="sd">        Trim `length` characters off the beginning of each item, in-place,</span>
</span><span id="row-1236"><span class="lineno">1236 </span><span class="sd">        from index `start` to `end`.  No whitespace-checking is done on the</span>
</span><span id="row-1237"><span class="lineno">1237 </span><span class="sd">        trimmed text.  Does not affect slice parent.</span>
</span><span id="row-1238"><span class="lineno">1238 </span><span class="sd">        """</span>
</span><span id="row-1239"><span class="lineno">1239 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>
</span><span id="row-1240"><span class="lineno">1240 </span>                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]]</span>
</span><span id="row-1241"><span class="lineno">1241 </span>
</span><span id="row-1242"><span class="lineno">1242 </span>    <span class="k">def</span> <span class="nf">get_text_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">flush_left</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span id="row-1243"><span class="lineno">1243 </span>        <span class="sd">"""</span>
</span><span id="row-1244"><span class="lineno">1244 </span><span class="sd">        Return a contiguous block of text.</span>
</span><span id="row-1245"><span class="lineno">1245 </span>
</span><span id="row-1246"><span class="lineno">1246 </span><span class="sd">        If `flush_left` is true, raise `UnexpectedIndentationError` if an</span>
</span><span id="row-1247"><span class="lineno">1247 </span><span class="sd">        indented line is encountered before the text block ends (with a blank</span>
</span><span id="row-1248"><span class="lineno">1248 </span><span class="sd">        line).</span>
</span><span id="row-1249"><span class="lineno">1249 </span><span class="sd">        """</span>
</span><span id="row-1250"><span class="lineno">1250 </span>        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
</span><span id="row-1251"><span class="lineno">1251 </span>        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1252"><span class="lineno">1252 </span>        <span class="k">while</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">:</span>
</span><span id="row-1253"><span class="lineno">1253 </span>            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end</span><span class="p">]</span>
</span><span id="row-1254"><span class="lineno">1254 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="row-1255"><span class="lineno">1255 </span>                <span class="k">break</span>
</span><span id="row-1256"><span class="lineno">1256 </span>            <span class="k">if</span> <span class="n">flush_left</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">' '</span><span class="p">):</span>
</span><span id="row-1257"><span class="lineno">1257 </span>                <span class="n">source</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
</span><span id="row-1258"><span class="lineno">1258 </span>                <span class="k">raise</span> <span class="n">UnexpectedIndentationError</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">source</span><span class="p">,</span>
</span><span id="row-1259"><span class="lineno">1259 </span>                                                 <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="row-1260"><span class="lineno">1260 </span>            <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-1261"><span class="lineno">1261 </span>        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="row-1262"><span class="lineno">1262 </span>
</span><span id="row-1263"><span class="lineno">1263 </span>    <span class="k">def</span> <span class="nf">get_indented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">until_blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">strip_indent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span id="row-1264"><span class="lineno">1264 </span>                     <span class="n">block_indent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first_indent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span id="row-1265"><span class="lineno">1265 </span>        <span class="sd">"""</span>
</span><span id="row-1266"><span class="lineno">1266 </span><span class="sd">        Extract and return a StringList of indented lines of text.</span>
</span><span id="row-1267"><span class="lineno">1267 </span>
</span><span id="row-1268"><span class="lineno">1268 </span><span class="sd">        Collect all lines with indentation, determine the minimum indentation,</span>
</span><span id="row-1269"><span class="lineno">1269 </span><span class="sd">        remove the minimum indentation from all indented lines (unless</span>
</span><span id="row-1270"><span class="lineno">1270 </span><span class="sd">        `strip_indent` is false), and return them. All lines up to but not</span>
</span><span id="row-1271"><span class="lineno">1271 </span><span class="sd">        including the first unindented line will be returned.</span>
</span><span id="row-1272"><span class="lineno">1272 </span>
</span><span id="row-1273"><span class="lineno">1273 </span><span class="sd">        :Parameters:</span>
</span><span id="row-1274"><span class="lineno">1274 </span><span class="sd">          - `start`: The index of the first line to examine.</span>
</span><span id="row-1275"><span class="lineno">1275 </span><span class="sd">          - `until_blank`: Stop collecting at the first blank line if true.</span>
</span><span id="row-1276"><span class="lineno">1276 </span><span class="sd">          - `strip_indent`: Strip common leading indent if true (default).</span>
</span><span id="row-1277"><span class="lineno">1277 </span><span class="sd">          - `block_indent`: The indent of the entire block, if known.</span>
</span><span id="row-1278"><span class="lineno">1278 </span><span class="sd">          - `first_indent`: The indent of the first line, if known.</span>
</span><span id="row-1279"><span class="lineno">1279 </span>
</span><span id="row-1280"><span class="lineno">1280 </span><span class="sd">        :Return:</span>
</span><span id="row-1281"><span class="lineno">1281 </span><span class="sd">          - a StringList of indented lines with mininum indent removed;</span>
</span><span id="row-1282"><span class="lineno">1282 </span><span class="sd">          - the amount of the indent;</span>
</span><span id="row-1283"><span class="lineno">1283 </span><span class="sd">          - a boolean: did the indented block finish with a blank line or EOF?</span>
</span><span id="row-1284"><span class="lineno">1284 </span><span class="sd">        """</span>
</span><span id="row-1285"><span class="lineno">1285 </span>        <span class="n">indent</span> <span class="o">=</span> <span class="n">block_indent</span>           <span class="c1"># start with None if unknown</span>
</span><span id="row-1286"><span class="lineno">1286 </span>        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
</span><span id="row-1287"><span class="lineno">1287 </span>        <span class="k">if</span> <span class="n">block_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">first_indent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1288"><span class="lineno">1288 </span>            <span class="n">first_indent</span> <span class="o">=</span> <span class="n">block_indent</span>
</span><span id="row-1289"><span class="lineno">1289 </span>        <span class="k">if</span> <span class="n">first_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1290"><span class="lineno">1290 </span>            <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-1291"><span class="lineno">1291 </span>        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="row-1292"><span class="lineno">1292 </span>        <span class="k">while</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">:</span>
</span><span id="row-1293"><span class="lineno">1293 </span>            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end</span><span class="p">]</span>
</span><span id="row-1294"><span class="lineno">1294 </span>            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">' '</span>
</span><span id="row-1295"><span class="lineno">1295 </span>                         <span class="ow">or</span> <span class="p">(</span><span class="n">block_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</span><span id="row-1296"><span class="lineno">1296 </span>                             <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="n">block_indent</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())):</span>
</span><span id="row-1297"><span class="lineno">1297 </span>                <span class="c1"># Line not indented or insufficiently indented.</span>
</span><span id="row-1298"><span class="lineno">1298 </span>                <span class="c1"># Block finished properly iff the last indented line blank:</span>
</span><span id="row-1299"><span class="lineno">1299 </span>                <span class="n">blank_finish</span> <span class="o">=</span> <span class="p">((</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span>
</span><span id="row-1300"><span class="lineno">1300 </span>                                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="row-1301"><span class="lineno">1301 </span>                <span class="k">break</span>
</span><span id="row-1302"><span class="lineno">1302 </span>            <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
</span><span id="row-1303"><span class="lineno">1303 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>            <span class="c1"># blank line</span>
</span><span id="row-1304"><span class="lineno">1304 </span>                <span class="k">if</span> <span class="n">until_blank</span><span class="p">:</span>
</span><span id="row-1305"><span class="lineno">1305 </span>                    <span class="n">blank_finish</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="row-1306"><span class="lineno">1306 </span>                    <span class="k">break</span>
</span><span id="row-1307"><span class="lineno">1307 </span>            <span class="k">elif</span> <span class="n">block_indent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1308"><span class="lineno">1308 </span>                <span class="n">line_indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
</span><span id="row-1309"><span class="lineno">1309 </span>                <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span id="row-1310"><span class="lineno">1310 </span>                    <span class="n">indent</span> <span class="o">=</span> <span class="n">line_indent</span>
</span><span id="row-1311"><span class="lineno">1311 </span>                <span class="k">else</span><span class="p">:</span>
</span><span id="row-1312"><span class="lineno">1312 </span>                    <span class="n">indent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">line_indent</span><span class="p">)</span>
</span><span id="row-1313"><span class="lineno">1313 </span>            <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="row-1314"><span class="lineno">1314 </span>        <span class="k">else</span><span class="p">:</span>
</span><span id="row-1315"><span class="lineno">1315 </span>            <span class="n">blank_finish</span> <span class="o">=</span> <span class="mi">1</span>            <span class="c1"># block ends at end of lines</span>
</span><span id="row-1316"><span class="lineno">1316 </span>        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="row-1317"><span class="lineno">1317 </span>        <span class="k">if</span> <span class="n">first_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">block</span><span class="p">:</span>
</span><span id="row-1318"><span class="lineno">1318 </span>            <span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">first_indent</span><span class="p">:]</span>
</span><span id="row-1319"><span class="lineno">1319 </span>        <span class="k">if</span> <span class="n">indent</span> <span class="ow">and</span> <span class="n">strip_indent</span><span class="p">:</span>
</span><span id="row-1320"><span class="lineno">1320 </span>            <span class="n">block</span><span class="o">.</span><span class="n">trim_left</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="n">first_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>
</span><span id="row-1321"><span class="lineno">1321 </span>        <span class="k">return</span> <span class="n">block</span><span class="p">,</span> <span class="n">indent</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blank_finish</span>
</span><span id="row-1322"><span class="lineno">1322 </span>
</span><span id="row-1323"><span class="lineno">1323 </span>    <span class="k">def</span> <span class="nf">get_2D_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">strip_indent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span id="row-1324"><span class="lineno">1324 </span>        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">top</span><span class="p">:</span><span class="n">bottom</span><span class="p">]</span>
</span><span id="row-1325"><span class="lineno">1325 </span>        <span class="n">indent</span> <span class="o">=</span> <span class="n">right</span>
</span><span id="row-1326"><span class="lineno">1326 </span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
</span><span id="row-1327"><span class="lineno">1327 </span>            <span class="c1"># get slice from line, care for combining characters</span>
</span><span id="row-1328"><span class="lineno">1328 </span>            <span class="n">ci</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">column_indices</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="row-1329"><span class="lineno">1329 </span>            <span class="k">try</span><span class="p">:</span>
</span><span id="row-1330"><span class="lineno">1330 </span>                <span class="n">left</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
</span><span id="row-1331"><span class="lineno">1331 </span>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-1332"><span class="lineno">1332 </span>                <span class="n">left</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>
</span><span id="row-1333"><span class="lineno">1333 </span>            <span class="k">try</span><span class="p">:</span>
</span><span id="row-1334"><span class="lineno">1334 </span>                <span class="n">right</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
</span><span id="row-1335"><span class="lineno">1335 </span>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="row-1336"><span class="lineno">1336 </span>                <span class="n">right</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>
</span><span id="row-1337"><span class="lineno">1337 </span>            <span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</span><span id="row-1338"><span class="lineno">1338 </span>            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span id="row-1339"><span class="lineno">1339 </span>                <span class="n">indent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()))</span>
</span><span id="row-1340"><span class="lineno">1340 </span>        <span class="k">if</span> <span class="n">strip_indent</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">indent</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">:</span>
</span><span id="row-1341"><span class="lineno">1341 </span>            <span class="n">block</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">indent</span><span class="p">:]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</span><span id="row-1342"><span class="lineno">1342 </span>        <span class="k">return</span> <span class="n">block</span>
</span><span id="row-1343"><span class="lineno">1343 </span>
</span><span id="row-1344"><span class="lineno">1344 </span>    <span class="k">def</span> <span class="nf">pad_double_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_char</span><span class="p">):</span>
</span><span id="row-1345"><span class="lineno">1345 </span>        <span class="sd">"""</span>
</span><span id="row-1346"><span class="lineno">1346 </span><span class="sd">        Pad all double-width characters in self by appending `pad_char` to each.</span>
</span><span id="row-1347"><span class="lineno">1347 </span><span class="sd">        For East Asian language support.</span>
</span><span id="row-1348"><span class="lineno">1348 </span><span class="sd">        """</span>
</span><span id="row-1349"><span class="lineno">1349 </span>        <span class="n">east_asian_width</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">east_asian_width</span>
</span><span id="row-1350"><span class="lineno">1350 </span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
</span><span id="row-1351"><span class="lineno">1351 </span>            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="row-1352"><span class="lineno">1352 </span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
</span><span id="row-1353"><span class="lineno">1353 </span>                <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-1354"><span class="lineno">1354 </span>                <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="row-1355"><span class="lineno">1355 </span>                    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
</span><span id="row-1356"><span class="lineno">1356 </span>                    <span class="k">if</span> <span class="n">east_asian_width</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="ow">in</span> <span class="s1">'WF'</span><span class="p">:</span> <span class="c1"># 'W'ide &amp; 'F'ull-width</span>
</span><span id="row-1357"><span class="lineno">1357 </span>                        <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pad_char</span><span class="p">)</span>
</span><span id="row-1358"><span class="lineno">1358 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
</span><span id="row-1359"><span class="lineno">1359 </span>
</span><span id="row-1360"><span class="lineno">1360 </span>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
</span><span id="row-1361"><span class="lineno">1361 </span>        <span class="sd">"""Replace all occurrences of substring `old` with `new`."""</span>
</span><span id="row-1362"><span class="lineno">1362 </span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
</span><span id="row-1363"><span class="lineno">1363 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
</span><span id="row-1364"><span class="lineno">1364 </span>
</span><span id="row-1365"><span class="lineno">1365 </span>
</span><span id="row-1366"><span class="lineno">1366 </span><span class="k">class</span> <span class="nc">StateMachineError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1367"><span class="lineno">1367 </span><span class="k">class</span> <span class="nc">UnknownStateError</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1368"><span class="lineno">1368 </span><span class="k">class</span> <span class="nc">DuplicateStateError</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1369"><span class="lineno">1369 </span><span class="k">class</span> <span class="nc">UnknownTransitionError</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1370"><span class="lineno">1370 </span><span class="k">class</span> <span class="nc">DuplicateTransitionError</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1371"><span class="lineno">1371 </span><span class="k">class</span> <span class="nc">TransitionPatternNotFound</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1372"><span class="lineno">1372 </span><span class="k">class</span> <span class="nc">TransitionMethodNotFound</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1373"><span class="lineno">1373 </span><span class="k">class</span> <span class="nc">UnexpectedIndentationError</span><span class="p">(</span><span class="n">StateMachineError</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="row-1374"><span class="lineno">1374 </span>
</span><span id="row-1375"><span class="lineno">1375 </span>
</span><span id="row-1376"><span class="lineno">1376 </span><span class="k">class</span> <span class="nc">TransitionCorrection</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="row-1377"><span class="lineno">1377 </span>
</span><span id="row-1378"><span class="lineno">1378 </span>    <span class="sd">"""</span>
</span><span id="row-1379"><span class="lineno">1379 </span><span class="sd">    Raise from within a transition method to switch to another transition.</span>
</span><span id="row-1380"><span class="lineno">1380 </span>
</span><span id="row-1381"><span class="lineno">1381 </span><span class="sd">    Raise with one argument, the new transition name.</span>
</span><span id="row-1382"><span class="lineno">1382 </span><span class="sd">    """</span>
</span><span id="row-1383"><span class="lineno">1383 </span>
</span><span id="row-1384"><span class="lineno">1384 </span>
</span><span id="row-1385"><span class="lineno">1385 </span><span class="k">class</span> <span class="nc">StateCorrection</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="row-1386"><span class="lineno">1386 </span>
</span><span id="row-1387"><span class="lineno">1387 </span>    <span class="sd">"""</span>
</span><span id="row-1388"><span class="lineno">1388 </span><span class="sd">    Raise from within a transition method to switch to another state.</span>
</span><span id="row-1389"><span class="lineno">1389 </span>
</span><span id="row-1390"><span class="lineno">1390 </span><span class="sd">    Raise with one or two arguments: new state name, and an optional new</span>
</span><span id="row-1391"><span class="lineno">1391 </span><span class="sd">    transition name.</span>
</span><span id="row-1392"><span class="lineno">1392 </span><span class="sd">    """</span>
</span><span id="row-1393"><span class="lineno">1393 </span>
</span><span id="row-1394"><span class="lineno">1394 </span>
</span><span id="row-1395"><span class="lineno">1395 </span><span class="k">def</span> <span class="nf">string2lines</span><span class="p">(</span><span class="n">astring</span><span class="p">,</span> <span class="n">tab_width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">convert_whitespace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span id="row-1396"><span class="lineno">1396 </span>                 <span class="n">whitespace</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'[</span><span class="se">\v\f</span><span class="s1">]'</span><span class="p">)):</span>
</span><span id="row-1397"><span class="lineno">1397 </span>    <span class="sd">"""</span>
</span><span id="row-1398"><span class="lineno">1398 </span><span class="sd">    Return a list of one-line strings with tabs expanded, no newlines, and</span>
</span><span id="row-1399"><span class="lineno">1399 </span><span class="sd">    trailing whitespace stripped.</span>
</span><span id="row-1400"><span class="lineno">1400 </span>
</span><span id="row-1401"><span class="lineno">1401 </span><span class="sd">    Each tab is expanded with between 1 and `tab_width` spaces, so that the</span>
</span><span id="row-1402"><span class="lineno">1402 </span><span class="sd">    next character's index becomes a multiple of `tab_width` (8 by default).</span>
</span><span id="row-1403"><span class="lineno">1403 </span>
</span><span id="row-1404"><span class="lineno">1404 </span><span class="sd">    Parameters:</span>
</span><span id="row-1405"><span class="lineno">1405 </span>
</span><span id="row-1406"><span class="lineno">1406 </span><span class="sd">    - `astring`: a multi-line string.</span>
</span><span id="row-1407"><span class="lineno">1407 </span><span class="sd">    - `tab_width`: the number of columns between tab stops.</span>
</span><span id="row-1408"><span class="lineno">1408 </span><span class="sd">    - `convert_whitespace`: convert form feeds and vertical tabs to spaces?</span>
</span><span id="row-1409"><span class="lineno">1409 </span><span class="sd">    """</span>
</span><span id="row-1410"><span class="lineno">1410 </span>    <span class="k">if</span> <span class="n">convert_whitespace</span><span class="p">:</span>
</span><span id="row-1411"><span class="lineno">1411 </span>        <span class="n">astring</span> <span class="o">=</span> <span class="n">whitespace</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="n">astring</span><span class="p">)</span>
</span><span id="row-1412"><span class="lineno">1412 </span>    <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">astring</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
</span><span id="row-1413"><span class="lineno">1413 </span>
</span><span id="row-1414"><span class="lineno">1414 </span><span class="k">def</span> <span class="nf">_exception_data</span><span class="p">():</span>
</span><span id="row-1415"><span class="lineno">1415 </span>    <span class="sd">"""</span>
</span><span id="row-1416"><span class="lineno">1416 </span><span class="sd">    Return exception information:</span>
</span><span id="row-1417"><span class="lineno">1417 </span>
</span><span id="row-1418"><span class="lineno">1418 </span><span class="sd">    - the exception's class name;</span>
</span><span id="row-1419"><span class="lineno">1419 </span><span class="sd">    - the exception object;</span>
</span><span id="row-1420"><span class="lineno">1420 </span><span class="sd">    - the name of the file containing the offending code;</span>
</span><span id="row-1421"><span class="lineno">1421 </span><span class="sd">    - the line number of the offending code;</span>
</span><span id="row-1422"><span class="lineno">1422 </span><span class="sd">    - the function name of the offending code.</span>
</span><span id="row-1423"><span class="lineno">1423 </span><span class="sd">    """</span>
</span><span id="row-1424"><span class="lineno">1424 </span>    <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span><span id="row-1425"><span class="lineno">1425 </span>    <span class="k">while</span> <span class="n">traceback</span><span class="o">.</span><span class="n">tb_next</span><span class="p">:</span>
</span><span id="row-1426"><span class="lineno">1426 </span>        <span class="n">traceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">tb_next</span>
</span><span id="row-1427"><span class="lineno">1427 </span>    <span class="n">code</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span>
</span><span id="row-1428"><span class="lineno">1428 </span>    <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span>
</span><span id="row-1429"><span class="lineno">1429 </span>            <span class="n">code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
</span></pre></div>

    </div>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/demo-page.html"> demo page</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/state-machine.html"> state-machine</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/markup.html"> markup</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/rst.html"> rst</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>