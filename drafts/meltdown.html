<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bit on Bits - Meltdown test</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Full Atom Feed"/>
    <link href="https://derez.github.io/feeds/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Atom Feed"/>
    <link href="https://derez.github.io/feeds/category/code-breakdown/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?da7c28ed">




    <meta name="tags" contents="meltdown"/>
    <meta name="tags" contents="code"/>
    <meta name="tags" contents="bash"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny 'derez' Walker</span></a>
              <span class="email">derez<i class="fa fa-at"></i>packetforge[dot]net</span>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-cogs fa-lg"></i>&nbsp;&nbsp;Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-user-circle fa-lg"></i>&nbsp;&nbsp;About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-3 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bit on Bits</a></li>
            <ul class="right hide-on-med-and-down vertical-align-middle">
              <li><a class="menu-item waves-effect waves-orange btn-flat" href="https://derez.github.io/projects.html">
                <i class="fa fa-cogs"></i>&nbsp;&nbsp;Projects</a>
              </li>
              <li><a class="menu-item dropdown-button waves-effect waves-orange btn-flat" data-beloworigin="true" alignment="left" data-constrainwidth="false" href="#" data-activates="blog-dropdown">
                <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;Blog&nbsp;&nbsp;<i class="fa fa-caret-down"></i></a>
              </li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-3 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/drafts/meltdown.html" class="breadcrumb">Meltdown test</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/drafts/meltdown.html" rel="bookmark" class="article-name card-title" 
      title="Permalink Meltdown test">Meltdown&nbsp;test</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2019-02-03T00:00:00-05:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Date: 
        <time datetime="2019-02-03" itemprop="dateCreated"> 03 Feb 2019</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <div class="highlight"><pre><span></span><span id="row-1"><span class="lineno">  1 </span><span class="ch">#!/bin/bash</span>
</span><span id="row-2"><span class="lineno">  2 </span>
</span><span id="row-3"><span class="lineno">  3 </span><span class="c1"># Copyright (C) 2018  Red Hat, Inc.</span>
</span><span id="row-4"><span class="lineno">  4 </span><span class="c1">#</span>
</span><span id="row-5"><span class="lineno">  5 </span><span class="c1"># This program is free software: you can redistribute it and/or modify</span>
</span><span id="row-6"><span class="lineno">  6 </span><span class="c1"># it under the terms of the GNU General Public License as published by</span>
</span><span id="row-7"><span class="lineno">  7 </span><span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="row-8"><span class="lineno">  8 </span><span class="c1"># (at your option) any later version.</span>
</span><span id="row-9"><span class="lineno">  9 </span>
</span><span id="row-10"><span class="lineno"> 10 </span><span class="c1"># Version: 2.1</span>
</span><span id="row-11"><span class="lineno"> 11 </span>
</span><span id="row-12"><span class="lineno"> 12 </span><span class="c1"># Warning! Be sure to download the latest version of this script from its primary source:</span>
</span><span id="row-13"><span class="lineno"> 13 </span><span class="c1"># https://access.redhat.com/security/vulnerabilities/speculativeexecution</span>
</span><span id="row-14"><span class="lineno"> 14 </span><span class="c1"># DO NOT blindly trust any internet sources and NEVER do `curl something | bash`!</span>
</span><span id="row-15"><span class="lineno"> 15 </span>
</span><span id="row-16"><span class="lineno"> 16 </span><span class="c1"># This script is meant for simple detection of the vulnerability. Feel free to modify it for your</span>
</span><span id="row-17"><span class="lineno"> 17 </span><span class="c1"># environment or needs. For more advanced detection, consider Red Hat Insights:</span>
</span><span id="row-18"><span class="lineno"> 18 </span><span class="c1"># https://access.redhat.com/products/red-hat-insights#getstarted</span>
</span><span id="row-19"><span class="lineno"> 19 </span>
</span><span id="row-20"><span class="lineno"> 20 </span><span class="c1"># Checking against the list of vulnerable packages is necessary because of the way how features</span>
</span><span id="row-21"><span class="lineno"> 21 </span><span class="c1"># are back-ported to older versions of packages in various channels.</span>
</span><span id="row-22"><span class="lineno"> 22 </span>
</span><span id="row-23"><span class="lineno"> 23 </span>
</span><span id="row-24"><span class="lineno"> 24 </span>basic_args<span class="o">()</span> <span class="o">{</span>
</span><span id="row-25"><span class="lineno"> 25 </span>    <span class="c1"># Parses basic commandline arguments and sets basic environment.</span>
</span><span id="row-26"><span class="lineno"> 26 </span>    <span class="c1">#</span>
</span><span id="row-27"><span class="lineno"> 27 </span>    <span class="c1"># Args:</span>
</span><span id="row-28"><span class="lineno"> 28 </span>    <span class="c1">#     parameters - an array of commandline arguments</span>
</span><span id="row-29"><span class="lineno"> 29 </span>    <span class="c1">#</span>
</span><span id="row-30"><span class="lineno"> 30 </span>    <span class="c1"># Side effects:</span>
</span><span id="row-31"><span class="lineno"> 31 </span>    <span class="c1">#     Exits if --help parameters is used</span>
</span><span id="row-32"><span class="lineno"> 32 </span>    <span class="c1">#     Sets COLOR constants and debug variable</span>
</span><span id="row-33"><span class="lineno"> 33 </span>
</span><span id="row-34"><span class="lineno"> 34 </span>    <span class="nb">local</span> <span class="nv">parameters</span><span class="o">=(</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> <span class="o">)</span>
</span><span id="row-35"><span class="lineno"> 35 </span>
</span><span id="row-36"><span class="lineno"> 36 </span>    <span class="nv">RED</span><span class="o">=</span><span class="s2">"\033[1;31m"</span>
</span><span id="row-37"><span class="lineno"> 37 </span>    <span class="nv">YELLOW</span><span class="o">=</span><span class="s2">"\033[1;33m"</span>
</span><span id="row-38"><span class="lineno"> 38 </span>    <span class="nv">GREEN</span><span class="o">=</span><span class="s2">"\033[1;32m"</span>
</span><span id="row-39"><span class="lineno"> 39 </span>    <span class="nv">BOLD</span><span class="o">=</span><span class="s2">"\033[1m"</span>
</span><span id="row-40"><span class="lineno"> 40 </span>    <span class="nv">RESET</span><span class="o">=</span><span class="s2">"\033[0m"</span>
</span><span id="row-41"><span class="lineno"> 41 </span>    <span class="k">for</span> parameter in <span class="s2">"</span><span class="si">${</span><span class="nv">parameters</span><span class="p">[@]</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do</span>
</span><span id="row-42"><span class="lineno"> 42 </span>        <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"-h"</span> <span class="o">||</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"--help"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-43"><span class="lineno"> 43 </span>            <span class="nb">echo</span> <span class="s2">"Usage: </span><span class="k">$(</span> basename <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span> <span class="k">)</span><span class="s2"> [-n | --no-colors] [-d | --debug]"</span>
</span><span id="row-44"><span class="lineno"> 44 </span>            <span class="nb">exit</span> <span class="m">1</span>
</span><span id="row-45"><span class="lineno"> 45 </span>        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"-n"</span> <span class="o">||</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"--no-colors"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-46"><span class="lineno"> 46 </span>            <span class="nv">RED</span><span class="o">=</span><span class="s2">""</span>
</span><span id="row-47"><span class="lineno"> 47 </span>            <span class="nv">YELLOW</span><span class="o">=</span><span class="s2">""</span>
</span><span id="row-48"><span class="lineno"> 48 </span>            <span class="nv">GREEN</span><span class="o">=</span><span class="s2">""</span>
</span><span id="row-49"><span class="lineno"> 49 </span>            <span class="nv">BOLD</span><span class="o">=</span><span class="s2">""</span>
</span><span id="row-50"><span class="lineno"> 50 </span>            <span class="nv">RESET</span><span class="o">=</span><span class="s2">""</span>
</span><span id="row-51"><span class="lineno"> 51 </span>        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"-d"</span> <span class="o">||</span> <span class="s2">"</span><span class="nv">$parameter</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"--debug"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-52"><span class="lineno"> 52 </span>            <span class="nv">debug</span><span class="o">=</span><span class="nb">true</span>
</span><span id="row-53"><span class="lineno"> 53 </span>        <span class="k">fi</span>
</span><span id="row-54"><span class="lineno"> 54 </span>    <span class="k">done</span>
</span><span id="row-55"><span class="lineno"> 55 </span><span class="o">}</span>
</span><span id="row-56"><span class="lineno"> 56 </span>
</span><span id="row-57"><span class="lineno"> 57 </span>
</span><span id="row-58"><span class="lineno"> 58 </span>basic_reqs<span class="o">()</span> <span class="o">{</span>
</span><span id="row-59"><span class="lineno"> 59 </span>    <span class="c1"># Prints common disclaimer and checks basic requirements.</span>
</span><span id="row-60"><span class="lineno"> 60 </span>    <span class="c1">#</span>
</span><span id="row-61"><span class="lineno"> 61 </span>    <span class="c1"># Args:</span>
</span><span id="row-62"><span class="lineno"> 62 </span>    <span class="c1">#     CVE - string printed in the disclaimer</span>
</span><span id="row-63"><span class="lineno"> 63 </span>    <span class="c1">#</span>
</span><span id="row-64"><span class="lineno"> 64 </span>    <span class="c1"># Side effects:</span>
</span><span id="row-65"><span class="lineno"> 65 </span>    <span class="c1">#     Exits when 'rpm' command is not available</span>
</span><span id="row-66"><span class="lineno"> 66 </span>
</span><span id="row-67"><span class="lineno"> 67 </span>    <span class="nb">local</span> <span class="nv">CVE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
</span><span id="row-68"><span class="lineno"> 68 </span>
</span><span id="row-69"><span class="lineno"> 69 </span>    <span class="c1"># Disclaimer</span>
</span><span id="row-70"><span class="lineno"> 70 </span>    <span class="nb">echo</span>
</span><span id="row-71"><span class="lineno"> 71 </span>    <span class="nb">echo</span> -e <span class="s2">"</span><span class="si">${</span><span class="nv">BOLD</span><span class="si">}</span><span class="s2">This script is primarily designed to detect </span><span class="nv">$CVE</span><span class="s2"> on supported"</span>
</span><span id="row-72"><span class="lineno"> 72 </span>    <span class="nb">echo</span> -e <span class="s2">"Red Hat Enterprise Linux systems and kernel packages."</span>
</span><span id="row-73"><span class="lineno"> 73 </span>    <span class="nb">echo</span> -e <span class="s2">"Result may be inaccurate for other RPM based systems.</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-74"><span class="lineno"> 74 </span>    <span class="nb">echo</span>
</span><span id="row-75"><span class="lineno"> 75 </span>
</span><span id="row-76"><span class="lineno"> 76 </span>    <span class="c1"># RPM is required</span>
</span><span id="row-77"><span class="lineno"> 77 </span>    <span class="k">if</span> ! <span class="nb">command</span> -v rpm <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
</span><span id="row-78"><span class="lineno"> 78 </span>        <span class="nb">echo</span> <span class="s2">"'rpm' command is required, but not installed. Exiting."</span>
</span><span id="row-79"><span class="lineno"> 79 </span>        <span class="nb">exit</span> <span class="m">1</span>
</span><span id="row-80"><span class="lineno"> 80 </span>    <span class="k">fi</span>
</span><span id="row-81"><span class="lineno"> 81 </span><span class="o">}</span>
</span><span id="row-82"><span class="lineno"> 82 </span>
</span><span id="row-83"><span class="lineno"> 83 </span>
</span><span id="row-84"><span class="lineno"> 84 </span>check_supported_kernel<span class="o">()</span> <span class="o">{</span>
</span><span id="row-85"><span class="lineno"> 85 </span>    <span class="c1"># Checks if running kernel is supported.</span>
</span><span id="row-86"><span class="lineno"> 86 </span>    <span class="c1">#</span>
</span><span id="row-87"><span class="lineno"> 87 </span>    <span class="c1"># Args:</span>
</span><span id="row-88"><span class="lineno"> 88 </span>    <span class="c1">#     running_kernel - kernel string as returned by 'uname -r'</span>
</span><span id="row-89"><span class="lineno"> 89 </span>    <span class="c1">#</span>
</span><span id="row-90"><span class="lineno"> 90 </span>    <span class="c1"># Side effects:</span>
</span><span id="row-91"><span class="lineno"> 91 </span>    <span class="c1">#     Exits when running kernel is obviously not supported</span>
</span><span id="row-92"><span class="lineno"> 92 </span>
</span><span id="row-93"><span class="lineno"> 93 </span>    <span class="nb">local</span> <span class="nv">running_kernel</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
</span><span id="row-94"><span class="lineno"> 94 </span>
</span><span id="row-95"><span class="lineno"> 95 </span>    <span class="c1"># Check supported platform</span>
</span><span id="row-96"><span class="lineno"> 96 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$running_kernel</span><span class="s2">"</span> !<span class="o">=</span> *<span class="s2">".el"</span><span class="o">[</span><span class="m">5</span>-7<span class="o">]</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-97"><span class="lineno"> 97 </span>        <span class="nb">echo</span> <span class="s2">"This script is meant to be used only on Red Hat Enterprise Linux 5, 6 and 7."</span>
</span><span id="row-98"><span class="lineno"> 98 </span>        <span class="nb">exit</span> <span class="m">1</span>
</span><span id="row-99"><span class="lineno"> 99 </span>    <span class="k">fi</span>
</span><span id="row-100"><span class="lineno">100 </span><span class="o">}</span>
</span><span id="row-101"><span class="lineno">101 </span>
</span><span id="row-102"><span class="lineno">102 </span>
</span><span id="row-103"><span class="lineno">103 </span>get_rhel<span class="o">()</span> <span class="o">{</span>
</span><span id="row-104"><span class="lineno">104 </span>    <span class="c1"># Gets RHEL number.</span>
</span><span id="row-105"><span class="lineno">105 </span>    <span class="c1">#</span>
</span><span id="row-106"><span class="lineno">106 </span>    <span class="c1"># Args:</span>
</span><span id="row-107"><span class="lineno">107 </span>    <span class="c1">#     running_kernel - kernel string as returned by 'uname -r'</span>
</span><span id="row-108"><span class="lineno">108 </span>    <span class="c1">#</span>
</span><span id="row-109"><span class="lineno">109 </span>    <span class="c1"># Prints:</span>
</span><span id="row-110"><span class="lineno">110 </span>    <span class="c1">#     RHEL number, e.g. '5', '6', or '7'</span>
</span><span id="row-111"><span class="lineno">111 </span>
</span><span id="row-112"><span class="lineno">112 </span>    <span class="nb">local</span> <span class="nv">running_kernel</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
</span><span id="row-113"><span class="lineno">113 </span>
</span><span id="row-114"><span class="lineno">114 </span>    <span class="nb">local</span> <span class="nv">rhel</span><span class="o">=</span><span class="k">$(</span> sed -r -n <span class="s1">'s/^.*el([[:digit:]]).*$/\1/p'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$running_kernel</span><span class="s2">"</span> <span class="k">)</span>
</span><span id="row-115"><span class="lineno">115 </span>    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$rhel</span><span class="s2">"</span>
</span><span id="row-116"><span class="lineno">116 </span><span class="o">}</span>
</span><span id="row-117"><span class="lineno">117 </span>
</span><span id="row-118"><span class="lineno">118 </span>
</span><span id="row-119"><span class="lineno">119 </span>check_cpu_vendor<span class="o">()</span> <span class="o">{</span>
</span><span id="row-120"><span class="lineno">120 </span>    <span class="c1"># Checks for supported CPU vendor.</span>
</span><span id="row-121"><span class="lineno">121 </span>    <span class="c1">#</span>
</span><span id="row-122"><span class="lineno">122 </span>    <span class="c1"># Prints:</span>
</span><span id="row-123"><span class="lineno">123 </span>    <span class="c1">#     'Intel' or 'AMD'</span>
</span><span id="row-124"><span class="lineno">124 </span>    <span class="c1">#</span>
</span><span id="row-125"><span class="lineno">125 </span>    <span class="c1"># Returns:</span>
</span><span id="row-126"><span class="lineno">126 </span>    <span class="c1">#     0 if supported CPU vendor found, otherwise 1</span>
</span><span id="row-127"><span class="lineno">127 </span>    <span class="c1">#</span>
</span><span id="row-128"><span class="lineno">128 </span>    <span class="c1"># Notes:</span>
</span><span id="row-129"><span class="lineno">129 </span>    <span class="c1">#     MOCK_CPU_INFO_PATH can be used to mock /proc/cpuinfo file</span>
</span><span id="row-130"><span class="lineno">130 </span>
</span><span id="row-131"><span class="lineno">131 </span>    <span class="nb">local</span> <span class="nv">cpuinfo</span><span class="o">=</span><span class="si">${</span><span class="nv">MOCK_CPU_INFO_PATH</span><span class="k">:-</span><span class="p">/proc/cpuinfo</span><span class="si">}</span>
</span><span id="row-132"><span class="lineno">132 </span>
</span><span id="row-133"><span class="lineno">133 </span>    <span class="k">if</span> grep --quiet <span class="s2">"GenuineIntel"</span> <span class="s2">"</span><span class="nv">$cpuinfo</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-134"><span class="lineno">134 </span>        <span class="nb">echo</span> <span class="s2">"Intel"</span>
</span><span id="row-135"><span class="lineno">135 </span>        <span class="k">return</span> <span class="m">0</span>
</span><span id="row-136"><span class="lineno">136 </span>    <span class="k">fi</span>
</span><span id="row-137"><span class="lineno">137 </span>    <span class="k">if</span> grep --quiet <span class="s2">"AuthenticAMD"</span> <span class="s2">"</span><span class="nv">$cpuinfo</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-138"><span class="lineno">138 </span>        <span class="nb">echo</span> <span class="s2">"AMD"</span>
</span><span id="row-139"><span class="lineno">139 </span>        <span class="k">return</span> <span class="m">0</span>
</span><span id="row-140"><span class="lineno">140 </span>    <span class="k">fi</span>
</span><span id="row-141"><span class="lineno">141 </span>
</span><span id="row-142"><span class="lineno">142 </span>    <span class="k">return</span> <span class="m">1</span>
</span><span id="row-143"><span class="lineno">143 </span><span class="o">}</span>
</span><span id="row-144"><span class="lineno">144 </span>
</span><span id="row-145"><span class="lineno">145 </span>
</span><span id="row-146"><span class="lineno">146 </span>gather_info<span class="o">()</span> <span class="o">{</span>
</span><span id="row-147"><span class="lineno">147 </span>    <span class="c1"># Gathers all available information and stores it in global variables.</span>
</span><span id="row-148"><span class="lineno">148 </span>    <span class="c1">#</span>
</span><span id="row-149"><span class="lineno">149 </span>    <span class="c1"># Side effects:</span>
</span><span id="row-150"><span class="lineno">150 </span>    <span class="c1">#     Sets many global boolean flags</span>
</span><span id="row-151"><span class="lineno">151 </span>    <span class="c1">#</span>
</span><span id="row-152"><span class="lineno">152 </span>    <span class="c1"># Notes:</span>
</span><span id="row-153"><span class="lineno">153 </span>    <span class="c1">#     MOCK_DEBUG_X86_PATH can be used to mock /sys/kernel/debug/x86 directory</span>
</span><span id="row-154"><span class="lineno">154 </span>    <span class="c1">#     MOCK_CMDLINE_PATH can be used to mock /proc/cmdline file</span>
</span><span id="row-155"><span class="lineno">155 </span>    <span class="c1">#     MOCK_EUID can be used to mock EUID variable</span>
</span><span id="row-156"><span class="lineno">156 </span>
</span><span id="row-157"><span class="lineno">157 </span>    <span class="nb">local</span> <span class="nv">debug_x86</span><span class="o">=</span><span class="si">${</span><span class="nv">MOCK_DEBUG_X86_PATH</span><span class="k">:-</span><span class="p">/sys/kernel/debug/x86</span><span class="si">}</span>
</span><span id="row-158"><span class="lineno">158 </span>    <span class="nb">local</span> <span class="nv">cmdline_path</span><span class="o">=</span><span class="si">${</span><span class="nv">MOCK_CMDLINE_PATH</span><span class="k">:-</span><span class="p">/proc/cmdline</span><span class="si">}</span>
</span><span id="row-159"><span class="lineno">159 </span>    <span class="nb">local</span> <span class="nv">euid</span><span class="o">=</span><span class="si">${</span><span class="nv">MOCK_EUID</span><span class="k">:-</span><span class="nv">$EUID</span><span class="si">}</span>
</span><span id="row-160"><span class="lineno">160 </span>
</span><span id="row-161"><span class="lineno">161 </span>    <span class="c1"># Am I root?</span>
</span><span id="row-162"><span class="lineno">162 </span>    <span class="k">if</span> <span class="o">((</span> <span class="nv">euid</span> <span class="o">==</span> <span class="m">0</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-163"><span class="lineno">163 </span>        <span class="nv">root</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-164"><span class="lineno">164 </span>    <span class="k">fi</span>
</span><span id="row-165"><span class="lineno">165 </span>
</span><span id="row-166"><span class="lineno">166 </span>    <span class="c1"># Is debugfs mounted?</span>
</span><span id="row-167"><span class="lineno">167 </span>    <span class="k">if</span> mount <span class="p">|</span> grep --quiet debugfs<span class="p">;</span> <span class="k">then</span>
</span><span id="row-168"><span class="lineno">168 </span>        <span class="nv">mounted_debugfs</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-169"><span class="lineno">169 </span>    <span class="k">fi</span>
</span><span id="row-170"><span class="lineno">170 </span>
</span><span id="row-171"><span class="lineno">171 </span>    <span class="c1"># Will fallback detection be needed?</span>
</span><span id="row-172"><span class="lineno">172 </span>    <span class="k">if</span> <span class="o">((</span> ! mounted_debugfs <span class="o">||</span> ! root <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-173"><span class="lineno">173 </span>        <span class="nv">fallback_needed</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-174"><span class="lineno">174 </span>    <span class="k">fi</span>
</span><span id="row-175"><span class="lineno">175 </span>
</span><span id="row-176"><span class="lineno">176 </span>    <span class="c1"># Are all debug files accessible?</span>
</span><span id="row-177"><span class="lineno">177 </span>    <span class="k">if</span> <span class="o">[[</span> -r <span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/pti_enabled"</span> <span class="o">&amp;&amp;</span> -r <span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/ibpb_enabled"</span> <span class="o">&amp;&amp;</span> -r <span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/ibrs_enabled"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-178"><span class="lineno">178 </span>        <span class="nv">all_debug_files</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-179"><span class="lineno">179 </span>    <span class="k">fi</span>
</span><span id="row-180"><span class="lineno">180 </span>
</span><span id="row-181"><span class="lineno">181 </span>    <span class="c1"># Read features from debugfs</span>
</span><span id="row-182"><span class="lineno">182 </span>    <span class="k">if</span> <span class="o">((</span> all_debug_files <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-183"><span class="lineno">183 </span>        <span class="nv">new_kernel</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-184"><span class="lineno">184 </span>        <span class="nv">pti_debugfs</span><span class="o">=</span><span class="k">$(</span> &lt;<span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/pti_enabled"</span> <span class="k">)</span>
</span><span id="row-185"><span class="lineno">185 </span>        <span class="nv">ibpb_debugfs</span><span class="o">=</span><span class="k">$(</span> &lt;<span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/ibpb_enabled"</span> <span class="k">)</span>
</span><span id="row-186"><span class="lineno">186 </span>        <span class="nv">ibrs_debugfs</span><span class="o">=</span><span class="k">$(</span> &lt;<span class="s2">"</span><span class="si">${</span><span class="nv">debug_x86</span><span class="si">}</span><span class="s2">/ibrs_enabled"</span> <span class="k">)</span>
</span><span id="row-187"><span class="lineno">187 </span>    <span class="k">fi</span>
</span><span id="row-188"><span class="lineno">188 </span>
</span><span id="row-189"><span class="lineno">189 </span>    <span class="c1"># Read features from dmesg</span>
</span><span id="row-190"><span class="lineno">190 </span>    <span class="k">if</span> ! dmesg <span class="p">|</span> grep --quiet <span class="s1">'Linux.version'</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-191"><span class="lineno">191 </span>        <span class="nv">dmesg_wrapped</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-192"><span class="lineno">192 </span>    <span class="k">fi</span>
</span><span id="row-193"><span class="lineno">193 </span>
</span><span id="row-194"><span class="lineno">194 </span>    <span class="c1"># These will not appear if disabled from commandline</span>
</span><span id="row-195"><span class="lineno">195 </span>    <span class="k">if</span> dmesg <span class="p">|</span> grep --quiet -e <span class="s1">'x86/pti: Unmapping kernel while in userspace'</span> <span class="se">\</span>
</span><span id="row-196"><span class="lineno">196 </span>                            -e <span class="s1">'x86/pti: Kernel page table isolation enabled'</span> <span class="se">\</span>
</span><span id="row-197"><span class="lineno">197 </span>                            -e <span class="s1">'x86/pti: Xen PV detected, disabling'</span> <span class="se">\</span>
</span><span id="row-198"><span class="lineno">198 </span>                            -e <span class="s1">'x86/pti: Xen PV detected, disabling PTI protection'</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-199"><span class="lineno">199 </span>        <span class="nv">new_kernel</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-200"><span class="lineno">200 </span>        <span class="nv">pti_dmesg</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-201"><span class="lineno">201 </span>    <span class="k">fi</span>
</span><span id="row-202"><span class="lineno">202 </span>
</span><span id="row-203"><span class="lineno">203 </span>    <span class="c1"># These will appear if disabled from commandline</span>
</span><span id="row-204"><span class="lineno">204 </span>    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span> dmesg <span class="p">|</span> tac <span class="p">|</span> grep --max-count <span class="m">1</span> <span class="s1">'FEATURE SPEC_CTRL'</span> <span class="k">)</span>  <span class="c1"># Check last</span>
</span><span id="row-205"><span class="lineno">205 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-206"><span class="lineno">206 </span>        <span class="nv">new_kernel</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-207"><span class="lineno">207 </span>        <span class="k">if</span> ! grep --quiet <span class="s1">'Not Present'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-208"><span class="lineno">208 </span>            <span class="nv">ibrs_dmesg</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-209"><span class="lineno">209 </span>            <span class="nv">hw_support</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-210"><span class="lineno">210 </span>        <span class="k">else</span>
</span><span id="row-211"><span class="lineno">211 </span>            <span class="nv">not_ibrs_dmesg</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-212"><span class="lineno">212 </span>        <span class="k">fi</span>
</span><span id="row-213"><span class="lineno">213 </span>    <span class="k">fi</span>
</span><span id="row-214"><span class="lineno">214 </span>
</span><span id="row-215"><span class="lineno">215 </span>    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span> dmesg <span class="p">|</span> tac <span class="p">|</span> grep --max-count <span class="m">1</span> <span class="s1">'FEATURE IBPB_SUPPORT'</span> <span class="k">)</span>   <span class="c1"># Check last</span>
</span><span id="row-216"><span class="lineno">216 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-217"><span class="lineno">217 </span>        <span class="nv">new_kernel</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-218"><span class="lineno">218 </span>        <span class="k">if</span> ! grep --quiet <span class="s1">'Not Present'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-219"><span class="lineno">219 </span>            <span class="nv">ibpb_dmesg</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-220"><span class="lineno">220 </span>            <span class="nv">hw_support</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-221"><span class="lineno">221 </span>        <span class="k">else</span>
</span><span id="row-222"><span class="lineno">222 </span>            <span class="nv">not_ibpb_dmesg</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-223"><span class="lineno">223 </span>        <span class="k">fi</span>
</span><span id="row-224"><span class="lineno">224 </span>    <span class="k">fi</span>
</span><span id="row-225"><span class="lineno">225 </span>
</span><span id="row-226"><span class="lineno">226 </span>    <span class="c1"># Read commandline</span>
</span><span id="row-227"><span class="lineno">227 </span>    <span class="k">if</span> grep --quiet <span class="s1">'nopti'</span> <span class="s2">"</span><span class="nv">$cmdline_path</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-228"><span class="lineno">228 </span>        <span class="nv">nopti</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-229"><span class="lineno">229 </span>    <span class="k">fi</span>
</span><span id="row-230"><span class="lineno">230 </span>    <span class="k">if</span> grep --quiet <span class="s1">'noibrs'</span> <span class="s2">"</span><span class="nv">$cmdline_path</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-231"><span class="lineno">231 </span>        <span class="nv">noibrs</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-232"><span class="lineno">232 </span>    <span class="k">fi</span>
</span><span id="row-233"><span class="lineno">233 </span>    <span class="k">if</span> grep --quiet <span class="s1">'noibpb'</span> <span class="s2">"</span><span class="nv">$cmdline_path</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-234"><span class="lineno">234 </span>        <span class="nv">noibpb</span><span class="o">=</span><span class="m">1</span>
</span><span id="row-235"><span class="lineno">235 </span>    <span class="k">fi</span>
</span><span id="row-236"><span class="lineno">236 </span><span class="o">}</span>
</span><span id="row-237"><span class="lineno">237 </span>
</span><span id="row-238"><span class="lineno">238 </span>
</span><span id="row-239"><span class="lineno">239 </span>check_variants<span class="o">()</span> <span class="o">{</span>
</span><span id="row-240"><span class="lineno">240 </span>    <span class="c1"># Checks which variants are mitigated based on many global boolean flags.</span>
</span><span id="row-241"><span class="lineno">241 </span>    <span class="c1">#</span>
</span><span id="row-242"><span class="lineno">242 </span>    <span class="c1"># Side effects:</span>
</span><span id="row-243"><span class="lineno">243 </span>    <span class="c1">#     Sets global variables variant_1, variant_2, variant_3.</span>
</span><span id="row-244"><span class="lineno">244 </span>
</span><span id="row-245"><span class="lineno">245 </span>    <span class="k">if</span> <span class="o">((</span> new_kernel <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-246"><span class="lineno">246 </span>        <span class="nv">variant_1</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-247"><span class="lineno">247 </span>    <span class="k">fi</span>
</span><span id="row-248"><span class="lineno">248 </span>
</span><span id="row-249"><span class="lineno">249 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$vendor</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"Intel"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-250"><span class="lineno">250 </span>        <span class="k">if</span> <span class="o">((</span> ! fallback_needed <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-251"><span class="lineno">251 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">pti_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nv">ibrs_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nv">ibpb_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-252"><span class="lineno">252 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-253"><span class="lineno">253 </span>                <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-254"><span class="lineno">254 </span>            <span class="k">fi</span>
</span><span id="row-255"><span class="lineno">255 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">pti_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nv">ibrs_debugfs</span> <span class="o">==</span> <span class="m">2</span> <span class="o">&amp;&amp;</span> <span class="nv">ibpb_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-256"><span class="lineno">256 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-257"><span class="lineno">257 </span>                <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-258"><span class="lineno">258 </span>            <span class="k">fi</span>
</span><span id="row-259"><span class="lineno">259 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">pti_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nv">ibrs_debugfs</span> <span class="o">==</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nv">ibpb_debugfs</span> <span class="o">==</span> <span class="m">0</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-260"><span class="lineno">260 </span>                <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-261"><span class="lineno">261 </span>            <span class="k">fi</span>
</span><span id="row-262"><span class="lineno">262 </span>        <span class="k">else</span>
</span><span id="row-263"><span class="lineno">263 </span>            <span class="k">if</span> <span class="o">((</span> ibrs_dmesg <span class="o">&amp;&amp;</span> ibpb_dmesg <span class="o">&amp;&amp;</span> ! noibrs <span class="o">&amp;&amp;</span> ! noibpb <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-264"><span class="lineno">264 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-265"><span class="lineno">265 </span>            <span class="k">fi</span>
</span><span id="row-266"><span class="lineno">266 </span>            <span class="k">if</span> <span class="o">((</span> pti_dmesg <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-267"><span class="lineno">267 </span>                <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-268"><span class="lineno">268 </span>            <span class="k">fi</span>
</span><span id="row-269"><span class="lineno">269 </span>        <span class="k">fi</span>
</span><span id="row-270"><span class="lineno">270 </span>    <span class="k">fi</span>
</span><span id="row-271"><span class="lineno">271 </span>
</span><span id="row-272"><span class="lineno">272 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$vendor</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"AMD"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-273"><span class="lineno">273 </span>        <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"AMD is not vulnerable to this variant"</span>
</span><span id="row-274"><span class="lineno">274 </span>
</span><span id="row-275"><span class="lineno">275 </span>        <span class="k">if</span> <span class="o">((</span> ! fallback_needed <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-276"><span class="lineno">276 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">pti_debugfs</span> <span class="o">==</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nv">ibrs_debugfs</span> <span class="o">==</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nv">ibpb_debugfs</span> <span class="o">==</span> <span class="m">2</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-277"><span class="lineno">277 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-278"><span class="lineno">278 </span>            <span class="k">fi</span>
</span><span id="row-279"><span class="lineno">279 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">pti_debugfs</span> <span class="o">==</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nv">ibrs_debugfs</span> <span class="o">==</span> <span class="m">2</span> <span class="o">&amp;&amp;</span> <span class="nv">ibpb_debugfs</span> <span class="o">==</span> <span class="m">1</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-280"><span class="lineno">280 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-281"><span class="lineno">281 </span>            <span class="k">fi</span>
</span><span id="row-282"><span class="lineno">282 </span>        <span class="k">else</span>
</span><span id="row-283"><span class="lineno">283 </span>            <span class="k">if</span> <span class="o">((</span> ibpb_dmesg <span class="o">&amp;&amp;</span> ! noibpb <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-284"><span class="lineno">284 </span>                <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Mitigated"</span>
</span><span id="row-285"><span class="lineno">285 </span>            <span class="k">fi</span>
</span><span id="row-286"><span class="lineno">286 </span>        <span class="k">fi</span>
</span><span id="row-287"><span class="lineno">287 </span>    <span class="k">fi</span>
</span><span id="row-288"><span class="lineno">288 </span><span class="o">}</span>
</span><span id="row-289"><span class="lineno">289 </span>
</span><span id="row-290"><span class="lineno">290 </span>
</span><span id="row-291"><span class="lineno">291 </span><span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-292"><span class="lineno">292 </span>    basic_args <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</span><span id="row-293"><span class="lineno">293 </span>    basic_reqs <span class="s2">"Spectre / Meltdown"</span>
</span><span id="row-294"><span class="lineno">294 </span>    <span class="nv">running_kernel</span><span class="o">=</span><span class="k">$(</span> uname -r <span class="k">)</span>
</span><span id="row-295"><span class="lineno">295 </span>    check_supported_kernel <span class="s2">"</span><span class="nv">$running_kernel</span><span class="s2">"</span>
</span><span id="row-296"><span class="lineno">296 </span>
</span><span id="row-297"><span class="lineno">297 </span>    <span class="nv">rhel</span><span class="o">=</span><span class="k">$(</span> get_rhel <span class="s2">"</span><span class="nv">$running_kernel</span><span class="s2">"</span> <span class="k">)</span>
</span><span id="row-298"><span class="lineno">298 </span>    <span class="k">if</span> <span class="o">((</span> <span class="nv">rhel</span> <span class="o">==</span> <span class="m">5</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-299"><span class="lineno">299 </span>        <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s1">'/sbin'</span>:<span class="nv">$PATH</span>
</span><span id="row-300"><span class="lineno">300 </span>
</span><span id="row-301"><span class="lineno">301 </span>        <span class="nb">echo</span> <span class="s2">"RHEL5 is not supported by the script at the moment."</span>
</span><span id="row-302"><span class="lineno">302 </span>        <span class="nb">exit</span> <span class="m">1</span>
</span><span id="row-303"><span class="lineno">303 </span>    <span class="k">fi</span>
</span><span id="row-304"><span class="lineno">304 </span>
</span><span id="row-305"><span class="lineno">305 </span>    <span class="nv">vendor</span><span class="o">=</span><span class="k">$(</span> check_cpu_vendor <span class="k">)</span>
</span><span id="row-306"><span class="lineno">306 </span>    <span class="k">if</span> <span class="o">((</span> <span class="nv">$?</span> <span class="o">==</span> <span class="m">1</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-307"><span class="lineno">307 </span>        <span class="nb">echo</span> <span class="s2">"Your CPU vendor is not supported by the script at the moment."</span>
</span><span id="row-308"><span class="lineno">308 </span>        <span class="nb">echo</span> <span class="s2">"Only Intel and AMD are supported for now."</span>
</span><span id="row-309"><span class="lineno">309 </span>        <span class="nb">exit</span> <span class="m">1</span>
</span><span id="row-310"><span class="lineno">310 </span>    <span class="k">fi</span>
</span><span id="row-311"><span class="lineno">311 </span>
</span><span id="row-312"><span class="lineno">312 </span>    <span class="nv">root</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-313"><span class="lineno">313 </span>    <span class="nv">mounted_debugfs</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-314"><span class="lineno">314 </span>    <span class="nv">all_debug_files</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-315"><span class="lineno">315 </span>    <span class="nv">fallback_needed</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-316"><span class="lineno">316 </span>    <span class="nv">pti_debugfs</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-317"><span class="lineno">317 </span>    <span class="nv">ibrs_debugfs</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-318"><span class="lineno">318 </span>    <span class="nv">ibpb_debugfs</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-319"><span class="lineno">319 </span>    <span class="nv">dmesg_wrapped</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-320"><span class="lineno">320 </span>    <span class="nv">pti_dmesg</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-321"><span class="lineno">321 </span>    <span class="nv">ibrs_dmesg</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-322"><span class="lineno">322 </span>    <span class="nv">ibpb_dmesg</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-323"><span class="lineno">323 </span>    <span class="nv">not_ibrs_dmesg</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-324"><span class="lineno">324 </span>    <span class="nv">not_ibpb_dmesg</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-325"><span class="lineno">325 </span>    <span class="nv">new_kernel</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-326"><span class="lineno">326 </span>    <span class="nv">nopti</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-327"><span class="lineno">327 </span>    <span class="nv">noibrs</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-328"><span class="lineno">328 </span>    <span class="nv">noibpb</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-329"><span class="lineno">329 </span>    <span class="nv">hw_support</span><span class="o">=</span><span class="m">0</span>
</span><span id="row-330"><span class="lineno">330 </span>
</span><span id="row-331"><span class="lineno">331 </span>    <span class="nv">variant_1</span><span class="o">=</span><span class="s2">"Vulnerable"</span>
</span><span id="row-332"><span class="lineno">332 </span>    <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"Vulnerable"</span>
</span><span id="row-333"><span class="lineno">333 </span>    <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"Vulnerable"</span>
</span><span id="row-334"><span class="lineno">334 </span>
</span><span id="row-335"><span class="lineno">335 </span>    <span class="c1"># Tests</span>
</span><span id="row-336"><span class="lineno">336 </span>    gather_info
</span><span id="row-337"><span class="lineno">337 </span>    check_variants
</span><span id="row-338"><span class="lineno">338 </span>
</span><span id="row-339"><span class="lineno">339 </span>    <span class="c1"># Debug prints</span>
</span><span id="row-340"><span class="lineno">340 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$debug</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-341"><span class="lineno">341 </span>        <span class="nb">echo</span> <span class="s2">"running_kernel = *</span><span class="nv">$running_kernel</span><span class="s2">*"</span>
</span><span id="row-342"><span class="lineno">342 </span>        <span class="nb">echo</span> <span class="s2">"rhel = *</span><span class="nv">$rhel</span><span class="s2">*"</span>
</span><span id="row-343"><span class="lineno">343 </span>        <span class="nb">echo</span> <span class="s2">"vendor = *</span><span class="nv">$vendor</span><span class="s2">*"</span>
</span><span id="row-344"><span class="lineno">344 </span>        <span class="nb">echo</span> <span class="s2">"root = *</span><span class="nv">$root</span><span class="s2">*"</span>
</span><span id="row-345"><span class="lineno">345 </span>        <span class="nb">echo</span> <span class="s2">"mounted_debugfs = *</span><span class="nv">$mounted_debugfs</span><span class="s2">*"</span>
</span><span id="row-346"><span class="lineno">346 </span>        <span class="nb">echo</span> <span class="s2">"all_debug_files = *</span><span class="nv">$all_debug_files</span><span class="s2">*"</span>
</span><span id="row-347"><span class="lineno">347 </span>        <span class="nb">echo</span> <span class="s2">"fallback_needed = *</span><span class="nv">$fallback_needed</span><span class="s2">*"</span>
</span><span id="row-348"><span class="lineno">348 </span>        <span class="nb">echo</span> <span class="s2">"pti_debugfs = *</span><span class="nv">$pti_debugfs</span><span class="s2">*"</span>
</span><span id="row-349"><span class="lineno">349 </span>        <span class="nb">echo</span> <span class="s2">"ibrs_debugfs = *</span><span class="nv">$ibrs_debugfs</span><span class="s2">*"</span>
</span><span id="row-350"><span class="lineno">350 </span>        <span class="nb">echo</span> <span class="s2">"ibpb_debugfs = *</span><span class="nv">$ibpb_debugfs</span><span class="s2">*"</span>
</span><span id="row-351"><span class="lineno">351 </span>        <span class="nb">echo</span> <span class="s2">"dmesg_wrapped = *</span><span class="nv">$dmesg_wrapped</span><span class="s2">*"</span>
</span><span id="row-352"><span class="lineno">352 </span>        <span class="nb">echo</span> <span class="s2">"pti_dmesg = *</span><span class="nv">$pti_dmesg</span><span class="s2">*"</span>
</span><span id="row-353"><span class="lineno">353 </span>        <span class="nb">echo</span> <span class="s2">"ibrs_dmesg = *</span><span class="nv">$ibrs_dmesg</span><span class="s2">*"</span>
</span><span id="row-354"><span class="lineno">354 </span>        <span class="nb">echo</span> <span class="s2">"ibpb_dmesg = *</span><span class="nv">$ibpb_dmesg</span><span class="s2">*"</span>
</span><span id="row-355"><span class="lineno">355 </span>        <span class="nb">echo</span> <span class="s2">"not_ibrs_dmesg = *</span><span class="nv">$not_ibrs_dmesg</span><span class="s2">*"</span>
</span><span id="row-356"><span class="lineno">356 </span>        <span class="nb">echo</span> <span class="s2">"not_ibpb_dmesg = *</span><span class="nv">$not_ibpb_dmesg</span><span class="s2">*"</span>
</span><span id="row-357"><span class="lineno">357 </span>        <span class="nb">echo</span> <span class="s2">"new_kernel = *</span><span class="nv">$new_kernel</span><span class="s2">*"</span>
</span><span id="row-358"><span class="lineno">358 </span>        <span class="nb">echo</span> <span class="s2">"nopti = *</span><span class="nv">$nopti</span><span class="s2">*"</span>
</span><span id="row-359"><span class="lineno">359 </span>        <span class="nb">echo</span> <span class="s2">"noibrs = *</span><span class="nv">$noibrs</span><span class="s2">*"</span>
</span><span id="row-360"><span class="lineno">360 </span>        <span class="nb">echo</span> <span class="s2">"noibpb = *</span><span class="nv">$noibpb</span><span class="s2">*"</span>
</span><span id="row-361"><span class="lineno">361 </span>        <span class="nb">echo</span> <span class="s2">"hw_support = *</span><span class="nv">$hw_support</span><span class="s2">*"</span>
</span><span id="row-362"><span class="lineno">362 </span>        <span class="nb">echo</span> <span class="s2">"variant_1 = *</span><span class="nv">$variant_1</span><span class="s2">*"</span>
</span><span id="row-363"><span class="lineno">363 </span>        <span class="nb">echo</span> <span class="s2">"variant_2 = *</span><span class="nv">$variant_2</span><span class="s2">*"</span>
</span><span id="row-364"><span class="lineno">364 </span>        <span class="nb">echo</span> <span class="s2">"variant_3 = *</span><span class="nv">$variant_3</span><span class="s2">*"</span>
</span><span id="row-365"><span class="lineno">365 </span>        <span class="nb">echo</span>
</span><span id="row-366"><span class="lineno">366 </span>    <span class="k">fi</span>
</span><span id="row-367"><span class="lineno">367 </span>
</span><span id="row-368"><span class="lineno">368 </span>    <span class="c1"># Results</span>
</span><span id="row-369"><span class="lineno">369 </span>    <span class="k">if</span> <span class="o">((</span> new_kernel <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-370"><span class="lineno">370 </span>        <span class="nv">kernel_with_patches</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">OK</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-371"><span class="lineno">371 </span>        <span class="k">if</span> <span class="o">((</span> hw_support <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-372"><span class="lineno">372 </span>            <span class="nv">hw</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">YES</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-373"><span class="lineno">373 </span>        <span class="k">else</span>
</span><span id="row-374"><span class="lineno">374 </span>            <span class="nv">hw</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">NO</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-375"><span class="lineno">375 </span>        <span class="k">fi</span>
</span><span id="row-376"><span class="lineno">376 </span>    <span class="k">else</span>
</span><span id="row-377"><span class="lineno">377 </span>        <span class="nv">kernel_with_patches</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Not installed</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-378"><span class="lineno">378 </span>        <span class="nv">hw</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">Cannot detect without updated kernel</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-379"><span class="lineno">379 </span>    <span class="k">fi</span>
</span><span id="row-380"><span class="lineno">380 </span>
</span><span id="row-381"><span class="lineno">381 </span>    <span class="k">if</span> <span class="o">((</span> nopti <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-382"><span class="lineno">382 </span>        <span class="nv">pti</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Disabled on kernel commandline by 'nopti'</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-383"><span class="lineno">383 </span>    <span class="k">else</span>
</span><span id="row-384"><span class="lineno">384 </span>        <span class="nv">pti</span><span class="o">=</span><span class="s2">"Not disabled on kernel commandline"</span>
</span><span id="row-385"><span class="lineno">385 </span>    <span class="k">fi</span>
</span><span id="row-386"><span class="lineno">386 </span>
</span><span id="row-387"><span class="lineno">387 </span>    <span class="k">if</span> <span class="o">((</span> noibrs <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-388"><span class="lineno">388 </span>        <span class="nv">ibrs</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Disabled on kernel commandline by 'noibrs'</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-389"><span class="lineno">389 </span>    <span class="k">else</span>
</span><span id="row-390"><span class="lineno">390 </span>        <span class="nv">ibrs</span><span class="o">=</span><span class="s2">"Not disabled on kernel commandline"</span>
</span><span id="row-391"><span class="lineno">391 </span>    <span class="k">fi</span>
</span><span id="row-392"><span class="lineno">392 </span>
</span><span id="row-393"><span class="lineno">393 </span>    <span class="k">if</span> <span class="o">((</span> noibpb <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-394"><span class="lineno">394 </span>        <span class="nv">ibpb</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">Disabled on kernel commandline by 'noibpb'</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-395"><span class="lineno">395 </span>    <span class="k">else</span>
</span><span id="row-396"><span class="lineno">396 </span>        <span class="nv">ibpb</span><span class="o">=</span><span class="s2">"Not disabled on kernel commandline"</span>
</span><span id="row-397"><span class="lineno">397 </span>    <span class="k">fi</span>
</span><span id="row-398"><span class="lineno">398 </span>
</span><span id="row-399"><span class="lineno">399 </span>    <span class="o">((</span> <span class="nv">result</span> <span class="o">=</span> <span class="m">0</span> <span class="o">))</span>
</span><span id="row-400"><span class="lineno">400 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$variant_1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"Vulnerable"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-401"><span class="lineno">401 </span>        <span class="o">((</span> result <span class="p">|</span><span class="o">=</span> <span class="m">2</span> <span class="o">))</span>
</span><span id="row-402"><span class="lineno">402 </span>        <span class="nv">variant_1</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="nv">$variant_1</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-403"><span class="lineno">403 </span>    <span class="k">else</span>
</span><span id="row-404"><span class="lineno">404 </span>        <span class="nv">variant_1</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="nv">$variant_1</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-405"><span class="lineno">405 </span>    <span class="k">fi</span>
</span><span id="row-406"><span class="lineno">406 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$variant_2</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"Vulnerable"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-407"><span class="lineno">407 </span>        <span class="o">((</span> result <span class="p">|</span><span class="o">=</span> <span class="m">4</span> <span class="o">))</span>
</span><span id="row-408"><span class="lineno">408 </span>        <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="nv">$variant_2</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-409"><span class="lineno">409 </span>    <span class="k">else</span>
</span><span id="row-410"><span class="lineno">410 </span>        <span class="nv">variant_2</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="nv">$variant_2</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-411"><span class="lineno">411 </span>    <span class="k">fi</span>
</span><span id="row-412"><span class="lineno">412 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$variant_3</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"Vulnerable"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-413"><span class="lineno">413 </span>        <span class="o">((</span> result <span class="p">|</span><span class="o">=</span> <span class="m">8</span> <span class="o">))</span>
</span><span id="row-414"><span class="lineno">414 </span>        <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="nv">$variant_3</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-415"><span class="lineno">415 </span>    <span class="k">else</span>
</span><span id="row-416"><span class="lineno">416 </span>        <span class="nv">variant_3</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="nv">$variant_3</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-417"><span class="lineno">417 </span>    <span class="k">fi</span>
</span><span id="row-418"><span class="lineno">418 </span>
</span><span id="row-419"><span class="lineno">419 </span>    <span class="c1"># Output</span>
</span><span id="row-420"><span class="lineno">420 </span>    <span class="nb">echo</span> -e <span class="s2">"Detected CPU vendor: </span><span class="si">${</span><span class="nv">BOLD</span><span class="si">}</span><span class="nv">$vendor</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-421"><span class="lineno">421 </span>    <span class="nb">echo</span> -e <span class="s2">"Running kernel: </span><span class="si">${</span><span class="nv">BOLD</span><span class="si">}</span><span class="nv">$running_kernel</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-422"><span class="lineno">422 </span>    <span class="nb">echo</span>
</span><span id="row-423"><span class="lineno">423 </span>
</span><span id="row-424"><span class="lineno">424 </span>    <span class="c1"># Warnings</span>
</span><span id="row-425"><span class="lineno">425 </span>    <span class="k">if</span> <span class="o">((</span> fallback_needed <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-426"><span class="lineno">426 </span>        <span class="nb">echo</span> -e <span class="s2">"</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">Fallback non-runtime heuristics check is used (reading dmesg messages)</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">,"</span>
</span><span id="row-427"><span class="lineno">427 </span>        <span class="nb">echo</span> -e <span class="s2">"because debugfs could not be read."</span>
</span><span id="row-428"><span class="lineno">428 </span>        <span class="nb">echo</span>
</span><span id="row-429"><span class="lineno">429 </span>        <span class="nb">echo</span> <span class="s2">"To improve mitigation detection:"</span>
</span><span id="row-430"><span class="lineno">430 </span>        <span class="k">if</span> <span class="o">((</span> ! mounted_debugfs <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-431"><span class="lineno">431 </span>            <span class="nb">echo</span> <span class="s2">"* Mount debugfs by following command:"</span>
</span><span id="row-432"><span class="lineno">432 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">rhel</span> <span class="o">==</span> <span class="m">5</span> <span class="o">||</span> <span class="nv">rhel</span> <span class="o">==</span> <span class="m">6</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-433"><span class="lineno">433 </span>                <span class="nb">echo</span> <span class="s2">"    # mount -t debugfs nodev /sys/kernel/debug"</span>
</span><span id="row-434"><span class="lineno">434 </span>            <span class="k">fi</span>
</span><span id="row-435"><span class="lineno">435 </span>            <span class="k">if</span> <span class="o">((</span> <span class="nv">rhel</span> <span class="o">==</span> <span class="m">7</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-436"><span class="lineno">436 </span>                <span class="nb">echo</span> <span class="s2">"    # systemctl restart sys-kernel-debug.mount"</span>
</span><span id="row-437"><span class="lineno">437 </span>            <span class="k">fi</span>
</span><span id="row-438"><span class="lineno">438 </span>        <span class="k">fi</span>
</span><span id="row-439"><span class="lineno">439 </span>        <span class="k">if</span> <span class="o">((</span> ! root <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-440"><span class="lineno">440 </span>            <span class="nb">echo</span> <span class="s2">"* Run this script with elevated privileges (e.g. as root)"</span>
</span><span id="row-441"><span class="lineno">441 </span>        <span class="k">fi</span>
</span><span id="row-442"><span class="lineno">442 </span>        <span class="nb">echo</span>
</span><span id="row-443"><span class="lineno">443 </span>    <span class="k">fi</span>
</span><span id="row-444"><span class="lineno">444 </span>
</span><span id="row-445"><span class="lineno">445 </span>    <span class="k">if</span> <span class="o">((</span> dmesg_wrapped <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-446"><span class="lineno">446 </span>        <span class="nb">echo</span> -e <span class="s2">"</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">It seems that dmesg circular buffer already wrapped,</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-447"><span class="lineno">447 </span>        <span class="nb">echo</span> -e <span class="s2">"</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">the results may be inaccurate.</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-448"><span class="lineno">448 </span>        <span class="nb">echo</span>
</span><span id="row-449"><span class="lineno">449 </span>    <span class="k">fi</span>
</span><span id="row-450"><span class="lineno">450 </span>
</span><span id="row-451"><span class="lineno">451 </span>    <span class="c1"># Variants</span>
</span><span id="row-452"><span class="lineno">452 </span>    <span class="nb">echo</span> -e <span class="s2">"Variant #1 (Spectre): </span><span class="nv">$variant_1</span><span class="s2">"</span>
</span><span id="row-453"><span class="lineno">453 </span>    <span class="nb">echo</span> -e <span class="s2">"CVE-2017-5753 - speculative execution bounds-check bypass"</span>
</span><span id="row-454"><span class="lineno">454 </span>    <span class="nb">echo</span> -e <span class="s2">"   - Kernel with mitigation patches: </span><span class="nv">$kernel_with_patches</span><span class="s2">"</span>
</span><span id="row-455"><span class="lineno">455 </span>    <span class="nb">echo</span>
</span><span id="row-456"><span class="lineno">456 </span>
</span><span id="row-457"><span class="lineno">457 </span>    <span class="nb">echo</span> -e <span class="s2">"Variant #2 (Spectre): </span><span class="nv">$variant_2</span><span class="s2">"</span>
</span><span id="row-458"><span class="lineno">458 </span>    <span class="nb">echo</span> -e <span class="s2">"CVE-2017-5715 - speculative execution branch target injection"</span>
</span><span id="row-459"><span class="lineno">459 </span>    <span class="nb">echo</span> -e <span class="s2">"   - Kernel with mitigation patches: </span><span class="nv">$kernel_with_patches</span><span class="s2">"</span>
</span><span id="row-460"><span class="lineno">460 </span>    <span class="nb">echo</span> -e <span class="s2">"   - HW support / updated microcode: </span><span class="nv">$hw</span><span class="s2">"</span>
</span><span id="row-461"><span class="lineno">461 </span>    <span class="nb">echo</span> -e <span class="s2">"   - IBRS: </span><span class="nv">$ibrs</span><span class="s2">"</span>
</span><span id="row-462"><span class="lineno">462 </span>    <span class="nb">echo</span> -e <span class="s2">"   - IBPB: </span><span class="nv">$ibpb</span><span class="s2">"</span>
</span><span id="row-463"><span class="lineno">463 </span>    <span class="nb">echo</span>
</span><span id="row-464"><span class="lineno">464 </span>
</span><span id="row-465"><span class="lineno">465 </span>    <span class="nb">echo</span> -e <span class="s2">"Variant #3 (Meltdown): </span><span class="nv">$variant_3</span><span class="s2">"</span>
</span><span id="row-466"><span class="lineno">466 </span>    <span class="nb">echo</span> -e <span class="s2">"CVE-2017-5754 - speculative execution permission faults handling"</span>
</span><span id="row-467"><span class="lineno">467 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$vendor</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"AMD"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-468"><span class="lineno">468 </span>        <span class="nb">echo</span> -e <span class="s2">"   - AMD CPU: </span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">OK</span><span class="si">${</span><span class="nv">RESET</span><span class="si">}</span><span class="s2">"</span>
</span><span id="row-469"><span class="lineno">469 </span>    <span class="k">else</span>
</span><span id="row-470"><span class="lineno">470 </span>        <span class="nb">echo</span> -e <span class="s2">"   - Kernel with mitigation patches: </span><span class="nv">$kernel_with_patches</span><span class="s2">"</span>
</span><span id="row-471"><span class="lineno">471 </span>        <span class="nb">echo</span> -e <span class="s2">"   - PTI: </span><span class="nv">$pti</span><span class="s2">"</span>
</span><span id="row-472"><span class="lineno">472 </span>    <span class="k">fi</span>
</span><span id="row-473"><span class="lineno">473 </span>    <span class="nb">echo</span>
</span><span id="row-474"><span class="lineno">474 </span>
</span><span id="row-475"><span class="lineno">475 </span>    <span class="k">if</span> <span class="o">((</span> result !<span class="o">=</span> <span class="m">0</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-476"><span class="lineno">476 </span>        <span class="nb">echo</span> <span class="s2">"Red Hat recommends that you:"</span>
</span><span id="row-477"><span class="lineno">477 </span>        <span class="k">if</span> <span class="o">((</span> ! new_kernel <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-478"><span class="lineno">478 </span>            <span class="nb">echo</span> -e <span class="s2">"* Update your kernel and reboot the system."</span>
</span><span id="row-479"><span class="lineno">479 </span>        <span class="k">fi</span>
</span><span id="row-480"><span class="lineno">480 </span>        <span class="k">if</span> <span class="o">((</span> ! hw_support <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-481"><span class="lineno">481 </span>            <span class="nb">echo</span> -e <span class="s2">"* Ask your HW vendor for CPU microcode update."</span>
</span><span id="row-482"><span class="lineno">482 </span>        <span class="k">fi</span>
</span><span id="row-483"><span class="lineno">483 </span>        <span class="k">if</span> <span class="o">((</span> noibrs <span class="o">||</span> noibpb <span class="o">||</span> nopti <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span id="row-484"><span class="lineno">484 </span>            <span class="nb">echo</span> -e <span class="s2">"* Remove kernel commandline options as noted above."</span>
</span><span id="row-485"><span class="lineno">485 </span>        <span class="k">fi</span>
</span><span id="row-486"><span class="lineno">486 </span>        <span class="nb">echo</span>
</span><span id="row-487"><span class="lineno">487 </span>    <span class="k">fi</span>
</span><span id="row-488"><span class="lineno">488 </span>
</span><span id="row-489"><span class="lineno">489 </span>    <span class="nb">echo</span> -e <span class="s2">"For more information see:"</span>
</span><span id="row-490"><span class="lineno">490 </span>    <span class="nb">echo</span> -e <span class="s2">"https://access.redhat.com/security/vulnerabilities/speculativeexecution"</span>
</span><span id="row-491"><span class="lineno">491 </span>    <span class="nb">exit</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
</span><span id="row-492"><span class="lineno">492 </span><span class="k">fi</span>
</span></pre></div>

    </div>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/code-breakdown.html"> code breakdown</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/meltdown.html"> meltdown</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/code.html"> code</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/bash.html"> bash</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>