<!DOCTYPE html>
<html lang="en">
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://derez.github.io/theme/images/favicon.ico" type="image/x-icon">

    <title>Bit on Bits - Shellcode Encoders 2</title>
    <meta charset="utf-8">
    <link href="https://derez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Full Atom Feed"/>
    <link href="https://derez.github.io/feeds/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Atom Feed"/>
    <link href="https://derez.github.io/feeds/category/demo-page/index.xml" type="application/atom+xml" rel="alternate" title="Bit on Bits Categories Atom Feed"/>
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/materialize-icons/material-icons.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fontawesome/css/font-awesome.css">
    <link rel="stylesheet" href="https://derez.github.io/theme/vendor/fonts/source-code-pro.css">

    <link rel="stylesheet" href="https://derez.github.io/theme/css/current.min.css?da7c28ed">




    <meta name="tags" contents="code"/>
    <meta name="tags" contents="asm"/>
    <meta name="tags" contents="nasm"/>
    <meta name="tags" contents="shellcode"/>
    <meta name="tags" contents="encoder"/>

  </head>
  <body>
    <header>
      <ul id="blog-dropdown" class="dropdown-content">
        <li><a href="https://derez.github.io/categories.html"><i class="fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a></li>
        <li><a href="https://derez.github.io/archives.html"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Dates</a></li>
        <li><a href="https://derez.github.io/tags.html"><i class="fa fa-tags fa-lg"></i>&nbsp;&nbsp;Tags</a></li>
      </ul>

      <div class="navbar-fixed">
      <nav role="navigation" class="blue-grey darken-4 cyan-text text-lighten-2">
        <!-- slide-out -->
        <ul id="slide-out" class="side-nav black cyan-text">
          <li>
            <div class="userView">
              <a href="#!user"><img class="circle" src="https://derez.github.io/theme/images/headshot.png"></a>
              <a href="#!name"><span class="name">Danny 'derez' Walker</span></a>
              <span class="email">derez<i class="fa fa-at"></i>packetforge[dot]net</span>
            </div>
          </li>
          <li>
              <a href="https://derez.github.io/projects.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-cogs fa-lg"></i>&nbsp;&nbsp;Projects</a>
              <a href="https://derez.github.io/pages/about.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-user-circle fa-lg"></i>&nbsp;&nbsp;About</a>
          </li>
          <li>
              <b>Browse blog by</b>
              <a href="https://derez.github.io/categories.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-folder fa-lg"></i>&nbsp;&nbsp;Categories</a>
              <a href="https://derez.github.io/archives.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-calendar fa-lg "></i>&nbsp;&nbsp;Dates</a>
              <a href="https://derez.github.io/tags.html" class="menu-item cyan-text btn-flat waves-effect waves-orange">
                <i class="cyan-text fa fa-tag fa-lg "></i>&nbsp;&nbsp;Tags</a>
          </li>
        </ul>
        <!-- end of slide-out -->

        <div class="nav-wrapper container">
          <ul id="top-nav" class="top-nav">
            <li>
              <a href="#" data-activates="slide-out" class="button-collapse">
              <i class="orange-text text-darken-3 material-icons">menu</i>
              </a>
            </li>
            <li><a id="logo-container" href="https://derez.github.io/" class="brand-logo">
              <img class="circle" src="https://derez.github.io/theme/images/avatar.png">Bit on Bits</a></li>
            <ul class="right hide-on-med-and-down vertical-align-middle">
              <li><a class="menu-item waves-effect waves-orange btn-flat" href="https://derez.github.io/projects.html">
                <i class="fa fa-cogs"></i>&nbsp;&nbsp;Projects</a>
              </li>
              <li><a class="menu-item dropdown-button waves-effect waves-orange btn-flat" data-beloworigin="true" alignment="left" data-constrainwidth="false" href="#" data-activates="blog-dropdown">
                <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;Blog&nbsp;&nbsp;<i class="fa fa-caret-down"></i></a>
              </li>
              <li>
                <form action="https://derez.github.io/search.html">
                  <div class="input-field">
                    <input id="search" type="search" name="q" required autocomplete="off" placeholder="Search...">
                    <label for="search"><i class=" vertical-align-middle orange-text text-darken-3 fa fa-search fa-lg"></i></label>
                  </div>
                </form>
              </li>
            </ul>
          </ul>
        </div>
      </nav>
      </div>
      <div class="hide-on-small-only">
            <nav id="breadcrumbs">
    <div class="nav-wrapper container valign-wrapper">
      <div class="col s12 truncate">
        <a href="/" class="breadcrumb"><i class="fa fa-home"></i></a>
        <a href="/archives.html" class="breadcrumb">Archives</a>
        <a href="/drafts/shellcode-encoder-2.html" class="breadcrumb">Shellcode Encoders 2</a>
      </div>
    </div>
  </nav>
      </div>

        <div class="parallax-container ">
    <div class="parallax"><img src="/theme/images/wide.png"></div>
  </div>
    </header>

    <main>
      <div class="container">
        <div class="parallax-offset">


  <article itemscope itemtype="http://schema.org/Article" class="card-panel glow black cyan-text z-depth-5">
    <h1 itemprop="name"><a href="https://derez.github.io/drafts/shellcode-encoder-2.html" rel="bookmark" class="article-name card-title" 
      title="Permalink Shellcode Encoders 2">Shellcode Encoders&nbsp;2</a></h1>
    <div class="divider"></div>

    <footer class="post-info">
      <span class="published" title="2019-12-09T00:00:00-05:00">
        <i class="vertical-align-middle cyan-text fa fa-calendar fa-lg"></i>&nbsp;&nbsp;Date: 
        <time datetime="2019-12-09" itemprop="dateCreated"> 09 Dec 2019</time>
      </span>
      <br/>
      <address class="vcard author">
        <a class="cyan-text" href="https://derez.github.io/pages/about.html"><i class="cyan-text vertical-align-middle fa fa-user-circle fa-lg"></i>&nbsp;
        Danny Walker</a>
      </address>
    </footer>

    <div class="flow-text section no-padding" itemprop="text">
      <p>Shellcode encoders are used to defeat basic pattern matching or remove bad bytes from a payload.</p>
<p>The following encoder rotates bytes. I decided to rotate 3 bits left when encoding, meaning the decoder needs to rotate right 3 bits. Here is the decoder logic:</p>
<div class="highlight"><pre><span></span><span id="row-1"><span class="lineno"> 1 </span><span class="nl">_start:</span>
</span><span id="row-2"><span class="lineno"> 2 </span>    <span class="nf">jmp</span> <span class="no">encoded</span>
</span><span id="row-3"><span class="lineno"> 3 </span>
</span><span id="row-4"><span class="lineno"> 4 </span><span class="nl">getaddr:</span>
</span><span id="row-5"><span class="lineno"> 5 </span>    <span class="nf">pop</span> <span class="no">rbx</span>         <span class="c">; *rbx stores data</span>
</span><span id="row-6"><span class="lineno"> 6 </span>
</span><span id="row-7"><span class="lineno"> 7 </span>    <span class="nf">xor</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span><span id="row-8"><span class="lineno"> 8 </span>    <span class="nf">add</span> <span class="no">cl</span><span class="p">,</span> <span class="mi">0xff</span>    <span class="c">; replace with shellcode size</span>
</span><span id="row-9"><span class="lineno"> 9 </span>
</span><span id="row-10"><span class="lineno">10 </span><span class="nl">decode:</span>
</span><span id="row-11"><span class="lineno">11 </span>    <span class="nf">ror</span> <span class="no">byte</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="no">rcx</span><span class="p">],</span> <span class="mi">0x3</span>
</span><span id="row-12"><span class="lineno">12 </span>    <span class="nf">loop</span> <span class="no">decode</span>
</span><span id="row-13"><span class="lineno">13 </span>
</span><span id="row-14"><span class="lineno">14 </span>    <span class="nf">jmp</span> <span class="no">rbx</span>
</span><span id="row-15"><span class="lineno">15 </span>
</span><span id="row-16"><span class="lineno">16 </span><span class="nl">encoded:</span>
</span><span id="row-17"><span class="lineno">17 </span>    <span class="nf">call</span> <span class="no">getaddr</span>
</span><span id="row-18"><span class="lineno">18 </span>
</span><span id="row-19"><span class="lineno">19 </span>    <span class="c">; db 0x.... encoded bytes go here</span>
</span></pre></div>
<p>This resulted in the following 21 byte stub:</p>
<div class="highlight"><pre><span></span><span id="row-1"><span class="lineno">1 </span><span class="go">\xeb\x0e\x5b\x31\xc9\x80\xc1\x20\xc0\x0c\x0b\x03\xe2\xfa\xff\xe3\xe8\xed\xff\xff\xff</span>
</span></pre></div>
<div class="section" id="x64-bit-rotate-encoder">
<h2>x64 Bit-Rotate Encoder</h2>
<p>Here is a python script that basically just rotates all the bits left by 3, and then prepends the decoder stub (changing the length in the cl register appropriately).</p>
<div class="highlight"><pre><span></span><span id="row-1"><span class="lineno"> 1 </span><span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
</span><span id="row-2"><span class="lineno"> 2 </span>    <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="n">count</span> <span class="o">|</span> <span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">count</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
</span><span id="row-3"><span class="lineno"> 3 </span>
</span><span id="row-4"><span class="lineno"> 4 </span><span class="k">def</span> <span class="nf">hex_string</span><span class="p">(</span><span class="n">byte</span><span class="p">):</span>
</span><span id="row-5"><span class="lineno"> 5 </span>    <span class="k">return</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">byte</span><span class="p">)[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]</span>
</span><span id="row-6"><span class="lineno"> 6 </span>
</span><span id="row-7"><span class="lineno"> 7 </span><span class="k">def</span> <span class="nf">rot_encode_vector</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
</span><span id="row-8"><span class="lineno"> 8 </span>    <span class="n">encoded</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="row-9"><span class="lineno"> 9 </span>    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">:</span>
</span><span id="row-10"><span class="lineno">10 </span>        <span class="n">encoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rol</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="row-11"><span class="lineno">11 </span>
</span><span id="row-12"><span class="lineno">12 </span>    <span class="k">return</span> <span class="n">encoded</span>
</span><span id="row-13"><span class="lineno">13 </span>
</span><span id="row-14"><span class="lineno">14 </span><span class="k">def</span> <span class="nf">add_decoder_stub</span><span class="p">(</span><span class="n">encoded</span><span class="p">):</span>
</span><span id="row-15"><span class="lineno">15 </span>    <span class="n">decoder</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">xeb</span><span class="se">\\</span><span class="s2">x0e</span><span class="se">\\</span><span class="s2">x5b</span><span class="se">\\</span><span class="s2">x31</span><span class="se">\\</span><span class="s2">xc9</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">xc1</span><span class="se">\\</span><span class="s2">x04"</span>
</span><span id="row-16"><span class="lineno">16 </span>    <span class="n">decoder</span> <span class="o">+=</span> <span class="n">hex_string</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">))</span>
</span><span id="row-17"><span class="lineno">17 </span>    <span class="n">decoder</span> <span class="o">+=</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">xc0</span><span class="se">\\</span><span class="s2">x0c</span><span class="se">\\</span><span class="s2">x0b</span><span class="se">\\</span><span class="s2">x03</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">xfa</span><span class="se">\\</span><span class="s2">xff</span><span class="se">\\</span><span class="s2">xe3"</span>
</span><span id="row-18"><span class="lineno">18 </span>    <span class="n">decoder</span> <span class="o">+=</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">xe8</span><span class="se">\\</span><span class="s2">xed</span><span class="se">\\</span><span class="s2">xff</span><span class="se">\\</span><span class="s2">xff</span><span class="se">\\</span><span class="s2">xff"</span>
</span><span id="row-19"><span class="lineno">19 </span>
</span><span id="row-20"><span class="lineno">20 </span>    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">encoded</span><span class="p">:</span>
</span><span id="row-21"><span class="lineno">21 </span>        <span class="n">decoder</span> <span class="o">+=</span> <span class="n">hex_string</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>
</span><span id="row-22"><span class="lineno">22 </span>
</span><span id="row-23"><span class="lineno">23 </span>    <span class="k">return</span> <span class="n">decoder</span>
</span><span id="row-24"><span class="lineno">24 </span>
</span><span id="row-25"><span class="lineno">25 </span><span class="k">def</span> <span class="nf">rot_encode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
</span><span id="row-26"><span class="lineno">26 </span>    <span class="n">shellcode_vector</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">x'</span><span class="p">)[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]</span>
</span><span id="row-27"><span class="lineno">27 </span>    <span class="n">shellcode_vector</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">shellcode_vector</span><span class="p">]</span>
</span><span id="row-28"><span class="lineno">28 </span>
</span><span id="row-29"><span class="lineno">29 </span>    <span class="n">encoded_vector</span> <span class="o">=</span> <span class="n">rot_encode_vector</span><span class="p">(</span><span class="n">shellcode_vector</span><span class="p">)</span>
</span><span id="row-30"><span class="lineno">30 </span>    <span class="n">complete</span> <span class="o">=</span> <span class="n">add_decoder_stub</span><span class="p">(</span><span class="n">encoded_vector</span><span class="p">)</span>
</span><span id="row-31"><span class="lineno">31 </span>
</span><span id="row-32"><span class="lineno">32 </span>    <span class="k">return</span> <span class="n">complete</span><span class="p">,</span> <span class="n">encoded_vector</span><span class="p">,</span> <span class="n">shellcode_vector</span>
</span><span id="row-33"><span class="lineno">33 </span>
</span><span id="row-34"><span class="lineno">34 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
</span><span id="row-35"><span class="lineno">35 </span>    <span class="kn">import</span> <span class="nn">argparse</span>
</span><span id="row-36"><span class="lineno">36 </span>    <span class="n">args</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'Bit-Rotate Encoder'</span><span class="p">)</span>
</span><span id="row-37"><span class="lineno">37 </span>    <span class="n">args</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'shellcode'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'shellcode to encode'</span><span class="p">)</span>
</span><span id="row-38"><span class="lineno">38 </span>
</span><span id="row-39"><span class="lineno">39 </span>    <span class="n">argv</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="row-40"><span class="lineno">40 </span>
</span><span id="row-41"><span class="lineno">41 </span>    <span class="n">out</span><span class="p">,</span> <span class="n">encv</span><span class="p">,</span> <span class="n">scv</span> <span class="o">=</span> <span class="n">rot_encode</span><span class="p">(</span><span class="n">argv</span><span class="o">.</span><span class="n">shellcode</span><span class="p">)</span>
</span><span id="row-42"><span class="lineno">42 </span>
</span><span id="row-43"><span class="lineno">43 </span>    <span class="k">print</span> <span class="s1">'Original length: </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scv</span><span class="p">))</span>
</span><span id="row-44"><span class="lineno">44 </span>    <span class="k">print</span> <span class="n">argv</span><span class="o">.</span><span class="n">shellcode</span>
</span><span id="row-45"><span class="lineno">45 </span>    <span class="k">print</span>
</span><span id="row-46"><span class="lineno">46 </span>    <span class="k">print</span> <span class="s1">'Encoded length: </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="row-47"><span class="lineno">47 </span>    <span class="k">print</span> <span class="n">out</span>
</span><span id="row-48"><span class="lineno">48 </span>    <span class="k">print</span>
</span><span id="row-49"><span class="lineno">49 </span>    <span class="k">print</span> <span class="s1">'db '</span> <span class="o">+</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="n">encv</span><span class="p">))</span>
</span></pre></div>
</div>

    </div>
    <div class="divider"></div>
    <div class="article-details card-lower-corners">
      <div class="row">
        <div class="col l4 m4 s12">
          <div class="chip"><i class="black-text fa fa-folder fa-lg vertical-align-middle"></i>
            <a href="https://derez.github.io/category/demo-page.html"> demo page</a>
          </div>
        </div>
        <div class="col l8 m8 s12">
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/code.html"> code</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/asm.html"> asm</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/nasm.html"> nasm</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/shellcode.html"> shellcode</a>
          </div>
          <div class="chip"><i class="fa fa-tag fa-lg vertical-align-middle black-text"></i>
            <a href="https://derez.github.io/tag/encoder.html"> encoder</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s12">
          <span id="generated">Static site generated by <a href="https://getpelican.com">Pelican</a> in 
          <a href="https://www.python.org">Python</a> using <a href="https://jinja.pocoo.org">Jinja2.</a></span>

          <span id="copyright">&copy; Copyright 2018
            &nbsp;Danny Walker
          </span>
        </div>
      </div>
    </div>

  </article>
        </div>
      </div>
    </main>

    <script src="https://derez.github.io/theme/vendor/jquery/jquery.min.js"></script>
    <script src="https://derez.github.io/theme/vendor/materialize/js/materialize.min.js"></script>

      <script src="https://derez.github.io/theme/js/current.js?ccf8b503"></script>
  </body>
</html>